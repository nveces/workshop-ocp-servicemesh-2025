= Lab 3 - Service Mesh Communication Flows
:author: Ernesto Gonzalez / Asier Cidon
:email: ergonzal@redhat.com / acidonpe@redhat.com
:imagesdir: ./images
:toc: left
:toc-title: Service Mesh Communication Flows
:numbered:

[#memberrol]
== Added a new project to Red Hat Service Mesh Control Plane

The ServiceMeshMemberRoll lists the projects belonging to the control plane. Only projects listed in the ServiceMeshMemberRoll are affected by the control plane.

In order to add this new project to the Service Mesh and make the traffic between each microservice possible, it is required to create a new _ServiceMeshMember_ object.

Please, create the previous object through the respective Openshift template executing the following command: 

:file: 03-jump-app-flows/04-jump-app-ns-smr.yaml
:namespace: $USER_NAMESPACE

include::partials/oc_process_apply.adoc[]

._ServiceMeshMember_ Created
image:jump-app-ns-smr.png[]

Additionally, you are able to check this new object through the Openshift Console:

._ServiceMeshMember_ Created Console- 1
image:jump-app-ns-smr-con1.png[]
._ServiceMeshMember_ Created Console - 2
image:jump-app-ns-smr-con2.png[]
._ServiceMeshMember_ Created Console - 3
image:jump-app-ns-smr-con3.png[]

[#create]
== Create Red Hat Service Mesh Traffic Flow objects

In order to make an application available through Service Mesh, it is required to create a set of Service Mesh objects related to the traffic flow:

- Gateways - Describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections (Please, visit this link https://istio.io/v1.16/docs/concepts/traffic-management/#gateways[Gateways] for more information about _gateways_)
- Virtual Services - Defines a set of traffic routing rules to apply when a host is addressed (Please, visit this link https://istio.io/v1.16/docs/concepts/traffic-management/#virtual-services[Virtual Services] for more information about _virtual services_)
- Destination Rules - Defines policies that apply to traffic intended for a service after routing has occurred (Please, visit this link https://istio.io/v1.16/docs/concepts/traffic-management/#destination-rules[Destination Rules] for more information about _destination rules_)

In this step, you have to be able to deploy these _Jump App_ Service Mesh objects in order to introduce this application in the Service Mesh and publish it to external clients.

[#gw]
=== Gateways

First of all, it is required to create a Gateway for external access. In the _Jump App_ architecture, you have a couple of services which have to be exposed to external clients in order to present the Frontend and Backend services.

Please, return to git repository and create *gateways* through the respective Openshift template executing the following command: 

:file: 03-jump-app-flows/00-jump-app-gws.yaml
:namespace: $USER_NAMESPACE

include::partials/oc_process_apply.adoc[]

.Gateways Created
image:jump-app-gws-ok.png[]

[#vsvc]
=== Virtual Services

Once gateways are created and the application is reachable, it is time to create the traffic rules inside your namespace in order to route this traffic to the specific endpoint.

Please, create new *virtual services* through the respective Openshift template executing the following command: 

:file: 03-jump-app-flows/01-jump-app-vss.yaml
:namespace: $USER_NAMESPACE

include::partials/oc_process_apply.adoc[]

.Virtual Services Created
image:jump-app-vss-ok.png[]

[#dr]
=== Destination Rules

Once previous objects are created, it is required  to define the policies which will be applied to traffic intended for a service after routing has occurred.

Please, create new *destination rules* through the respective Openshift template executing the following command: 

:file: 03-jump-app-flows/02-jump-app-drs.yaml
:namespace: $USER_NAMESPACE

include::partials/oc_process_apply.adoc[]

.Destination Rules Created
image:jump-app-drs-ok.png[]

[#services]
=== K8s Services

Once you have created gateways, virtual services and destination rules, it is time to include a specific annotation in your app deployments in order to allow Service Mesh control and run the respective envoy sidecar automatically.

Please, create new *k8s services* through the respective Openshift template executing the following command: 

:file: 03-jump-app-flows/03-jump-app-services.yaml
:namespace: $USER_NAMESPACE

include::partials/oc_process_apply.adoc[]

.k8s Services Created
image:jump-app-svcs-ok.png[]

[#finalsteps]
== Final Steps

[#annotation]
=== Add _Istio Sidecar_ annotation in _Jump App_ deployments  

Once traffic flow objects are created and your namespace is included as a member in the Service Mesh Control Plane, it is time to include a specific annotation in your app deployments in order to allow Service Mesh control and run the respective envoy sidecar automatically.

Please, edit each _Jump App Microservice_ deployment executing the commands added below:

[.console-input]
[source,input,subs="+macros,+attributes"]
----
oc patch deployment front-javascript-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n $USER_NAMESPACE
----

.Front Patched
image:jump-app-front-depl-patch.png[]

[.console-input]
[source,input,subs="+macros,+attributes"]
----
oc patch deployment back-springboot-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n $USER_NAMESPACE
----

.Back Springboot Patched
image:jump-app-back-spb-depl-patch.png[]

[.console-input]
[source,input,subs="+macros,+attributes"]
----
oc patch deployment back-python-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n $USER_NAMESPACE
----

.Back Python Patched
image:jump-app-back-py-depl-patch.png[]

[.console-input]
[source,input,subs="+macros,+attributes"]
----
oc patch deployment back-golang-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n $USER_NAMESPACE
----

.Back Golang Patched
image:jump-app-back-go-depl-patch.png[]

Before continuing with the following steps, please test Jump App _pods_ status, in order to be sure that 2 replicas are running for each microservice:

include::partials/check_jumpapp_mesh_pod.adoc[]

[#routes]
=== Configure Routes

An OpenShift Container Platform *route* exposes a service at a host name, such as www.example.com, so that external clients can reach it by name. When you manage routes outside Service Mesh, it is required to create these objects in each namespace.

Once you have a project integrated in Service Mesh, routes should be created in istio-system, or wherever the control plane is installed, to make this external service available through the Istio Ingress Gateway. For this reason, it is required to follow the next steps:

==== Delete all current routes in <user_namespace>

[.console-input]
[source,input,subs="+macros,+attributes"]
----
oc get routes -n $USER_NAMESPACE | grep -v NAME | awk '{print "oc delete route " $1 " -n $USER_NAMESPACE"}' | sh
----

.Jump App Routes Deleted
image:jump-app-route-del.png[]

==== Create a new routes in istio-system

Once "regular" routes are deleted, it is required to create the new ones.

Please, create new *routes* in **istio-system** namespace through the respective Openshift template executing the following command: 

:file: 03-jump-app-flows/05-jump-app-routes.yaml
:namespace: istio-system

include::partials/oc_process_create.adoc[]

.Mesh Routes Created
image:jump-app-routes-mesh-ok.png[]

[#03-test]
== Confirm _Jump App_ is running again

Once _Jump App_ objects have been created in Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:

NOTE: Look at the number of containers in each microservice, it must contains 2 container per each pod (*READY 2/2*). 

:jumps: 10000
:seconds: 1

include::partials/check_jumpapp_mesh.adoc[]


[#03-kiali]
== Visit Kiali

Jump App is generating traffic flow thanks to the frontend where it was given an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit the Kiali console *<kiali_url>* (_E.g. https://kiali-istio-system.apps.labs.sandbox1562.opentlc.com_):

.Kiali Console
image:jump-app-kiali.png[]