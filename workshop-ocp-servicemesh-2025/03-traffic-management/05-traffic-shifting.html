<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 3 - Traffic Shifting and Weight Balancing :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/03-traffic-management/05-traffic-shifting.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-deploy.html">2. Deploy Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#package">Build Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#deploy">Deploy Dervice</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-introduction/index.html">3. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html">4. Envoy istio Control plane - Labs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">5. Traffic management - Labs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../04-troubleshooting/index.html">6. Troubleshooting - Labs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../05-security/index.html">7. Security - Labs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../06-extensibility/index.html">8. Extensibility - Labs</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">WorkShop - Service Mesh on OCP 2025</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">WorkShop - Service Mesh on OCP 2025</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="05-traffic-shifting.html">Lab 3 - Traffic Shifting and Weight Balancing</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab 3 - Traffic Shifting and Weight Balancing</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab you will learn how to gradually migrate traffic from one version of a service to another.</p>
</div>
<div class="paragraph">
<p>For example, you might migrate traffic from an older version to a new version. In this example you will use <em>reviews:v1</em> service as the old version and <em>reviews:v2</em> service as the new version.</p>
</div>
<div class="paragraph">
<p>First you will deploy Bookinfo and then you will configure a sequence of rules that send 90% of traffic to <em>reviews:v1</em> and 10% to <em>reviews:v2</em>. Then, you will continue the migration by sending 50% of traffic to each service and, finally, complete the migration sending 100% of the traffic to <em>reviews:v2</em>.</p>
</div>
<div class="paragraph">
<p>In this lab you will use 2 versions of the same service but you could create more complex routing rules weigth-balancing between many different versions of the same service or even different services.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/deploy_bookinfo.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_route_10_of_the_traffic_to_a_new_service"><a class="anchor" href="#_route_10_of_the_traffic_to_a_new_service"></a>Route 10% of the traffic to a new service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first modification to the <em>reviews</em> {vs} to add a 90/10 routing rule looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 90 <i class="conum" data-value="1"></i><b>(1)</b>
    - destination:
        host: reviews
        subset: v2
      weight: 10 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>90% traffic to <em>reviews:v1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>10% traffic to <em>reviews:v2</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the sum of weights across destinations should be == 100. If there is only one destination in a rule, the weight value is assumed to be 100.</p>
</div>
<div class="paragraph">
<p>You can apply it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab3/vs-reviews-shifting-90-10.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/kiali_traffic_loop.adoc[]</p>
</div>
<div class="paragraph">
<p>Make sure you select <em>Request Percentage</em> in the <em>Show Edge Labels</em> display options in Kiali:</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="kiali_percentage.png" alt="kiali percentage">
</div>
<div class="title">Figure 1. Kiali Request Percentage</div>
</div>
<div class="paragraph">
<p>Check the results:</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="kiali-shifting-90-10.png" alt="kiali shifting 90 10">
</div>
<div class="title">Figure 2. Kiali traffic shifting 90/10</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_route_half_the_traffic_to_each_service"><a class="anchor" href="#_route_half_the_traffic_to_each_service"></a>Route half the traffic to each service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>reviews</em> {vs} to add a 50/50 routing rule will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 50 <i class="conum" data-value="1"></i><b>(1)</b>
    - destination:
        host: reviews
        subset: v2
      weight: 50 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>50% traffic to <em>reviews:v1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>50% traffic to <em>reviews:v2</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can apply it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab3/vs-reviews-shifting-50-50.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/kiali_traffic_loop.adoc[]</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="kiali-shifting-50-50.png" alt="kiali shifting 50 50">
</div>
<div class="title">Figure 3. Kiali traffic shifting 50/50</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_route_all_the_traffic_to_the_new_service"><a class="anchor" href="#_route_all_the_traffic_to_the_new_service"></a>Route all the traffic to the new service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>reviews</em> {vs} to add a 100% routing rule to the new service will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 0 <i class="conum" data-value="1"></i><b>(1)</b>
    - destination:
        host: reviews
        subset: v2
      weight: 100 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>0% traffic to <em>reviews:v1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>100% traffic to <em>reviews:v2</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that we could have omitted the <em>reviews:v1</em> <em>destination</em> altogether as it is not receiving any traffic at all.</p>
</div>
<div class="paragraph">
<p>You can apply it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab3/vs-reviews-shifting-0-100.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/kiali_traffic_loop.adoc[]</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="kiali-shifting-0-100.png" alt="kiali shifting 0 100">
</div>
<div class="title">Figure 4. Kiali traffic shifting 0/100</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/remove_bookinfo.adoc[]</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
