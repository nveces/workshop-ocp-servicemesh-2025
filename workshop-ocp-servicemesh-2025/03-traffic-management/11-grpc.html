<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 9 - gRPC Routing :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/03-traffic-management/11-grpc.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-deploy.html">2. Deploy Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#package">Build Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#deploy">Deploy Dervice</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#introduction/index.adoc">3. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#introduction/index.adoc#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#introduction/index.adoc#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">WorkShop - Service Mesh on OCP 2025</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">WorkShop - Service Mesh on OCP 2025</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="11-grpc.html">Lab 9 - gRPC Routing</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/03-traffic-management/11-grpc.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab 9 - gRPC Routing</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many new gRPC users are surprised to find that Kubernetes&#8217;s default load balancing often doesn&#8217;t work out of the box with gRPC.</p>
</div>
<div class="paragraph">
<p>gRPC is an increasingly common choice for application developers. Compared to alternative protocols such as JSON-over-HTTP, gRPC can provide some significant benefits, including dramatically lower (de)serialization costs, automatic type checking, formalized APIs, and less TCP management overhead.</p>
</div>
<div class="paragraph">
<p>However, gRPC also breaks the standard connection-level load balancing, including what&#8217;s provided by Kubernetes. This is because gRPC is built on HTTP/2, and HTTP/2 is designed to have a single long-lived TCP connection, across which all requests are multiplexedâ€”meaning multiple requests can be active on the same connection at any point in time.</p>
</div>
<div class="paragraph">
<p>Once the connection is established, there&#8217;s no more balancing to be done. All requests will get pinned to a single destination pod.</p>
</div>
<div class="paragraph">
<p>The reason why this problem doesn&#8217;t occur in HTTP/1.1, which also has the concept of long-lived connections, is because HTTP/1.1 has several features that naturally result in cycling of TCP connections.</p>
</div>
<div class="paragraph">
<p>Since you can&#8217;t balance at the connection level, in order to do gRPC load balancing, we need to shift from connection balancing to request balancing. In other words, we need to open an HTTP/2 connection to each destination, and balance requests across these connections. Envoy, included in Istio, knows exactly how to achieve this.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_grpc_demo_without_istio"><a class="anchor" href="#_grpc_demo_without_istio"></a>gRPC demo without Istio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab you are going to deploy a gRPC demo scenario composed in four micro-services.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You are going to use a template to deploy the gRPC demo scenario so you are not required to understand the inner workings of the micro-services. If you are still interested, you have more information about this scenario in <a href="https://github.com/drhelius/grpc-demo">this repo</a>.
</td>
</tr>
</table>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_kiali.png" alt="grpc kiali">
</div>
<div class="title">Figure 1. gRPC demo in Kiali</div>
</div>
<div class="paragraph">
<p>First, deploy the gRPC services without Istio to understand the problem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export OCP_GRPCDEMO_HOST="${OCP_USER}.grpc.${OCP_DOMAIN}"

oc process -f lab9/grpc-demo.yaml \
    -p ACCOUNT_ROUTE="${OCP_GRPCDEMO_HOST}" -n ${OCP_NAMESPACE} \
    | oc apply -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a few seconds and make sure all services are ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_ready.png" alt="grpc ready">
</div>
<div class="title">Figure 2. gRPC demo services ready</div>
</div>
<div class="paragraph">
<p>Scale <em>user</em> service to 2 replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc scale --replicas=2 deployment/user-v1.0.0 -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until all replicas are ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_ready_replicas.png" alt="grpc ready replicas">
</div>
<div class="title">Figure 3. user service with two replicas</div>
</div>
<div class="paragraph">
<p>Now, simulate some traffic with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">while true; do curl -ksv -o /dev/null "https://${OCP_GRPCDEMO_HOST}/v1/account/01234" ; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the {ocp} web console, check the logs in both <em>user</em> pods. You can see that only one replica is receiving traffic.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_log1.png" alt="grpc log1">
</div>
<div class="title">Figure 4. user service logs (replica 1)</div>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_log2.png" alt="grpc log2">
</div>
<div class="title">Figure 5. user service logs (replica 2)</div>
</div>
<div class="paragraph">
<p>Now that you have checked there is no actual load balancing between <em>user</em> replicas, remove everything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo.yaml \
    -p ACCOUNT_ROUTE="${OCP_GRPCDEMO_HOST}" -n ${OCP_NAMESPACE} \
    | oc delete -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_grpc_demo_with_istio"><a class="anchor" href="#_grpc_demo_with_istio"></a>gRPC demo with Istio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You are going to test the same scenario but now using Istio. First, deploy the gRPC services and the ingress <em>Route</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo-istio.yaml \
    -p ACCOUNT_ROUTE="${OCP_GRPCDEMO_HOST}" -n ${OCP_NAMESPACE} \
    | oc apply -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo-route-istio.yaml \
    -p GRPC_ROUTE_NAME="${OCP_USER}-grpc" -p GRPC_ROUTE="${OCP_GRPCDEMO_HOST}" \
    -n ${OCP_NAMESPACE} \
    | oc apply -n istio-system -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a few seconds and make sure all services are ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_ready_istio.png" alt="grpc ready istio">
</div>
<div class="title">Figure 6. gRPC demo services ready</div>
</div>
<div class="paragraph">
<p>Scale <em>user</em> service to 2 replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc scale --replicas=2 deployment/user-v1.0.0 -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until all replicas are ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_ready_replicas_istio.png" alt="grpc ready replicas istio">
</div>
<div class="title">Figure 7. user service with two replicas</div>
</div>
<div class="paragraph">
<p>Now, simulate some traffic with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">while true; do curl -ksv -o /dev/null "https://${OCP_GRPCDEMO_HOST}/v1/account/01234" ; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the {ocp} web console, check the logs in both <em>user</em> pods. Now you can see both replicas receiving traffic.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_log1_istio.png" alt="grpc log1 istio">
</div>
<div class="title">Figure 8. user service logs (replica 1)</div>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_log2_istio.png" alt="grpc log2 istio">
</div>
<div class="title">Figure 9. user service logs (replica 2)</div>
</div>
<div class="paragraph">
<p>In Kiali you can check all the information about the replicas for this service:</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="grpc_kiali_replicas.png" alt="grpc kiali replicas">
</div>
<div class="title">Figure 10. user service in Kiali</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_remove_everything"><a class="anchor" href="#_remove_everything"></a>Remove everything</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After you have completed the lab you can remove everything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo-istio.yaml \
    -p ACCOUNT_ROUTE="${OCP_GRPCDEMO_HOST}" -n ${OCP_NAMESPACE} \
    | oc delete -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo-route-istio.yaml \
    -p GRPC_ROUTE_NAME="${OCP_USER}-grpc" -p GRPC_ROUTE="${OCP_GRPCDEMO_HOST}" \
    -n ${OCP_NAMESPACE} \
    | oc delete -n istio-system -f -</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
