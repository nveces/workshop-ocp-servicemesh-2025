<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{rhossm}: Traffic Management Labs :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/03-traffic-management/index.html">
    <link rel="prev" href="../02-envoy-istio-control-plane/index.html">
    <link rel="next" href="../04-troubleshooting/index.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-deploy.html">2. Deploy Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#package">Build Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#deploy">Deploy Dervice</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-introduction/index.html">3. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_2_complete_application_deployment">Lab 2 - Complete application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_3_adding_persistent_volumes">Lab 3 - Adding persistent volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_4_configuration_management">Lab 4 - Configuration management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_5_resources">Lab 5 - Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_6_liveness_and_readiness_probes">Lab 6 - Liveness and readiness probes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html">4. Envoy istio Control plane - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_4_istio_envoy_objects_relationship">Lab 4 - Istio-Envoy Objects Relationship</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_5_envoy_proxy">Lab 5 - Envoy Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_6_istio_control_plane">Lab 6 - Istio Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_7_istio_global_services">Lab 7 - Istio Global Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">5. Traffic management - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_rhossm_traffic_management_labs">{rhossm}: Traffic Management Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_1_ingress_gateways">Lab 1 - Ingress Gateways</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_2_requests_routing">Lab 2 - Requests Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_3_traffic_shifting_and_weight_balancing">Lab 3 - Traffic Shifting and Weight Balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_4_fault_injection">Lab 4 - Fault Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_5_requests_timeouts">Lab 5 - Requests Timeouts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_6_circuit_breaking">Lab 6 - Circuit Breaking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_7_mirroring_and_dark_launches">Lab 7 - Mirroring and Dark Launches</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../04-troubleshooting/index.html">6. Troubleshooting - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_4_service_mesh_ingress_traffic_flow">Lab 4 - Service Mesh Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_5_service_mesh_secure_ingress_traffic_flow">Lab 5 - Service Mesh Secure Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_6_service_mesh_secure_egress_traffic_flow">Lab 6 - Service Mesh Secure Egress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_7_troubleshooting_tools">Lab 7 - Troubleshooting Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../05-security/index.html">7. Security - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_1_setup_demo_applications">Lab 1 - Setup demo applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_2_peerauthentication">Lab 2 - PeerAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_3_authorization_part_1">Lab 3 - Authorization: part 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_4_requestauthentication">Lab 4 - RequestAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_5_authorization_part_2">Lab 5 - Authorization: part 2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../06-extensibility/index.html">8. Extensibility - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_rhossm_extensibility_labs">{rhossm}: Extensibility Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_1_envoy_filters">Lab 1 - Envoy Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_2_waes">Lab 2 - {waes}</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">WorkShop - Service Mesh on OCP 2025</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">WorkShop - Service Mesh on OCP 2025</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="index.html">5. Traffic management - Labs</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/03-traffic-management/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">{rhossm}: Traffic Management Labs</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The objective of these labs is to get a deep understanding of the following topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Smart traffic routing, shifting and mirroring.</p>
</li>
<li>
<p>Ingress and Egress</p>
</li>
<li>
<p>Fault Injection</p>
</li>
<li>
<p>Fault Tolerance and Circuit Breaking</p>
</li>
<li>
<p>gRPC routing</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup"><a class="anchor" href="#_setup"></a>2. Setup</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>2.1. Prerequisites</h3>
<div class="paragraph">
<p>During this tutorial, it will be required to work with different tools for running the exercises included. Please, install the following software:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top"><strong>Tool</strong></th>
<th class="tableblock halign-center valign-top"><strong>Fedora</strong></th>
<th class="tableblock halign-center valign-top"><strong>macOS</strong></th>
<th class="tableblock halign-center valign-top"><strong>windows</strong></th>
<th class="tableblock halign-center valign-top"><strong>Official Documentation</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">oc</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-mac.tar.gz">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-windows.zip">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.openshift.com/container-platform/4.7/cli_reference/openshift_cli/getting-started-cli.html">OpenShift CLI - Docs</a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">git</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://git-scm.com/download/linux">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://git-scm.com/download/mac">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://git-scm.com/download/win">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://git-scm.com">Git - Docs</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You must have an up-to-date version of the <em>oc</em> command.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_laboratory"><a class="anchor" href="#_laboratory"></a>2.2. Laboratory</h3>
<div class="paragraph">
<p>This laboratory is based on the following technologies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Red Hat OpenShift Container Platform</p>
</li>
<li>
<p>Red Hat OpenShift Service Mesh based on <em>Istio</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The previous technologies and resources will allow you to implement a microservice-based application in OpenShift Container Platform which will be included in Service Mesh. The main objective of deploying this application in OpenShift Container Platform is to understand how to setup routing scenarios in OpenShift Service Mesh.</p>
</div>
<div class="sect3">
<h4 id="_laboratory_parameters"><a class="anchor" href="#_laboratory_parameters"></a>2.2.1. Laboratory Parameters</h4>
<div class="paragraph">
<p>The Instructor will provide users with the OpenShift Container Platform credentials and other important parameters at the beginning of this lab.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top"><strong>Name</strong></th>
<th class="tableblock halign-center valign-top"><strong>Reference</strong></th>
<th class="tableblock halign-center valign-top"><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">OpenShift API (used with <em>oc</em> CLI)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;ocp_cluster_api&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em><a href="https://api.labs.sandbox1293.opentlc.com:6443" class="bare">https://api.labs.sandbox1293.opentlc.com:6443</a></em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">OpenShift Web Console</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;ocp_cluster_console&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em><a href="https://console-openshift-console.apps.labs.sandbox1293.opentlc.com" class="bare">https://console-openshift-console.apps.labs.sandbox1293.opentlc.com</a></em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Username</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;user&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>user1</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Password</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;pass&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>P4ssw0rd</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Namespace</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;user_namespace&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>user1-namespace</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">OpenShift Apps Domain</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;openshift_apps_domain&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>apps.labs.sandbox1293.opentlc.com</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Kiali Url</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;kiali_url&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em><a href="https://kiali-istio-system.apps.labs.sandbox1293.opentlc.com" class="bare">https://kiali-istio-system.apps.labs.sandbox1293.opentlc.com</a></em></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The labs will reference these parameters. You will need to replace the referenced parameters with the correct values.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For simplicity, the commands in these labs will use environment variables. Make sure you export the environment variables in your shell before running any command, replacing the placeholders with the values provided to you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export OCP_USER="&lt;user&gt;"
export OCP_PASSWORD="&lt;pass&gt;"
export OCP_NAMESPACE="${OCP_USER}-namespace"
export OCP_API="&lt;ocp_cluster_api&gt;"
export OCP_DOMAIN="&lt;openshift_apps_domain&gt;"
export OCP_BOOKINFO_HOST="${OCP_USER}.bookinfo.${OCP_DOMAIN}"
export OCP_HTTPBIN_HOST="${OCP_USER}.httpbin.${OCP_DOMAIN}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export OCP_USER="user1"
export OCP_PASSWORD="P4ssw0rd"
export OCP_NAMESPACE="${OCP_USER}-namespace"
export OCP_API="https://api.labs.sandbox1293.opentlc.com:6443"
export OCP_DOMAIN="apps.labs.sandbox1293.opentlc.com"
export OCP_BOOKINFO_HOST="${OCP_USER}.bookinfo.${OCP_DOMAIN}"
export OCP_HTTPBIN_HOST="${OCP_USER}.httpbin.${OCP_DOMAIN}"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
From now on, all labs will assume these exports are defined in your shell environment.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_openshift_cli"><a class="anchor" href="#_openshift_cli"></a>2.2.2. OpenShift CLI</h4>
<div class="paragraph">
<p>The OpenShift Container Platform CLI, installed before, exposes commands for managing your applications, as well as lower level tools to interact with each component of your system.</p>
</div>
<div class="paragraph">
<p>Make sure you can connect to the cluster executing the next command in your terminal:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u ${OCP_USER} -p ${OCP_PASSWORD} ${OCP_API}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/03-traffic-management/oc_login_output.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/oc_login_output.png" alt="oc login output"></a>
</div>
<div class="title">Figure 1. Red Hat OpenShift Container Platform CLI login</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please, pay special attention to the <em>oc</em> tool as you will need to use it several times during these labs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Make sure you are working in your namespace:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project ${OCP_NAMESPACE}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_web_console"><a class="anchor" href="#_web_console"></a>2.2.3. Web Console</h4>
<div class="paragraph">
<p>In addition, you can access the OpenShift Container Platform Web Console using via web browser, use your credentials to login:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;ocp_cluster_console&gt; (<em>E.g. <a href="https://console-openshift-console.apps.labs.sandbox1420.opentlc.com" class="bare">https://console-openshift-console.apps.labs.sandbox1420.opentlc.com</a></em>)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/03-traffic-management/ocp_console.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/ocp_console.png" alt="ocp console"></a>
</div>
<div class="title">Figure 2. Red Hat OpenShift Container Platform Web Console login</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gihub_repository"><a class="anchor" href="#_gihub_repository"></a>2.3. GiHub Repository</h3>
<div class="paragraph">
<p>All files used in the labs are located in a GitHub repository for your convenience.</p>
</div>
<div class="paragraph">
<p>Follow the next steps in order to clone the repository:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone <a href="https://github.com/drhelius/ossm-traffic-management.git" class="bare">https://github.com/drhelius/ossm-traffic-management.git</a></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/03-traffic-management/git_clone_output.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/git_clone_output.png" alt="git clone output"></a>
</div>
<div class="title">Figure 3. Red Hat OpenShift Container Platform Git clone output</div>
</div>
<div class="paragraph">
<p>Navigate to the new directory created in your system:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ossm-traffic-management</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
From now on, all labs will assume you are located in this directory.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sample_applications"><a class="anchor" href="#_sample_applications"></a>3. Sample Applications</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_bookinfo"><a class="anchor" href="#_bookinfo"></a>3.1. Bookinfo</h3>
<div class="paragraph">
<p>Bookinfo is a sample application composed of four separate microservices used to demonstrate various Istio features.</p>
</div>
<div class="paragraph">
<p>Bookinfo displays information about a book, similar to a single catalog entry of an online book store. Displayed on the page is a description of the book, book details (ISBN, number of pages, and so on), and a few book reviews.</p>
</div>
<div class="paragraph">
<p>The Bookinfo application is broken into four separate microservices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>productpage</code>. The <code>productpage</code> microservice calls the details and <code>reviews</code> microservices to populate the page.</p>
</li>
<li>
<p><code>details</code>. The <code>details</code> microservice contains book information.</p>
</li>
<li>
<p><code>reviews</code>. The <code>reviews</code> microservice contains book reviews. It also calls the <code>ratings</code> microservice.</p>
</li>
<li>
<p><code>ratings</code>. The <code>ratings</code> microservice contains book ranking information that accompanies a book review.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are 3 versions of the <code>reviews</code> microservice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Version v1 doesn’t call the <code>ratings</code> service.</p>
</li>
<li>
<p>Version v2 calls the <code>ratings</code> service, and displays each rating as 1 to 5 black stars.</p>
</li>
<li>
<p>Version v3 calls the <code>ratings</code> service, and displays each rating as 1 to 5 red stars.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The end-to-end architecture of the application is shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/03-traffic-management/bookinfo.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/bookinfo.png" alt="bookinfo"></a>
</div>
<div class="title">Figure 4. Red Hat OpenShift Container Platform Bookinfo application architecture</div>
</div>
</div>
<div class="sect2">
<h3 id="_httpbin"><a class="anchor" href="#_httpbin"></a>3.2. httpbin</h3>
<div class="paragraph">
<p>Some labs will use <em>httpbin</em> as an HTTP request and response service. It offers many tools to proof test HTTP.</p>
</div>
<div class="paragraph">
<p>This service is a local version of <a href="https://httpbin.org/" class="bare">https://httpbin.org/</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_1_ingress_gateways"><a class="anchor" href="#_lab_1_ingress_gateways"></a>4. Lab 1 - Ingress Gateways</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_2"><a class="anchor" href="#_introduction_2"></a>4.1. Introduction</h3>
<div class="paragraph">
<p>An Ingress Gateway describes a load balancer operating at the edge of the mesh that receives incoming HTTP/TCP connections. It configures exposed ports, protocols, etc. but, unlike Kubernetes Ingress Resources, does not include any traffic routing configuration. Traffic routing for ingress traffic is instead configured using Istio routing rules, exactly in the same way as for internal service requests.</p>
</div>
<div class="sect3">
<h4 id="_gateway"><a class="anchor" href="#_gateway"></a>4.1.1. Gateway</h4>
<div class="paragraph">
<p>The first step to enable a new host in the Ingress Gateway is creating a <em>Gateway</em> object.</p>
</div>
<div class="paragraph">
<p>The <em>Gateway</em> in this lab looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway <i class="conum" data-value="1"></i><b>(1)</b>
  servers:
  - port: <i class="conum" data-value="2"></i><b>(2)</b>
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - ${PRODUCTPAGE_ROUTE}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note the <em>selector</em> matching the Ingress Gateway deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Also note that we are creating a listener in port 80 using the desired host for our OpenShift Container Platform <em>Route</em>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_virtual_service"><a class="anchor" href="#_virtual_service"></a>4.1.2. Virtual Service</h4>
<div class="paragraph">
<p>Next, we need to route traffic from the Ingress Gateway to the desired service. In Bookinfo we want users to reach the <em>productpage</em> service.</p>
</div>
<div class="paragraph">
<p>With this <em>VirtualService</em> we are routing traffic from the Ingress Gateway to <em>productpage</em> service in port 9080, where the service is listening.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - ${PRODUCTPAGE_ROUTE}
  gateways:
  - bookinfo-gateway <i class="conum" data-value="1"></i><b>(1)</b>
  http:
  - route:
    - destination: <i class="conum" data-value="2"></i><b>(2)</b>
        host: productpage
        port:
          number: 9080</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that the <em>gateways</em> field matches the name of the <em>Gateway</em> created before.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We want to route from the Ingress Gateway to the <em>productpage</em> service at port 9080</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_route"><a class="anchor" href="#_route"></a>4.1.3. Route</h4>
<div class="paragraph">
<p>The last step is exposing the Ingress Gateway using an OpenShift Container Platform <em>Route</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- kind: Route
  apiVersion: route.openshift.io/v1
  metadata:
    name: ${PRODUCTPAGE_ROUTE_NAME}
  spec:
    host: ${PRODUCTPAGE_ROUTE}
    to:
      kind: Service
      name: istio-ingressgateway
      weight: 100
    port:
      targetPort: http2
    tls:
      termination: edge</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <em>Route</em> will "listen" in the desired host and redirect traffic to the Ingress Gateway.</p>
</div>
<div class="paragraph">
<p>It is important to remember that this <em>Route</em> must be created in the OpenShift Service Mesh Control Plane namespace. In this lab this namespace is <code>istio-system</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_bookinfo_using_an_ingress_gateway"><a class="anchor" href="#_deploy_bookinfo_using_an_ingress_gateway"></a>4.2. Deploy Bookinfo using an Ingress Gateway</h3>
<div class="paragraph">
<p>The following steps will deploy all necessary objects to run Bookinfo in OpenShift Service Mesh.</p>
</div>
<div class="paragraph">
<p>The <em>Gateway</em>, <em>VirtualService</em> and <em>Route</em> described before will also be created. Take a look at the <code>bookinfo/bookinfo.yaml</code> and <code>bookinfo/bookinfo-route.yaml</code> files to understand what objects are being created.</p>
</div>
<div class="paragraph">
<p>Deploy the application in your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f bookinfo/bookinfo.yaml \
    -p PRODUCTPAGE_ROUTE="${OCP_BOOKINFO_HOST}" -n ${OCP_NAMESPACE} \
    | oc apply -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>As described before, we will create a route in the <code>istio-system</code> namespace to expose the <em>productpage</em> service through an Ingress Gateway:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f bookinfo/bookinfo-route.yaml \
    -p PRODUCTPAGE_ROUTE_NAME="${OCP_USER}-productpage" -p PRODUCTPAGE_ROUTE="${OCP_BOOKINFO_HOST}" \
    -n ${OCP_NAMESPACE} \
    | oc apply -n istio-system -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait some seconds for all the pods to be ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the application is reachable and is running ok:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -s -kI "https://${OCP_BOOKINFO_HOST}/productpage"</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/03-traffic-management/bookinfo_curl.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/bookinfo_curl.png" alt="bookinfo curl"></a>
</div>
<div class="title">Figure 5. Bookinfo productpage service working</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/03-ingress.adoc - include::/03-traffic-management/kiali_traffic.adoc[]</p>
</div>
<div class="paragraph">
<p>Now, this is how the Ingress Gateway looks like in Kiali:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/03-traffic-management/ingress_bookinfo.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/ingress_bookinfo.png" alt="ingress bookinfo"></a>
</div>
<div class="title">Figure 6. Bookinfo productpage service through an Ingress Gateway</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/03-ingress.adoc - include::partials/03-traffic-management/remove_bookinfo.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_httpbin_using_an_ingress_gateway"><a class="anchor" href="#_deploy_httpbin_using_an_ingress_gateway"></a>4.3. Deploy httpbin using an Ingress Gateway</h3>
<div class="paragraph">
<p>In the same way as with the Bookinfo <em>productpage</em> service, the following steps will deploy all necessary objects to run <em>httpbin</em> in OpenShift Service Mesh.</p>
</div>
<div class="paragraph">
<p>A <em>Gateway</em>, <em>VirtualService</em> and <em>Route</em> for the Ingress Gateway will also be created. Take a look at the <code>httpbin/httpbin.yaml</code> and <code>httpbin/httpbin-route.yaml</code> files to understand what objects are being created.</p>
</div>
<div class="paragraph">
<p>Deploy the application in your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f httpbin/httpbin.yaml \
    -p HTTPBIN_ROUTE="${OCP_HTTPBIN_HOST}" -n ${OCP_NAMESPACE} \
    | oc apply -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>As described in Bookinfo, we will create a route in the <code>istio-system</code> namespace to expose the <em>httpbin</em> service through an Ingress Gateway:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f httpbin/httpbin-route.yaml \
    -p HTTPBIN_ROUTE_NAME="${OCP_USER}-httpbin" -p HTTPBIN_ROUTE="${OCP_HTTPBIN_HOST}" \
    -n ${OCP_NAMESPACE} \
    | oc apply -n istio-system -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait some seconds for all the pods to be ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the application is reachable and is running ok:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -s -kI "https://${OCP_HTTPBIN_HOST}"</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">httpbin service working</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/httpbin_curl.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/httpbin_curl.png" alt="httpbin curl"></a></span></p>
</div>
<div class="paragraph">
<div class="title">httpbin service through an Ingress Gateway</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/ingress_httpbin.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/ingress_httpbin.png" alt="ingress httpbin"></a></span></p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/03-ingress.adoc - include::/03-traffic-management/remove_httpbin.adoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_2_requests_routing"><a class="anchor" href="#_lab_2_requests_routing"></a>5. Lab 2 - Requests Routing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_3"><a class="anchor" href="#_introduction_3"></a>5.1. Introduction</h3>
<div class="paragraph">
<p>Now that you have Bookinfo all set up. Is time to do some requests routing. OpenShift Service Mesh by default routes requests in a round robin manner. But in this case, all requests are going only to version 1 of <code>reviews</code> since the <em>VirtualServices</em> are set that way.</p>
</div>
<div class="sect3">
<h4 id="_route_traffic_to_a_specific_version"><a class="anchor" href="#_route_traffic_to_a_specific_version"></a>5.1.1. Route traffic to a specific version</h4>
<div class="paragraph">
<p>In this lab we will apply the rules to make all requests go to version 2 of <code>reviews</code> so we can see the stars ratings. For that we are going to use the following <em>VirtualService</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v2 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that the only version in the <em>VirtualService</em> is the version 2 of the <code>reviews</code> service.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can see that it refers to something called a <code>subset</code>. This is the way Istio has to call the different versions of a <code>service</code>. You can see the different subsets in the <em>DestinationRules</em>, like the following one for the <code>reviews</code> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  labels:
    template: bookinfo-template
  name: reviews
spec:
  host: reviews
  subsets: <i class="conum" data-value="1"></i><b>(1)</b>
  - labels:
      version: v1
    name: v1
  - labels:
      version: v2
    name: v2
  - labels:
      version: v3
    name: v3</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As you can see, there are three different subsets that you can reference from a <em>VirtualService</em>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_route_traffic_based_on_headers"><a class="anchor" href="#_route_traffic_based_on_headers"></a>5.1.2. Route traffic based on headers</h4>
<div class="paragraph">
<p>Now let&#8217;s think that we have a new version for the application and you want to deploy it first to a set of premium users. We are going to see how to do that in this lab where we are going to route the requests from one user in particular to version 3 of the <code>reviews</code> service. For that we are going to use the following <em>VirtualService</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: pepito <i class="conum" data-value="1"></i><b>(1)</b>
    route:
    - destination:
        host: reviews
        subset: v3 <i class="conum" data-value="2"></i><b>(2)</b>
  - route:
    - destination:
        host: reviews
        subset: v2 <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we say what are we looking for in the header</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we make "pepito" see the version 3 of the <code>reviews</code> server.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If it does not match the header, the traffic is routed to version 2.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This file is located in <code>lab2/vs-reviews-headers.yaml</code> so feel free to change "pepito" for another name if you prefer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/04-requests-routing.adoc - include::partials/03-traffic-management/deploy_bookinfo.adoc[]</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_route_traffic_to_version_2"><a class="anchor" href="#_route_traffic_to_version_2"></a>5.2. Route traffic to version 2</h3>
<div class="paragraph">
<p>Execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">oc apply -f lab2/vs-reviews-v2.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now check that the product page shows the stars of the ratings visiting <a href="https://&lt;user&gt;.bookinfo.&lt;openshift_apps_domain&gt;/productpage" class="bare">https://&lt;user&gt;.bookinfo.&lt;openshift_apps_domain&gt;/productpage</a> with your browser:</p>
</div>
<div class="paragraph">
<div class="title">Product Page showing ratings</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/productpage-v2.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/productpage-v2.png" alt="productpage v2"></a></span></p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/04-requests-routing.adoc - include::partials/03-traffic-management/kiali_traffic.adoc[]</p>
</div>
<div class="paragraph">
<p>You should see a graph similar to this:</p>
</div>
<div class="paragraph">
<div class="title">Kiali traffic version 2</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali-traffic-v2.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali-traffic-v2.png" alt="kiali traffic v2"></a></span></p>
</div>
<div class="paragraph">
<p>You see there that all traffic goes to version 2 of the <code>reviews</code> service that calls the <code>ratings</code> service to get the stars.</p>
</div>
</div>
<div class="sect2">
<h3 id="_route_traffic_based_on_headers_2"><a class="anchor" href="#_route_traffic_based_on_headers_2"></a>5.3. Route traffic based on headers</h3>
<div class="paragraph">
<p>Execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">oc apply -f lab2/vs-reviews-headers.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test it, click on the <em>Sign in</em> button at the top right of the Product Page and login as "pepito", or the user you editted in the yaml if you decided to do that. You have to write it exactly like in the yaml. And you can type whatever you want in the <em>Password</em> field.</p>
</div>
<div class="paragraph">
<p>You should see the red stars now:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/03-traffic-management/productpage-red.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/productpage-red.png" alt="productpage red"></a>
</div>
<div class="title">Figure 7. Product Page with red stars</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/04-requests-routing.adoc - include::partials/03-traffic-management/remove_bookinfo.adoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_3_traffic_shifting_and_weight_balancing"><a class="anchor" href="#_lab_3_traffic_shifting_and_weight_balancing"></a>6. Lab 3 - Traffic Shifting and Weight Balancing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_4"><a class="anchor" href="#_introduction_4"></a>6.1. Introduction</h3>
<div class="paragraph">
<p>In this lab you will learn how to gradually migrate traffic from one version of a service to another.</p>
</div>
<div class="paragraph">
<p>For example, you might migrate traffic from an older version to a new version. In this example you will use <em>reviews:v1</em> service as the old version and <em>reviews:v2</em> service as the new version.</p>
</div>
<div class="paragraph">
<p>First you will deploy Bookinfo and then you will configure a sequence of rules that send 90% of traffic to <em>reviews:v1</em> and 10% to <em>reviews:v2</em>. Then, you will continue the migration by sending 50% of traffic to each service and, finally, complete the migration sending 100% of the traffic to <em>reviews:v2</em>.</p>
</div>
<div class="paragraph">
<p>In this lab you will use 2 versions of the same service but you could create more complex routing rules weigth-balancing between many different versions of the same service or even different services.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/03-traffic-management/deploy_bookinfo.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="_route_10_of_the_traffic_to_a_new_service"><a class="anchor" href="#_route_10_of_the_traffic_to_a_new_service"></a>6.2. Route 10% of the traffic to a new service</h3>
<div class="paragraph">
<p>The first modification to the <em>reviews</em> <em>VirtualService</em> to add a 90/10 routing rule looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 90 <i class="conum" data-value="1"></i><b>(1)</b>
    - destination:
        host: reviews
        subset: v2
      weight: 10 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>90% traffic to <em>reviews:v1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>10% traffic to <em>reviews:v2</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the sum of weights across destinations should be == 100. If there is only one destination in a rule, the weight value is assumed to be 100.</p>
</div>
<div class="paragraph">
<p>You can apply it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab3/vs-reviews-shifting-90-10.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/03-traffic-management/kiali_traffic_loop.adoc[]</p>
</div>
<div class="paragraph">
<p>Make sure you select <em>Request Percentage</em> in the <em>Show Edge Labels</em> display options in Kiali:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Request Percentage</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali_percentage.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali_percentage.png" alt="kiali percentage"></a></span></p>
</div>
<div class="paragraph">
<p>Check the results:</p>
</div>
<div class="paragraph">
<div class="title">Kiali traffic shifting 90/10</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali-shifting-90-10.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali-shifting-90-10.png" alt="kiali shifting 90 10"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_route_half_the_traffic_to_each_service"><a class="anchor" href="#_route_half_the_traffic_to_each_service"></a>6.3. Route half the traffic to each service</h3>
<div class="paragraph">
<p>The <em>reviews</em> <em>VirtualService</em> to add a 50/50 routing rule will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 50 <i class="conum" data-value="1"></i><b>(1)</b>
    - destination:
        host: reviews
        subset: v2
      weight: 50 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>50% traffic to <em>reviews:v1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>50% traffic to <em>reviews:v2</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can apply it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab3/vs-reviews-shifting-50-50.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/03-traffic-management/kiali_traffic_loop.adoc[]</p>
</div>
<div class="paragraph">
<div class="title">Kiali traffic shifting 50/50</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali-shifting-50-50.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali-shifting-50-50.png" alt="kiali shifting 50 50"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_route_all_the_traffic_to_the_new_service"><a class="anchor" href="#_route_all_the_traffic_to_the_new_service"></a>6.4. Route all the traffic to the new service</h3>
<div class="paragraph">
<p>The <em>reviews</em> <em>VirtualService</em> to add a 100% routing rule to the new service will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 0 <i class="conum" data-value="1"></i><b>(1)</b>
    - destination:
        host: reviews
        subset: v2
      weight: 100 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>0% traffic to <em>reviews:v1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>100% traffic to <em>reviews:v2</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that we could have omitted the <em>reviews:v1</em> <em>destination</em> altogether as it is not receiving any traffic at all.</p>
</div>
<div class="paragraph">
<p>You can apply it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab3/vs-reviews-shifting-0-100.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/03-traffic-management/kiali_traffic_loop.adoc[]</p>
</div>
<div class="paragraph">
<div class="title">Kiali traffic shifting 0/100</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali-shifting-0-100.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali-shifting-0-100.png" alt="kiali shifting 0 100"></a></span></p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/05-traffic-shifting.adoc - include::partials/03-traffic-management/remove_bookinfo.adoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_4_fault_injection"><a class="anchor" href="#_lab_4_fault_injection"></a>7. Lab 4 - Fault Injection</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_5"><a class="anchor" href="#_introduction_5"></a>7.1. Introduction</h3>
<div class="paragraph">
<p>OpenShift Service Mesh has mechanisms to inject faults in your application to test how it will behave when a real fault happens. This is very useful to check if your application&#8217;s recovery policies aren&#8217;t too restrictive.</p>
</div>
<div class="paragraph">
<p>In this lab you will inject two different faults in your application. A delay and an abort. Delays are timing failures and aborts are crash failures. You are going to use a similar method than in <a href="#_lab_2_requests_routing">Lab 2 - Requests Routing</a> when you routed requests using http headers, but this time you are going to inject faults for user "pepito".</p>
</div>
<div class="sect3">
<h4 id="_delay"><a class="anchor" href="#_delay"></a>7.1.1. Delay</h4>
<div class="paragraph">
<p>For the delay you are going to add 7 seconds of delay between the <code>reviews</code> and <code>ratings</code> services, using this <em>VirtualService</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService <i class="conum" data-value="1"></i><b>(1)</b>
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v2
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - match:
    - headers:
        end-user:
          exact: pepito
    fault:
      delay:
        percentage:
          value: 100.0 <i class="conum" data-value="2"></i><b>(2)</b>
        fixedDelay: 7s <i class="conum" data-value="3"></i><b>(3)</b>
    route:
    - destination:
        host: ratings
        subset: v1 <i class="conum" data-value="4"></i><b>(4)</b>
  - route:
    - destination:
        host: ratings
        subset: v1 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this <em>VirtualService</em> you are setting all traffic to v2 of <code>reviews</code> service, since v1 does not have a connection with the <code>ratings</code> service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the percentage in which the fault will be injected. In this case is a 100%.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the delay applied to user "pepito".</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Notice here that you are going to the same destination, but the delay is only for "pepito".</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_abort"><a class="anchor" href="#_abort"></a>7.1.2. Abort</h4>
<div class="paragraph">
<p>Now, for the abort, you will use the following <em>VirtualService</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - fault:
      abort:
        percentage:
          value: 100.0
        httpStatus: 500 <i class="conum" data-value="1"></i><b>(1)</b>
    route:
    - destination:
        host: ratings
        subset: v1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice that this time you are always returning an error 500 in the connection between <code>reviews</code> and <code>ratings</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/06-fault-injection.adoc - include::partials/03-traffic-management/deploy_bookinfo.adoc[]</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inject_delay"><a class="anchor" href="#_inject_delay"></a>7.2. Inject delay</h3>
<div class="paragraph">
<p>Execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab4/vs-delay.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To check the delay, visit your Bookinfo application (<a href="https://&lt;user&gt;.bookinfo.&lt;openshift_apps_domain&gt;/productpage" class="bare">https://&lt;user&gt;.bookinfo.&lt;openshift_apps_domain&gt;/productpage</a>) and log in as pepito (or the name you chose). You will notice that it will take 7 seconds to load and you will see the following error in the <code>reviews</code> part: "<strong>Sorry, product reviews are currently unavailable for this book.</strong>"". Like this:</p>
</div>
<div class="paragraph">
<div class="title">Reviews failure</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/reviews-failure.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/reviews-failure.png" alt="reviews failure"></a></span></p>
</div>
<div class="paragraph">
<p>This happens because there is a hard-coded timeout between <code>productpage</code> service and <code>reviews</code> service of 3 seconds and 1 retry, so a total of 6 seconds. Then, you can&#8217;t see the <code>reviews</code> because of this timeout.</p>
</div>
</div>
<div class="sect2">
<h3 id="_inject_abort"><a class="anchor" href="#_inject_abort"></a>7.3. Inject abort</h3>
<div class="paragraph">
<p>Execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab4/vs-abort.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you don&#8217;t have to be logged in as pepito, enter again to your Product Page and now you will see the reviews, but the ratings will give you the following error: "<strong>Ratings service is currently unavailable</strong>". This is because this time the <code>ratings</code> service is returning an error 500. You should see this:</p>
</div>
<div class="paragraph">
<div class="title">Ratings failure</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/ratings-failure.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/ratings-failure.png" alt="ratings failure"></a></span></p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/06-fault-injection.adoc - include::/03-traffic-management/kiali_traffic.adoc[]</p>
</div>
<div class="paragraph">
<p>You should see a graph similar to this:</p>
</div>
<div class="paragraph">
<div class="title">Kiali ratings failure</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali-ratings-failure.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali-ratings-failure.png" alt="kiali ratings failure"></a></span></p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/06-fault-injection.adoc - include::partials/03-traffic-management/remove_bookinfo.adoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_5_requests_timeouts"><a class="anchor" href="#_lab_5_requests_timeouts"></a>8. Lab 5 - Requests Timeouts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_6"><a class="anchor" href="#_introduction_6"></a>8.1. Introduction</h3>
<div class="paragraph">
<p>A timeout for HTTP requests can be specified using the timeout field in the <em>VirtualService</em>. By default, the timeout is 15 seconds, but in this task you override the <em>reviews</em> service timeout to 1 second.</p>
</div>
<div class="paragraph">
<p>To see its effect, however, you also introduce an artificial 2 second delay in calls to the <em>ratings</em> service.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/07-requests-timeouts.adoc - include::partials/03-traffic-management/deploy_bookinfo.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_a_delay_to_ratings_service"><a class="anchor" href="#_adding_a_delay_to_ratings_service"></a>8.2. Adding a delay to ratings service</h3>
<div class="paragraph">
<p>First, route requests to <em>reviews:v2</em> service (a version that calls the ratings service).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply this change with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab5/vs-reviews-v2.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a 2 second delay to calls to the ratings service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - fault:
      delay:
        percent: 100
        fixedDelay: 2s
    route:
    - destination:
        host: ratings
        subset: v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can apply this change with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab5/vs-ratings-delay.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/07-requests-timeouts.adoc - include::partials/03-traffic-management/kiali_traffic_loop.adoc[]</p>
</div>
<div class="paragraph">
<p>Make sure you select <em>Response Time</em> in the <em>Show Edge Labels</em> display options in Kiali:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Response Time</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali_response.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali_response.png" alt="kiali response"></a></span></p>
</div>
<div class="paragraph">
<p>Check the results in Kiali. You may notice a 2 second delay in the ratings call:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Ratings service with 2s delay</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali-timeouts-ratings-delay.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali-timeouts-ratings-delay.png" alt="kiali timeouts ratings delay"></a></span></p>
</div>
<div class="paragraph">
<p>If you visit the Bookinfo app with your browser you should see the Bookinfo application working normally (with ratings stars displayed), but there is a 2 second delay whenever you refresh the page:</p>
</div>
<div class="paragraph">
<p><a href="https://&lt;user&gt;.bookinfo.&lt;openshift_apps_domain&gt;/productpage" class="bare">https://&lt;user&gt;.bookinfo.&lt;openshift_apps_domain&gt;/productpage</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_a_timeout_to_reviews_service"><a class="anchor" href="#_adding_a_timeout_to_reviews_service"></a>8.3. Adding a timeout to reviews service</h3>
<div class="paragraph">
<p>Now add a half second request timeout for calls to the <em>reviews</em> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v2
    timeout: 0.5s</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can apply this change with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab5/vs-reviews-timeout.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the request timeout is disabled. Since the <em>reviews</em> service subsequently calls the <em>ratings</em> service when handling requests, you can use Istio to inject a 2 second delay in calls to <em>ratings</em> to cause the <em>reviews</em> service to take longer than half a second to complete and consequently you could see the timeout in action.</p>
</div>
<div class="paragraph">
<p>Refresh the Bookinfo web page in your browser:</p>
</div>
<div class="paragraph">
<p><a href="https://&lt;user&gt;.bookinfo.&lt;openshift_apps_domain&gt;/productpage" class="bare">https://&lt;user&gt;.bookinfo.&lt;openshift_apps_domain&gt;/productpage</a></p>
</div>
<div class="paragraph">
<p>You can observe that instead of displaying reviews, the Bookinfo product page (which calls the reviews service to populate the page) display the message: <em>Sorry, product reviews are currently unavailable for this book</em>. This was the result of it receiving the timeout error from the <em>reviews</em> service.</p>
</div>
<div class="paragraph">
<p>You may have noticed that it returns in about 1 second, instead of 2, and the reviews are unavailable. The reason that the response takes 1 second, even though the timeout is configured at half a second, is because there is a hard-coded retry in the <em>productpage</em> service, so it calls the timing out reviews service twice before returning.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/07-requests-timeouts.adoc - include::partials/03-traffic-management/kiali_traffic_loop.adoc[]</p>
</div>
<div class="paragraph">
<p>Check the results in Kiali:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Reviews service with timeout</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali-timeouts-reviews.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali-timeouts-reviews.png" alt="kiali timeouts reviews"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_hardcoded_timeout_in_productpage_service"><a class="anchor" href="#_hardcoded_timeout_in_productpage_service"></a>8.4. Hardcoded timeout in productpage service</h3>
<div class="paragraph">
<p>If you examine the <a href="#_lab_4_fault_injection">Lab 4 - Fault Injection</a>, you’ll find out that the productpage microservice also has its own application-level timeout (3 seconds) for calls to the <em>reviews</em> microservice.</p>
</div>
<div class="paragraph">
<p>Notice that in this lab you used an Istio route rule to set the timeout to half a second. Had you instead set the timeout to something greater than 3 seconds (such as 4 seconds) the timeout would have had no effect since the more restrictive of the two takes precedence.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/07-requests-timeouts.adoc - include::partials/03-traffic-management/remove_bookinfo.adoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_6_circuit_breaking"><a class="anchor" href="#_lab_6_circuit_breaking"></a>9. Lab 6 - Circuit Breaking</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_7"><a class="anchor" href="#_introduction_7"></a>9.1. Introduction</h3>
<div class="paragraph">
<p>In this lab you are going to configure circuit breaking for connections. This is very important for building resilient microservices, since it helps to limit the impact of failures and latency spikes.</p>
</div>
<div class="paragraph">
<p>You are going to deploy <code>httpbin</code> and <code>fortio</code> applications for this lab. <code>httpbin</code> is an http requests and response service and <code>fortio</code> is an application developed by the Istio team to load test microservices. You are going to use it as the client to trigger the circuit breaking configurations.</p>
</div>
<div class="paragraph">
<p>For the circuit breaking, you are going to use this <em>DestinationRule</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: httpbin
spec:
  host: httpbin <i class="conum" data-value="1"></i><b>(1)</b>
  subsets:
  - name: v1
    labels:
      version: v1
  trafficPolicy: <i class="conum" data-value="2"></i><b>(2)</b>
    connectionPool: <i class="conum" data-value="3"></i><b>(3)</b>
      tcp:
        maxConnections: 1
      http:
        http1MaxPendingRequests: 1
        maxRequestsPerConnection: 1
    outlierDetection: <i class="conum" data-value="4"></i><b>(4)</b>
      consecutiveErrors: 1
      interval: 1s
      baseEjectionTime: 3m
      maxEjectionPercent: 100</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <em>DestinationRule</em> is for <code>httpbin</code> service, version 1.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This property lets you create a Traffic Policy for this service.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You only want a number of connections of 1 TCP connection and 1 HTTP request per connection.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here you are checking every second that any host with one error should be ejected from the pool for 3 minutes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can do more things like load balancing, ejecting with consecutive 500 errors, and more. If you want to learn more, check the <a href="https://istio.io/v1.6/docs/reference/config/networking/destination-rule">Destination Rule</a> page at Istio.</p>
</div>
<div class="paragraph">
<p>After this, you are going to test the circuit breaking with the <code>fortio</code> client.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/08-circuit-breaking.adoc - include::partials/03-traffic-management/deploy_httpbin.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_fortio"><a class="anchor" href="#_deploy_fortio"></a>9.2. Deploy fortio</h3>
<div class="paragraph">
<p>Execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f fortio/fortio.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that you can get to <code>httpbin</code> from <code>fortio</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export FORTIO_POD=$(oc get pods --no-headers -n ${OCP_NAMESPACE} | awk '{ print $1 }' | grep fortio) <i class="conum" data-value="1"></i><b>(1)</b>

oc exec -n ${OCP_NAMESPACE} -it ${FORTIO_POD} -c fortio -- /usr/bin/fortio load -curl http://httpbin:9080/get <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You are creating an environment variable called "FORTIO_POD" to make the tests easier.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You are doing a single <code>GET</code> request inside the <code>fortio</code> pod to <code>httpbin</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Fortio check result</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/fortio-check.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/fortio-check.png" alt="fortio check"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_test_the_circuit_breaking"><a class="anchor" href="#_test_the_circuit_breaking"></a>9.3. Test the circuit breaking</h3>
<div class="sect3">
<h4 id="_apply_the_destinationrule"><a class="anchor" href="#_apply_the_destinationrule"></a>9.3.1. Apply the <em>DestinationRule</em></h4>
<div class="paragraph">
<p>Execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab6/httpbin-dr.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_trigger_the_circuit_breaker"><a class="anchor" href="#_trigger_the_circuit_breaker"></a>9.3.2. Trigger the circuit breaker</h4>
<div class="paragraph">
<p>Now lets execute the following command that opens 2 simultaneous connections (<code>-c 2</code>) and send 30 requests (<code>-n 30</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc exec -n ${OCP_NAMESPACE} -it ${FORTIO_POD} -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 30 -loglevel Warning http://httpbin:9080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will get a result similar to this:</p>
</div>
<div class="paragraph">
<div class="title">Fortio with 2 connections</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/fortio-2-30.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/fortio-2-30.png" alt="fortio 2 30"></a></span></p>
</div>
<div class="paragraph">
<p>You will notice that your results are not the same as the ones in the lab, but generally all requests arrive. This is because the <code>istio-proxy</code> is flexible and does not break all requests.</p>
</div>
<div class="paragraph">
<p>If you change the connections to 4. You will start seeing that less connections arrive to the <code>httpbin</code> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc exec -n ${OCP_NAMESPACE} -it ${FORTIO_POD} -c fortio -- /usr/bin/fortio load -c 4 -qps 0 -n 30 -loglevel Warning http://httpbin:9080/get</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Fortio with 4 connections</div>
<p>03-traffic-management/fortio-4-30.png[]</p>
</div>
<div class="paragraph">
<p>If you query the <code>istio-proxy</code> stats, you can see how many requests were flagged for circuit breaking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc exec -n ${OCP_NAMESPACE} ${FORTIO_POD} -c istio-proxy -- pilot-agent request GET stats | grep httpbin | grep upstream_rq_pending_overflow</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get something similar to this:</p>
</div>
<div class="paragraph">
<div class="title">Overflow requests</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/envoy-stats.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/envoy-stats.png" alt="envoy stats"></a></span></p>
</div>
<div class="paragraph">
<p>Notice that the stats are grouped by the subsets defined in the <em>DestinationRule</em>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_remove_fortio"><a class="anchor" href="#_remove_fortio"></a>9.4. Remove fortio</h3>
<div class="paragraph">
<p>Execute the following command to remove <code>fortio</code> from your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete -f fortio/fortio.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/08-circuit-breaking.adoc - include::partials/03-traffic-management/remove_httpbin.adoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_7_mirroring_and_dark_launches"><a class="anchor" href="#_lab_7_mirroring_and_dark_launches"></a>10. Lab 7 - Mirroring and Dark Launches</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_8"><a class="anchor" href="#_introduction_8"></a>10.1. Introduction</h3>
<div class="paragraph">
<p>Traffic mirroring, also called shadowing, is a powerful concept that allows feature teams to bring changes to production with as little risk as possible.</p>
</div>
<div class="paragraph">
<p>Mirroring sends a copy of live traffic to a mirrored service. The mirrored traffic happens out of band of the critical request path for the primary service.</p>
</div>
<div class="paragraph">
<p>In this lab, you will first force all traffic to <em>reviews:v1</em> service. Then, you will apply a rule to mirror a portion of traffic to <em>reviews:v2</em>.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/09-mirroring.adoc - include::/03-traffic-management/deploy_bookinfo.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="_mirroring_traffic_to_v2"><a class="anchor" href="#_mirroring_traffic_to_v2"></a>10.2. Mirroring traffic to v2</h3>
<div class="paragraph">
<p>The following <em>VirtualService</em> sends 100% of the traffic to <em>reviews:v1</em>. The last stanza specifies that you want to mirror to the <em>reviews:v2</em> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    mirror:
      host: reviews
      subset: v2
    mirrorPercentage:
      value: 10.0 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can use the <em>mirrorPercentage</em> field to mirror a fraction of the traffic, instead of mirroring all requests. If this field is absent, for compatibility with older versions, all traffic will be mirrored. In this example, only the 10% of the traffic will be sent to the mirror service.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When traffic gets mirrored, the requests are sent to the mirrored service with their Host/Authority headers appended with <em>-shadow</em>. For example, <em>cluster-1</em> becomes <em>cluster-1-shadow</em>.</p>
</div>
<div class="paragraph">
<p>Also, it is important to note that these requests are mirrored as "<em>fire and forget</em>", which means that the responses are discarded.</p>
</div>
<div class="paragraph">
<p>Apply the <em>VirtualService</em> with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab7/vs-reviews-mirroring.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/09-mirroring.adoc - include::partials/03-traffic-management/kiali_traffic_loop.adoc[]</p>
</div>
<div class="paragraph">
<p>Check the results in Kiali:</p>
</div>
<div class="paragraph">
<div class="title">Kiali traffic mirroring to reviews:v2 service</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali-mirroring.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali-mirroring.png" alt="kiali mirroring"></a></span></p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/03-traffic-management/09-mirroring.adoc - include::partials/03-traffic-management/remove_bookinfo.adoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_8_egress_gateways"><a class="anchor" href="#_lab_8_egress_gateways"></a>11. Lab 8 - Egress Gateways</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_9"><a class="anchor" href="#_introduction_9"></a>11.1. Introduction</h3>
<div class="paragraph">
<p>In this lab you are going to learn how to configure OpenShift Service Mesh to access external services from inside the applications.</p>
</div>
<div class="paragraph">
<p>Because all outbound traffic from an Istio-enabled pod is redirected to its sidecar proxy by default, accessibility of services outside of the cluster depends on the configuration of the proxy.</p>
</div>
<div class="paragraph">
<p>By default, Istio configures the Envoy proxy to pass through requests for unknown services.</p>
</div>
<div class="paragraph">
<p>Red Hat OpenShift Service Mesh can be configured with a special policy for handling external services, that is, those services that are not defined in Istio’s internal service registry.</p>
</div>
<div class="paragraph">
<p>If the policy is in permissive state (by default), the Istio proxy lets calls to unknown services pass through. If the policy is set to a restrictive state, then the Istio proxy blocks any host without a <em>ServiceEntry</em> defined within the mesh.</p>
</div>
<div class="paragraph">
<p>In this lab we have modified the Istio control plane to set the policy to a restrictive state.</p>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_an_external_service"><a class="anchor" href="#_accessing_an_external_service"></a>11.2. Accessing an external service</h3>
<div class="paragraph">
<p>At this point you can test wether you can query a service outside the mesh.</p>
</div>
<div class="paragraph">
<p>For this lab, you are going to use a simple pod based in <code>ubi:latest</code> (Red Hat Universal Base Image). This pod will be added to the mesh because it will have the Istio sidecar injected. It will be kept running by using a simple <em>sleep</em> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: ubi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ubi
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "true"
      labels:
        app: ubi
    spec:
      containers:
      - name: ubi
        image: registry.redhat.io/ubi8/ubi:latest
        command: ["sleep", "infinity"]
        imagePullPolicy: IfNotPresent</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you will use this running pod to run commands inside it, like <code>curl</code>, and test wether you can reach outside services or not.</p>
</div>
<div class="paragraph">
<p>First, deploy this container by executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ubi/ubi.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get the name of the pod:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export UBI_POD=$(oc get pods --no-headers -n ${OCP_NAMESPACE} | awk '{ print $1 }' | grep ubi)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check if you can query an external service from the <em>ubi</em> pod:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc exec -it ${UBI_POD} -n ${OCP_NAMESPACE} -c ubi -- curl -I https://github.com</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Accessing external service without <em>ServiceEntry</em></div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/egress_without_se.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/egress_without_se.png" alt="egress without se"></a></span></p>
</div>
<div class="paragraph">
<p>Ooops, you can&#8217;t, because OpenShift Service Mesh is configured with a restrictive policy.</p>
</div>
</div>
<div class="sect2">
<h3 id="_service_entry"><a class="anchor" href="#_service_entry"></a>11.3. Service Entry</h3>
<div class="paragraph">
<p>As stated before, in a restrictive state we need to add any external service to Istio&#8217;s internal registry.</p>
</div>
<div class="paragraph">
<p>You need to create a <em>ServiceEntry</em> for this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: github
spec:
  hosts:
  - github.com <i class="conum" data-value="1"></i><b>(1)</b>
  ports:
  - number: 443 <i class="conum" data-value="2"></i><b>(2)</b>
    name: https
    protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
  exportTo: [ ".", "istio-system" ] <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The external service</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>All necessary ports must be declared</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Limit the <em>ServiceEntry</em> to this namesapce and <em>istio-system</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Execute the following command to create the <em>ServiceEntry</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab8/github-serviceentry.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, check again if you can query an external service from the <em>ubi</em> pod:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc exec -it ${UBI_POD} -n ${OCP_NAMESPACE} -c ubi -- curl -I https://github.com</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Accessing external service with <em>ServiceEntry</em></div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/egress_with_se.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/egress_with_se.png" alt="egress with se"></a></span></p>
</div>
<div class="paragraph">
<p>So, this is now a controlled way to enable access to external services.</p>
</div>
<div class="paragraph">
<div class="title">Kiali external service with <em>ServiceEntry</em></div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali_egress_with_se.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali_egress_with_se.png" alt="kiali egress with se"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_egress_gateway"><a class="anchor" href="#_egress_gateway"></a>11.4. Egress Gateway</h3>
<div class="paragraph">
<p>In the previous example the external services are called directly from the client sidecar.</p>
</div>
<div class="paragraph">
<p>This example shows how to configure Istio to call external services, although this time indirectly via a dedicated Egress Gateway service.</p>
</div>
<div class="paragraph">
<p>Istio uses Ingress and Egress Gateways to configure load balancers executing at the edge of a service mesh. An Ingress Gateway allows you to define entry points into the mesh that all incoming traffic flows through. An Egress Gateway is a symmetrical concept; it defines exit points from the mesh.</p>
</div>
<div class="paragraph">
<p>Egress Gateways allow you to apply Istio features, for example, monitoring and route rules, to traffic exiting the mesh.</p>
</div>
<div class="paragraph">
<p>The first thing you need to configure an Egress Gateway is a <em>Gateway</em> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: github-egress
spec:
  selector:
    istio: egressgateway <i class="conum" data-value="1"></i><b>(1)</b>
  servers:
  - hosts:
      - github.com <i class="conum" data-value="2"></i><b>(2)</b>
    port:
      number: 443 <i class="conum" data-value="3"></i><b>(3)</b>
      name: https
      protocol: HTTPS
    tls:
      mode: PASSTHROUGH <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This will match a label in the Egress Gateway <em>Deployment</em> inside the <em>istio-system</em> control plane.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The host you want to expose.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the port to use in the Egress Gateway, not to be confused with the target port of the external service.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In this example you will <em>pass through</em> TLS communications.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create it with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab8/github-egress-gateway.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, you will have to create a <em>VirtualService</em> to direct traffic from the sidecars to the Egress Gateway and from the Egress Gateway to the external service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: github-egress
spec:
  hosts:
  - github.com <i class="conum" data-value="1"></i><b>(1)</b>
  gateways: <i class="conum" data-value="2"></i><b>(2)</b>
  - github-egress
  - mesh
  tls:
  - match: <i class="conum" data-value="3"></i><b>(3)</b>
    - gateways:
      - mesh
      sniHosts:
      - github.com
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
      weight: 100
  - match: <i class="conum" data-value="4"></i><b>(4)</b>
    - gateways:
      - github-egress
      sniHosts:
      - github.com
    route:
    - destination:
        host: github.com
      weight: 100
  exportTo: [ ".", "istio-system" ]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This <em>VirtualService</em> will be applied to this host.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>mesh</em> is a reserved word for sidecars. <em>github-egress</em> match the name of the <em>Gateway</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The first match will route traffic from sidecars to the Egress Gateway.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The second match is to finally route traffic from the Egress Gateway to the external service.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create it with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab8/github-egress-virtualservice.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, check again and simulate some traffic with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">while true; do oc exec -it ${UBI_POD} -n ${OCP_NAMESPACE} -c ubi -- curl -I https://github.com ; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Kiali you can see this time that the traffic is going through the Egress Gateway:</p>
</div>
<div class="paragraph">
<div class="title">Kiali external service with Egress Gateway</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/kiali_egress_with_egress.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/kiali_egress_with_egress.png" alt="kiali egress with egress"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_remove_everything"><a class="anchor" href="#_remove_everything"></a>11.5. Remove everything</h3>
<div class="paragraph">
<p>Before starting the next lab, remove everything you have created in your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete -f ubi/ubi.yaml -n ${OCP_NAMESPACE}
oc delete -f lab8/github-serviceentry.yaml -n ${OCP_NAMESPACE}
oc delete -f lab8/github-egress-gateway.yaml -n ${OCP_NAMESPACE}
oc delete -f lab8/github-egress-virtualservice.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_9_grpc_routing"><a class="anchor" href="#_lab_9_grpc_routing"></a>12. Lab 9 - gRPC Routing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_10"><a class="anchor" href="#_introduction_10"></a>12.1. Introduction</h3>
<div class="paragraph">
<p>Many new gRPC users are surprised to find that Kubernetes&#8217;s default load balancing often doesn&#8217;t work out of the box with gRPC.</p>
</div>
<div class="paragraph">
<p>gRPC is an increasingly common choice for application developers. Compared to alternative protocols such as JSON-over-HTTP, gRPC can provide some significant benefits, including dramatically lower (de)serialization costs, automatic type checking, formalized APIs, and less TCP management overhead.</p>
</div>
<div class="paragraph">
<p>However, gRPC also breaks the standard connection-level load balancing, including what&#8217;s provided by Kubernetes. This is because gRPC is built on HTTP/2, and HTTP/2 is designed to have a single long-lived TCP connection, across which all requests are multiplexed—meaning multiple requests can be active on the same connection at any point in time.</p>
</div>
<div class="paragraph">
<p>Once the connection is established, there&#8217;s no more balancing to be done. All requests will get pinned to a single destination pod.</p>
</div>
<div class="paragraph">
<p>The reason why this problem doesn&#8217;t occur in HTTP/1.1, which also has the concept of long-lived connections, is because HTTP/1.1 has several features that naturally result in cycling of TCP connections.</p>
</div>
<div class="paragraph">
<p>Since you can&#8217;t balance at the connection level, in order to do gRPC load balancing, we need to shift from connection balancing to request balancing. In other words, we need to open an HTTP/2 connection to each destination, and balance requests across these connections. Envoy, included in Istio, knows exactly how to achieve this.</p>
</div>
</div>
<div class="sect2">
<h3 id="_grpc_demo_without_istio"><a class="anchor" href="#_grpc_demo_without_istio"></a>12.2. gRPC demo without Istio</h3>
<div class="paragraph">
<p>In this lab you are going to deploy a gRPC demo scenario composed in four micro-services.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You are going to use a template to deploy the gRPC demo scenario so you are not required to understand the inner workings of the micro-services. If you are still interested, you have more information about this scenario in <a href="https://github.com/drhelius/grpc-demo">this repo</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">gRPC demo in Kiali</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_kiali.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_kiali.png" alt="grpc kiali"></a></span></p>
</div>
<div class="paragraph">
<p>First, deploy the gRPC services without Istio to understand the problem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export OCP_GRPCDEMO_HOST="${OCP_USER}.grpc.${OCP_DOMAIN}"

oc process -f lab9/grpc-demo.yaml \
    -p ACCOUNT_ROUTE="${OCP_GRPCDEMO_HOST}" -n ${OCP_NAMESPACE} \
    | oc apply -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a few seconds and make sure all services are ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">gRPC demo services ready</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_ready.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_ready.png" alt="grpc ready"></a></span></p>
</div>
<div class="paragraph">
<p>Scale <em>user</em> service to 2 replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc scale --replicas=2 deployment/user-v1.0.0 -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until all replicas are ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">user service with two replicas</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_ready_replicas.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_ready_replicas.png" alt="grpc ready replicas"></a></span></p>
</div>
<div class="paragraph">
<p>Now, simulate some traffic with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">while true; do curl -ksv -o /dev/null "https://${OCP_GRPCDEMO_HOST}/v1/account/01234" ; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the OpenShift Container Platform web console, check the logs in both <em>user</em> pods. You can see that only one replica is receiving traffic.</p>
</div>
<div class="paragraph">
<div class="title">user service logs (replica 1)</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_log1.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_log1.png" alt="grpc log1"></a></span></p>
</div>
<div class="paragraph">
<div class="title">user service logs (replica 2)</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_log2.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_log2.png" alt="grpc log2"></a></span></p>
</div>
<div class="paragraph">
<p>Now that you have checked there is no actual load balancing between <em>user</em> replicas, remove everything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo.yaml \
    -p ACCOUNT_ROUTE="${OCP_GRPCDEMO_HOST}" -n ${OCP_NAMESPACE} \
    | oc delete -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_grpc_demo_with_istio"><a class="anchor" href="#_grpc_demo_with_istio"></a>12.3. gRPC demo with Istio</h3>
<div class="paragraph">
<p>You are going to test the same scenario but now using Istio. First, deploy the gRPC services and the ingress <em>Route</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo-istio.yaml \
    -p ACCOUNT_ROUTE="${OCP_GRPCDEMO_HOST}" -n ${OCP_NAMESPACE} \
    | oc apply -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo-route-istio.yaml \
    -p GRPC_ROUTE_NAME="${OCP_USER}-grpc" -p GRPC_ROUTE="${OCP_GRPCDEMO_HOST}" \
    -n ${OCP_NAMESPACE} \
    | oc apply -n istio-system -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a few seconds and make sure all services are ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">gRPC demo services ready</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/logrpc_ready_istiogin.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_ready_istio.png" alt="grpc ready istio"></a></span></p>
</div>
<div class="paragraph">
<p>Scale <em>user</em> service to 2 replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc scale --replicas=2 deployment/user-v1.0.0 -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until all replicas are ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">user service with two replicas</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_ready_replicas_istio.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_ready_replicas_istio.png" alt="grpc ready replicas istio"></a></span></p>
</div>
<div class="paragraph">
<p>Now, simulate some traffic with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">while true; do curl -ksv -o /dev/null "https://${OCP_GRPCDEMO_HOST}/v1/account/01234" ; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the OpenShift Container Platform web console, check the logs in both <em>user</em> pods. Now you can see both replicas receiving traffic.</p>
</div>
<div class="paragraph">
<div class="title">user service logs (replica 1)</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_log1_istio.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_log1_istio.png" alt="grpc log1 istio"></a></span></p>
</div>
<div class="paragraph">
<div class="title">user service logs (replica 2)</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_log2_istio.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_log2_istio.png" alt="grpc log2 istio"></a></span></p>
</div>
<div class="paragraph">
<p>In Kiali you can check all the information about the replicas for this service:</p>
</div>
<div class="paragraph">
<div class="title">user service in Kiali</div>
<p><span class="image"><a class="image" href="../_images/03-traffic-management/grpc_kiali_replicas.png" target="_blank" rel="noopener"><img src="../_images/03-traffic-management/grpc_kiali_replicas.png" alt="grpc kiali replicas"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_remove_everything_2"><a class="anchor" href="#_remove_everything_2"></a>12.4. Remove everything</h3>
<div class="paragraph">
<p>After you have completed the lab you can remove everything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo-istio.yaml \
    -p ACCOUNT_ROUTE="${OCP_GRPCDEMO_HOST}" -n ${OCP_NAMESPACE} \
    | oc delete -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f lab9/grpc-demo-route-istio.yaml \
    -p GRPC_ROUTE_NAME="${OCP_USER}-grpc" -p GRPC_ROUTE="${OCP_GRPCDEMO_HOST}" \
    -n ${OCP_NAMESPACE} \
    | oc delete -n istio-system -f -</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../02-envoy-istio-control-plane/index.html">4. Envoy istio Control plane - Labs</a></span>
  <span class="next"><a href="../04-troubleshooting/index.html">6. Troubleshooting - Labs</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
