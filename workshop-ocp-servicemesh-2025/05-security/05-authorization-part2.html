<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 5 - Authorization: part 2 :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/05-security/05-authorization-part2.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-deploy.html">2. Deploy Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#package">Build Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#deploy">Deploy Dervice</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-introduction/index.html">3. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_2_complete_application_deployment">Lab 2 - Complete application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_3_adding_persistent_volumes">Lab 3 - Adding persistent volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_4_configuration_management">Lab 4 - Configuration management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_5_resources">Lab 5 - Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_6_liveness_and_readiness_probes">Lab 6 - Liveness and readiness probes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html">4. Envoy istio Control plane - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_4_istio_envoy_objects_relationship">Lab 4 - Istio-Envoy Objects Relationship</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_5_envoy_proxy">Lab 5 - Envoy Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_6_istio_control_plane">Lab 6 - Istio Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_7_istio_global_services">Lab 7 - Istio Global Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../03-traffic-management/index.html">5. Traffic management - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_rhossm_traffic_management_labs">{rhossm}: Traffic Management Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_1_ingress_gateways">Lab 1 - Ingress Gateways</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_2_requests_routing">Lab 2 - Requests Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_3_traffic_shifting_and_weight_balancing">Lab 3 - Traffic Shifting and Weight Balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_4_fault_injection">Lab 4 - Fault Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_5_requests_timeouts">Lab 5 - Requests Timeouts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_6_circuit_breaking">Lab 6 - Circuit Breaking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_7_mirroring_and_dark_launches">Lab 7 - Mirroring and Dark Launches</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../04-troubleshooting/index.html">6. Troubleshooting - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_4_service_mesh_ingress_traffic_flow">Lab 4 - Service Mesh Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_5_service_mesh_secure_ingress_traffic_flow">Lab 5 - Service Mesh Secure Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_6_service_mesh_secure_egress_traffic_flow">Lab 6 - Service Mesh Secure Egress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_7_troubleshooting_tools">Lab 7 - Troubleshooting Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">7. Security - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_1_setup_demo_applications">Lab 1 - Setup demo applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_2_peerauthentication">Lab 2 - PeerAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_3_authorization_part_1">Lab 3 - Authorization: part 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_4_requestauthentication">Lab 4 - RequestAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_5_authorization_part_2">Lab 5 - Authorization: part 2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../06-extensibility/index.html">8. Extensibility - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_rhossm_extensibility_labs">{rhossm}: Extensibility Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_1_envoy_filters">Lab 1 - Envoy Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_2_waes">Lab 2 - {waes}</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">WorkShop - Service Mesh on OCP 2025</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">WorkShop - Service Mesh on OCP 2025</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="05-authorization-part2.html">Lab 5 - Authorization: part 2</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/05-security/05-authorization-part2.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab 5 - Authorization: part 2</h1>
<div id="toc" class="toc">
<div id="toctitle">Authorization: part 2</div>
<ul class="sectlevel1">
<li><a href="#_extra_oauth_flow_implementation">1. Extra: OAuth flow implementation</a>
<ul class="sectlevel2">
<li><a href="#_deploy_an_oauth2_proxy_helper">1.1. Deploy an OAuth2 proxy (helper)</a></li>
</ul>
</li>
<li><a href="#_configure_requestauthentication_in_apps_ns1">2. Configure RequestAuthentication in $APPS_NS1</a></li>
<li><a href="#_limit_access_based_on_hosted_domain_claim">3. Limit access based on hosted domain claim</a></li>
<li><a href="#_limit_access_to_your_user_only">4. Limit access to your user only</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this last lab, we will first introduce one way of managing the JWT and the OAuth2 integration flow with Google&#8217;s OAuth server, so we don&#8217;t have to manually get a token.</p>
</div>
<div class="paragraph">
<p>Then, we will create a new authorization scenario that will use the <code>end-user</code> identity and different claims from the JWT.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extra_oauth_flow_implementation"><a class="anchor" href="#_extra_oauth_flow_implementation"></a>1. Extra: OAuth flow implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As mentioned in lab 4, Istio provides just an authentication and authorization mechanism for JWT, but it does not provide anything to help obtaning the JWT token.</p>
</div>
<div class="paragraph">
<p>This implementation shown in this section is <strong>just an example</strong>. In a few words, we will use an <code>ext_auth</code> type <code>EnvoyFilter</code> that will intercept every call at ingress level and forward it to an <code>oauth2-proxy</code>. that will manage the integration with Google OAuth server. It is based on <a href="https://github.com/oauth2-proxy/oauth2-proxy">oauth2-proxy</a> project, although in our case, it won&#8217;t act as a proxy, but a <strong>simple oauth helper beside our service mesh</strong>.</p>
</div>
<div class="paragraph">
<p>Next diagram shows all the interactions between all pieces involved (I have skipped the Openshift Router, so I only focus on elements once entering in the Service Mesh).</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/oauth2-flow.png" target="_blank" rel="noopener"><img src="../_images/05-security/oauth2-flow.png" alt="Oauth flow"></a></span></p>
</div>
<div class="paragraph">
<p>Another possiblity would be to implement this mechanism with a WebAssembly module (WASM). This <a href="https://github.com/dgn/oidc-filter">project</a> could be used as a good starting point.</p>
</div>
<div class="sect2">
<h3 id="_deploy_an_oauth2_proxy_helper"><a class="anchor" href="#_deploy_an_oauth2_proxy_helper"></a>1.1. Deploy an OAuth2 proxy (helper)</h3>
<div class="paragraph">
<p>Let&#8217;s now put all we have described above in practice. First, we need to deploy an <code>oauth2-proxy</code> that will be used to manage the OAuth2 workflow.</p>
</div>
<div class="paragraph">
<p>We will deploy it under our $APPS_NS1:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc process -f $LABS_HOME/lab5/oauth2-proxy.yaml -p INGRESS_GW=$INGRESS_GW -p APP_DOMAIN=$PRODUCTPAGE_HOST -p CLIENT_ID="805248467061-9nkgmsfmdu3me5d4ngiemvb1en3s550b.apps.googleusercontent.com" -p CLIENT_SECRET="-RPI_Pgs_IKn0sIkYiB_7DAn" -p COOKIE_SECRET=$(openssl rand -hex 16) -p OIDC_ISSUER_URL=https://accounts.google.com OAUTH_NS=$APPS_NS1 -n $APPS_NS1 | oc apply -f - -n $APPS_NS1

secret/oauth2-proxy created
service/oauth2-proxy created
deployment.apps/oauth2-proxy created
virtualservice.networking.istio.io/oauth2-proxy created
destinationrule.networking.istio.io/oauth2-proxy created
serviceentry.networking.istio.io/accounts-google created
serviceentry.networking.istio.io/oauth2-googleapis created</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There were some basic objects created that you are familiar to as in any regular OCP+Mesh application deployment: <code>Service</code>, <code>Deployment</code>, <code>VirtualService</code> and <code>DestinationRule</code>. Then, there are two <code>ServiceEntries</code> that have been created in order to allow access to external resources which are Google&#8217;s related. This is because we have restricted the access to any external resource from within the <code>Service Mesh</code> (as we are in the Security Workshop, we would like to have certain control to which external resources are consumed). To achieve this goal, we configured our <code>ServiceMeshControlPlane</code> with a <code>REGISTRY_ONLY</code> <code>outboutTrafficPolicy</code> <a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/">mode</a>. Feel free to have a look at the configuration and the <code>ServiceEntries</code> as well.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If may take some restarts to have the application running since the <code>oauth2-proxy</code> container tries to load the OIDC configuration from an external resource and the <code>istio-proxy</code> may not have started yet. Finally, you should see a similar output on the <code>oauth2-proxy</code> contatiner within the pod:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[2021/04/03 20:49:58] [proxy.go:59] mapping path "/" =&gt; static response 200
[2021/04/03 20:49:58] [oauthproxy.go:137] OAuthProxy configured for OpenID Connect Client ID: 805248467061-9nkgmsfmdu3me5d4ngiemvb1en3s550b.apps.googleusercontent.com
[2021/04/03 20:49:58] [oauthproxy.go:143] Cookie settings: name:_oauth2_proxy_dsanchor-ingress secure(https):true httponly:true expiry:4h0m0s domains: path:/ samesite:lax refresh:after 30m0s
[2021/04/03 20:49:58] [http.go:57] HTTP: listening on 0.0.0.0:4180</pre>
</div>
</div>
<div class="paragraph">
<p>Then, we will configure an <code>EnvoyFilter</code> on our dedicated ingress <code>Gateway</code> that will intercept every call entering the mesh. We will use an <code>ext_authz</code> filter. Run the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc process -f $LABS_HOME/lab5/oauth2-envoy-filter.yaml -p INGRESS_GW=$INGRESS_GW -p OAUTH_NS=$APPS_NS1 -n istio-system | oc apply -f - -n istio-system

envoyfilter.networking.istio.io/dsanchor-ingress created</pre>
</div>
</div>
<div class="paragraph">
<p>Test the application now.</p>
</div>
<div class="paragraph">
<p>You will first be redirected to select your gmail account:</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/google-account-selection.png" target="_blank" rel="noopener"><img src="../_images/05-security/google-account-selection.png" alt="Google account selection"></a></span></p>
</div>
<div class="paragraph">
<p>And once you have selected your preferred account, you will land into the bookinfo application.</p>
</div>
<div class="paragraph">
<p>Just to mention, any google account would be valid for this test&#8230;&#8203; you can try if you have different ones (Ex: @gmail or your corporate account).</p>
</div>
<div class="paragraph">
<p>We will add some more specific <code>AuthorizationPolicies</code> now.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_requestauthentication_in_apps_ns1"><a class="anchor" href="#_configure_requestauthentication_in_apps_ns1"></a>2. Configure RequestAuthentication in $APPS_NS1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First step before creating any <code>AuthorizationPolicy</code> that uses any related data/attribute from the JWT token is to set a <code>RequestAuthentication</code> that would cover the scope of the workload (For instance, we already did it for the dedicated ingress <code>Gateway</code>).</p>
</div>
<div class="paragraph">
<p>We will now create a namespace-wide <code>RequestAuthentication</code> for $APPS_NS1 namespace. Run the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc process -f $LABS_HOME/lab5/apps-ns-request-authentication.yaml -p APPS_NS=$APPS_NS1 OIDC_ISSUER_URL=https://accounts.google.com OIDC_JWKS_URI=https://www.googleapis.com/oauth2/v3/certs -n $APPS_NS1  | oc apply -f - -n $APPS_NS1

requestauthentication.security.istio.io/dsanchor-1-request-authentication created</pre>
</div>
</div>
<div class="paragraph">
<p>As any other resource we create on the cluster, I encourage you to have a look at what you have exactly created. For instance, this time you could run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get requestauthentication.security.istio.io/$APPS_NS1-request-authentication -o yaml -n $APPS_NS1

apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: dsanchor-1-request-authentication
  namespace: dsanchor-1
spec:
  jwtRules:
  - forwardOriginalToken: true
    issuer: https://accounts.google.com
    jwksUri: https://www.googleapis.com/oauth2/v3/certs</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_limit_access_based_on_hosted_domain_claim"><a class="anchor" href="#_limit_access_based_on_hosted_domain_claim"></a>3. Limit access based on hosted domain claim</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the claims that could be used to limit access to certain resources could be the <code>hosted domain</code> or <code>hd</code>.</p>
</div>
<div class="paragraph">
<p>To understand what a <code>hosted domain</code> is, please, feel free to read about it <a href="https://developers.google.com/identity/protocols/oauth2/openid-connect#hd-param">here</a>.</p>
</div>
<div class="paragraph">
<p>Also, let&#8217;s put the <code>rbac</code> log level to <code>debug</code> on your dedicated ingress <code>Gateway</code>, so we will be able to see all the info we get from the JWT (and all the claims that can be used as a <code>rule condition</code>, such as the <code>hd</code>):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc exec -n istio-system $(oc get pods -n istio-system  -o name  | grep $INGRESS_GW) -c istio-proxy -- curl -X POST localhost:15000/logging?rbac=debug</pre>
</div>
</div>
<div class="paragraph">
<p>And now, run some tests again your application and check the logs from your dedicated ingress <code>Gateway</code>. What claims do you see for your user? What&#8217;s the hd you see from your user?</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Try to find the <code>request.auth.claims</code> attribute in logs. And there, you should find an <code>hd</code> attribute. An example of an <code>hd</code> would be <code>redhat.com</code> for email addresses like <a href="mailto:dsanchor@redhat.com">dsanchor@redhat.com</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>hd</code> is hihgly dependant on the user account you have choosen. For instance, if you chose an <code>@gmail</code> you won&#8217;t see any <code>hd</code>. Instead, use your corporate account to get a valid <code>hd</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you already logged in with an @gmail.com account or you want to log with a different account, use the <a href="https://${PRODUCTPAGE_HOST}/oauth2/start" class="bare">https://${PRODUCTPAGE_HOST}/oauth2/start</a> to trigger a new login process.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can see the logs by executing the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc logs -f -n istio-system $(oc get pods -n istio-system  -o name  | grep $INGRESS_GW)</pre>
</div>
</div>
<div class="paragraph">
<p>We will use the <code>hd</code> we have just discovered to create a new <code>AuthorizationPolicy</code> (<strong>now on, we will use $HD to refer it, export it</strong>):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc process -f $LABS_HOME/lab5/hd-policy.yaml -p HD=$HD -n $APPS_NS1 | oc apply -f - -n $APPS_NS1

authorizationpolicy.security.istio.io/productpage-hd created</pre>
</div>
</div>
<div class="paragraph">
<p>Test first with a user/account that belongs to that <code>hosted domain</code>.</p>
</div>
<div class="paragraph">
<p>Once you have verified that it works, try using a different account that does not belong to that <code>hosted domain</code> (for instance, a @gmail.com account). It should not have access to the bookinfo application.</p>
</div>
<div class="paragraph">
<p>Also, feel free to share your $PRODUCTPAGE_HOST with a colleague and let him test the application with his own account (which belongs to your same <code>hosted domain</code>). It should also work.</p>
</div>
<div class="paragraph">
<p>Finally, remove the policy we just created to avoid conflicts in next lab:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc delete authorizationpolicy.security.istio.io/productpage-hd -n $APPS_NS1

authorizationpolicy.security.istio.io "productpage-hd" deleted</pre>
</div>
</div>
<div class="paragraph">
<p>As summary of this lab, we just learnt how to limit access to our services for a given corporation or hosted domain users.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_limit_access_to_your_user_only"><a class="anchor" href="#_limit_access_to_your_user_only"></a>4. Limit access to your user only</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this last lab, we will limit access to the application to only your user account.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s get your user account, so we can set it as a valid <code>requestPrincipal</code>. To obtain it, check your dedicated ingress <code>Gateway</code> logs and try to find the <code>request.auth.principal</code> attribute. Just one tip, it will be similar to this example: <a href="https://accounts.google.com/104396212601495701298" class="bare">https://accounts.google.com/104396212601495701298</a>.</p>
</div>
<div class="paragraph">
<p><strong>Assign the value of  <code>request.auth.principal</code> to the $USER_ACCOUNT variable</strong> that will be used next.</p>
</div>
<div class="paragraph">
<p>See how your new policy will look like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc process -f $LABS_HOME/lab5/request-principal-policy.yaml -p USER_ACCOUNT=$USER_ACCOUNT -o yaml -n $APPS_NS1
...
...
(just focus on the spec part of the object)
  spec:
    rules:
    - from:
      - source:
          requestPrincipals:
          - https://accounts.google.com/104396212601495701298
    selector:
      matchLabels:
        app: productpage</pre>
</div>
</div>
<div class="paragraph">
<p>Create the policy then:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc process -f $LABS_HOME/lab5/request-principal-policy.yaml -p USER_ACCOUNT=$USER_ACCOUNT -n $APPS_NS1 | oc apply -f - -n $APPS_NS1

authorizationpolicy.security.istio.io/productpage-request-principal created</pre>
</div>
</div>
<div class="paragraph">
<p>Test the application again using the account you have choosen as $USER_ACCOUNT.</p>
</div>
<div class="paragraph">
<p>Then, ask your colleague again to test your application under your $PRODUCTPAGE_HOST. This time, he won&#8217;t be able to access it.</p>
</div>
<div class="paragraph">
<p>We just have given access to a certain user. Feel free to add more users to the list of requestPrincipals (for instance, the one from your colleague and let him test your application).</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
