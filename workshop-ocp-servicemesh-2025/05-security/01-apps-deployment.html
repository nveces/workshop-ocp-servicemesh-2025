<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 1 - Setup demo applications :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/05-security/01-apps-deployment.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
            <a class="navbar-item" href="https://atarazana.github.io/kitchensink-guide/" target="_blank">Deploying JBoss EAP applications on OpenShift</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-introduction/index.html">2. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_2_complete_application_deployment">Lab 2 - Complete application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_3_adding_persistent_volumes">Lab 3 - Adding persistent volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_4_configuration_management">Lab 4 - Configuration management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_5_resources">Lab 5 - Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_6_liveness_and_readiness_probes">Lab 6 - Liveness and readiness probes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html">3. Envoy istio Control plane - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_4_istio_envoy_objects_relationship">Lab 4 - Istio-Envoy Objects Relationship</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_5_envoy_proxy">Lab 5 - Envoy Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_6_istio_control_plane">Lab 6 - Istio Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_7_istio_global_services">Lab 7 - Istio Global Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../03-traffic-management/index.html">4. Traffic management - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_rhossm_traffic_management_labs">{rhossm}: Traffic Management Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_1_ingress_gateways">Lab 1 - Ingress Gateways</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_2_requests_routing">Lab 2 - Requests Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_3_traffic_shifting_and_weight_balancing">Lab 3 - Traffic Shifting and Weight Balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_4_fault_injection">Lab 4 - Fault Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_5_requests_timeouts">Lab 5 - Requests Timeouts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_6_circuit_breaking">Lab 6 - Circuit Breaking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_7_mirroring_and_dark_launches">Lab 7 - Mirroring and Dark Launches</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../04-troubleshooting/index.html">5. Troubleshooting - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_4_service_mesh_ingress_traffic_flow">Lab 4 - Service Mesh Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_5_service_mesh_secure_ingress_traffic_flow">Lab 5 - Service Mesh Secure Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_6_service_mesh_secure_egress_traffic_flow">Lab 6 - Service Mesh Secure Egress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_7_troubleshooting_tools">Lab 7 - Troubleshooting Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">6. Security - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_1_setup_demo_applications">Lab 1 - Setup demo applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_2_peerauthentication">Lab 2 - PeerAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_3_authorization_part_1">Lab 3 - Authorization: part 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_4_requestauthentication">Lab 4 - RequestAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_5_authorization_part_2">Lab 5 - Authorization: part 2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../06-extensibility/index.html">7. Extensibility - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_rhossm_extensibility_labs">{rhossm}: Extensibility Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_1_envoy_filters">Lab 1 - Envoy Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_2_waes">Lab 2 - {waes}</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="01-apps-deployment.html">Lab 1 - Setup demo applications</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/05-security/01-apps-deployment.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab 1 - Setup demo applications</h1>
<div id="toc" class="toc">
<div id="toctitle">Setup demo applications</div>
<ul class="sectlevel1">
<li><a href="#_deploy_services_in_apps_ns1">1. Deploy services in $APPS_NS1</a></li>
<li><a href="#_deploy_services_in_apps_ns2">2. Deploy services in $APPS_NS2</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The main goal of this lab is to quickly deploy a set of applications that will be used in the next labs. Notice that in this case, all <code>Deployments</code> are properly annotated, so the <code>istio-proxy</code> is autoinjected magically.</p>
</div>
<div class="paragraph">
<p>We will deploy the <code>bookinfo</code> app we are already familiar with, but we will do it in 2 different <code>namespaces</code> so we can then have some different scenarios to test.</p>
</div>
<div class="paragraph">
<p>The final set of application deployments will look like follows:</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/namespaces-deployments.png" target="_blank" rel="noopener"><img src="../_images/05-security/namespaces-deployments.png" alt="Apps in ns"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_services_in_apps_ns1"><a class="anchor" href="#_deploy_services_in_apps_ns1"></a>1. Deploy services in $APPS_NS1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s have all services up and running in $APPS_NS1.</p>
</div>
<div class="paragraph">
<p>We will start with <code>produtcpage</code> service. Run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/apps/productpage-v1.yaml -n $APPS_NS1

service/productpage created
deployment.apps/productpage-v1 created
serviceaccount/bookinfo-productpage created</pre>
</div>
</div>
<div class="paragraph">
<p>One thing that is important during these labs, mainly for the <code>authorization</code> part, is the <code>ServiceAccount</code>. In the above command output, notice:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>serviceaccount/bookinfo-productpage created</pre>
</div>
</div>
<div class="paragraph">
<p>This <code>serviceaccount/bookinfo-productpage</code> will be used to run the <code>productpage pods</code>,  so every application will run using different <code>ServiceAccounts</code> and that would mean different identities, as will see later.</p>
</div>
<div class="paragraph">
<p>To verify the above, check that within the <code>deployment.apps/productpage-v1</code> we have set the <code>serviceAccount</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get deployment.apps/productpage-v1 -n $APPS_NS1 -o yaml | grep "serviceAccount: bookinfo-productpage"

      serviceAccount: bookinfo-productpage</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In regular deployments, if serviceAccount field is not set, pods will run with the <code>default</code> ServiceAccount, which is pre-created for us when creating new projects/namespaces.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s continue with <code>details</code> service:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/apps/details-v1.yaml -n $APPS_NS1

service/details created
deployment.apps/details-v1 created
serviceaccount/bookinfo-details created</pre>
</div>
</div>
<div class="paragraph">
<p>Then, <code>reviews</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/apps/reviews-v2.yaml -n $APPS_NS1

service/reviews created
deployment.apps/reviews-v2 created
serviceaccount/bookinfo-reviews created</pre>
</div>
</div>
<div class="paragraph">
<p>And finally <code>ratings</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/apps/ratings-v1.yaml -n $APPS_NS1

service/ratings created
deployment.apps/ratings-v1 created
serviceaccount/bookinfo-ratings created</pre>
</div>
</div>
<div class="paragraph">
<p>We are almost done in <code>$APPS_NS1</code>, but before creating the <code>VirtualServices</code> and <code>DestinationRules</code> for every service, let&#8217;s check that we get all pods running with '2/2' containers:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get pods  -n $APPS_NS1

NAME                              READY   STATUS    RESTARTS   AGE
details-v1-797b75485d-7ml49       2/2     Running   0          5m25s
productpage-v1-5f6774b864-5p4ms   2/2     Running   0          10h
ratings-v1-7d48bbb9fd-znfdd       2/2     Running   0          2m32s
reviews-v2-cf45c87c7-74jbh        2/2     Running   0          3m5s</pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following commands to create the <code>VirtualServices</code> and <code>DestinationRules</code> for every service. We leave the <code>productpage</code> configuration for the end, as it is a bit special. The other services will have a simple <code>VirtualService`that reference a single subset defined in the `DestinationRule</code>. Run the following for <code>details</code> service:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/istio/details-v1.yaml -n $APPS_NS1

virtualservice.networking.istio.io/details created
destinationrule.networking.istio.io/details created</pre>
</div>
</div>
<div class="paragraph">
<p>Feel free to check the content of both <code>VirtualService</code> and <code>DestinationRule</code> we just created.
Then, do the same for <code>reviews</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/istio/reviews-v2.yaml -n $APPS_NS1

virtualservice.networking.istio.io/reviews created
destinationrule.networking.istio.io/reviews created</pre>
</div>
</div>
<div class="paragraph">
<p>And finally <code>ratings</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/istio/ratings-v1.yaml -n $APPS_NS1

virtualservice.networking.istio.io/ratings created
destinationrule.networking.istio.io/ratings created</pre>
</div>
</div>
<div class="paragraph">
<p>In the case of the <code>productpage</code> service, two more objects are created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>Route</code>, so the service can be externally accesible. Notice that it will be a secure route (simple <code>tls</code>) with passthrough termination. This means that the <code>tls</code> termination is not performed at the router side but the ingress gateway instead.</p>
</li>
<li>
<p>an ingress <code>Gateway</code>, that will use an specific <code>selector</code> so the configuration will be applied on your $INGRESS_GW (in previous labs/workshops, we all shared the same gateway pods, but in these labs, we will have an specific gateway deployment per user). There is also some <code>tls</code> config set to include a pre-created set of certificates for this labs (under <code>apps-credential Secret</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To double check and understand what we just described above, run the following command and inspect the output YAML (try to see all details from the <code>Route</code> and <code>Gateway</code>):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc process -f $LABS_HOME/lab1/istio/productpage-v1.yaml -p PRODUCTPAGE_HOST=$PRODUCTPAGE_HOST -p INGRESS_GW=$INGRESS_GW -p APPS_NS=$APPS_NS1 -p MESH_NS=$SERVICE_MESH_NS -o yaml</pre>
</div>
</div>
<div class="paragraph">
<p>Once reviewed, apply the manifests:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc process -f $LABS_HOME/lab1/istio/productpage-v1.yaml -p PRODUCTPAGE_HOST=$PRODUCTPAGE_HOST -p INGRESS_GW=$INGRESS_GW -p APPS_NS=$APPS_NS1 -p MESH_NS=$SERVICE_MESH_NS -o yaml | oc apply -f -

route.route.openshift.io/dsanchor-ingress-productpage created
gateway.networking.istio.io/dsanchor-ingress-productpage created
virtualservice.networking.istio.io/productpage created
destinationrule.networking.istio.io/productpage created</pre>
</div>
</div>
<div class="paragraph">
<p>Get the accesible endpoint of the application:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get route/${INGRESS_GW}-productpage -o template='http://{{.spec.host}}' -n istio-system

http://productpage-dsanchor-1.apps.labs.sandbox671.opentlc.com</pre>
</div>
</div>
<div class="paragraph">
<p>Test the application in your <code>Web browser</code>. You will be redirected to an <code>https</code> url and warned about the self-signed certificate we have configured:</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/self-signed-cert.png" target="_blank" rel="noopener"><img src="../_images/05-security/self-signed-cert.png" alt="Self signed cert"></a></span></p>
</div>
<div class="paragraph">
<p>Accept the risk ;-) and you will land in the following page:</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/landing-page.png" target="_blank" rel="noopener"><img src="../_images/05-security/landing-page.png" alt="Landing page"></a></span></p>
</div>
<div class="paragraph">
<p>Click on <code>Access to productpage</code> link (bottom left of the page) and voila:</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/productpage.png" target="_blank" rel="noopener"><img src="../_images/05-security/productpage.png" alt="Productpage"></a></span></p>
</div>
<div class="paragraph">
<p>Keep a test running on the background to generate telemetry (don&#8217;t forget to use your domain in the url):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>watch -n1 curl -k https://${PRODUCTPAGE_HOST}/productpage</pre>
</div>
</div>
<div class="paragraph">
<p>If you check then the graph in <code>Kiali</code>, you should get a similar flow:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><a class="image" href="../_images/05-security/first-graph.gif" target="_blank" rel="noopener"><img src="05-security/first-graph.gif" alt="First graph"></a></span></p>
</div>
<div class="paragraph">
<p>Notice the starting node in the graph&#8230;&#8203; it should be your dedicated ingress gateway.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_services_in_apps_ns2"><a class="anchor" href="#_deploy_services_in_apps_ns2"></a>2. Deploy services in $APPS_NS2</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For a different scenario that will be later introduced, we will deploy just the <code>reviews</code> and <code>ratings</code> service in $APPS_NS2.</p>
</div>
<div class="paragraph">
<p>Deploy <code>reviews-v3</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/apps/reviews-v3.yaml -n $APPS_NS2

service/reviews created
deployment.apps/reviews-v3 created
serviceaccount/bookinfo-reviews created</pre>
</div>
</div>
<div class="paragraph">
<p>And then <code>ratings-v1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/apps/ratings-v1.yaml -n $APPS_NS2

service/ratings created
deployment.apps/ratings-v1 created
serviceaccount/bookinfo-ratings created</pre>
</div>
</div>
<div class="paragraph">
<p>Create the specific set of <code>VirtualServices</code> and <code>DestinationRules</code>:</p>
</div>
<div class="paragraph">
<p>For <code>reviews</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/istio/reviews-v3.yaml -n $APPS_NS2

virtualservice.networking.istio.io/reviews created
destinationrule.networking.istio.io/reviews created</pre>
</div>
</div>
<div class="paragraph">
<p>For <code>ratings</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/istio/ratings-v1.yaml -n $APPS_NS2

virtualservice.networking.istio.io/ratings created
destinationrule.networking.istio.io/ratings created</pre>
</div>
</div>
<div class="paragraph">
<p>So far, we just deployed and configured some services in $APPS_NS2, but these are not yet accesible. The current request flow looks like:</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/apps-ns1-workflow.png" target="_blank" rel="noopener"><img src="../_images/05-security/apps-ns1-workflow.png" alt="Apps ns1 workflow"></a></span></p>
</div>
<div class="paragraph">
<p>But in some scenarios during these labs, we want to make use of the services we have deployed on $APPS_NS2 as in next diagram:</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/apps-ns2-workflow.png" target="_blank" rel="noopener"><img src="../_images/05-security/apps-ns2-workflow.png" alt="Apps ns2 workflow"></a></span></p>
</div>
<div class="paragraph">
<p>In order to achieve this, we will have to set certain <code>env variable</code> in <code>productpage</code> to target to a different <code>reviews</code> service than the default one (same namespace). Execute the following to configure the <code>reviews</code> service in $APPS_NS2 as target service:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc set env deployment/productpage-v1 -e REVIEWS_HOSTNAME=reviews.$APPS_NS2.svc.cluster.local -n $APPS_NS1

deployment.apps/productpage-v1 updated</pre>
</div>
</div>
<div class="paragraph">
<p>A rollout of <code>productpage`is triggered and then, test the service again. You should get the `ratings</code> with red stars:</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/05-security/ratings-ns2.png" target="_blank" rel="noopener"><img src="../_images/05-security/ratings-ns2.png" alt="Ratings from ns2"></a></span></p>
</div>
<div class="paragraph">
<p>And if you keep sending requests.. you would get the following graph (notice that we jump from <code>productpage</code> in your $APPS_NS1 to <code>reviews</code> in your $APPS_NS2):</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><a class="image" href="../_images/05-security/graph-with-ns2.gif" target="_blank" rel="noopener"><img src="05-security/graph-with-ns2.gif" alt="Graph with ns2"></a></span></p>
</div>
<div class="paragraph">
<p>Once tested, we will move back to default, as we will start from the first scenario, where all services run in $APPS_NS1.</p>
</div>
<div class="paragraph">
<p>Execute the following to move back to default <code>reviews</code> service, which runs in same <code>namespace</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc set env deployment/productpage-v1 -e REVIEWS_HOSTNAME=reviews -n $APPS_NS1

deployment.apps/productpage-v1 updated</pre>
</div>
</div>
<div class="paragraph">
<p>It is time to start securing our services calls as in this lab, we have just deployed all services and securely exposed externally (simple tls) but we did nothing about this within the mesh (so internal calls still are not secured with tls/mtls).</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
