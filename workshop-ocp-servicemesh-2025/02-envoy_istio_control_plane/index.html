<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Red Hat Service Mesh: Envoy &amp; Istio Control Plane Tutorial :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/02-envoy_istio_control_plane/index.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-deploy.html">2. Deploy Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#package">Build Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#deploy">Deploy Dervice</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#introduction/index.adoc">3. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#introduction/index.adoc#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#introduction/index.adoc#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">WorkShop - Service Mesh on OCP 2025</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">WorkShop - Service Mesh on OCP 2025</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="index.html">Red Hat Service Mesh: Envoy &amp; Istio Control Plane Tutorial</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/02-envoy_istio_control_plane/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Red Hat Service Mesh: Envoy &amp; Istio Control Plane Tutorial</h1>
<div id="toc" class="toc">
<div id="toctitle">Envoy &amp; Istio Control Plane Tutorial</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_lab_1_setup">Lab 1 - Setup</a>
<ul class="sectlevel1">
<li><a href="#prerequisites">1. Prerequisites</a></li>
<li><a href="#laboratory">2. Laboratory</a>
<ul class="sectlevel2">
<li><a href="#_laboratory_parameters">2.1. Laboratory Parameters</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
<ul class="sectlevel1">
<li><a href="#_deploy_jump_app_microservices">1. Deploy <em>Jump App</em> Microservices</a>
<ul class="sectlevel2">
<li><a href="#login">1.1. Login in Openshift</a></li>
<li><a href="#github">1.2. Clone GitHub Repository</a></li>
<li><a href="#jumpappobjects">1.3. Create <em>Jump App</em> Objects in Openshift</a></li>
<li><a href="#test">1.4. Confirm <em>Jump App</em> is already running in Openshift</a></li>
<li><a href="#testapp">1.5. Access to <em>Jump App</em></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
<ul class="sectlevel1">
<li><a href="#create">1. Create Red Hat Service Mesh Traffic Flow objects</a>
<ul class="sectlevel2">
<li><a href="#gw">1.1. Gateways</a></li>
<li><a href="#vsvc">1.2. Virtual Services</a></li>
<li><a href="#dr">1.3. Destination Rules</a></li>
<li><a href="#services">1.4. K8s Services</a></li>
</ul>
</li>
<li><a href="#memberrol">2. Adding a new project to Red Hat Service Mesh Control Plane</a></li>
<li><a href="#finalsteps">3. Final Steps</a>
<ul class="sectlevel2">
<li><a href="#annotation">3.1. Add <em>Istio Sidecar</em> annotation in <em>Jump App</em> deployments</a></li>
<li><a href="#routes">3.2. Configure Routes</a></li>
<li><a href="#03test">3.3. Confirm <em>Jump App</em> is running again</a></li>
<li><a href="#kiali">3.4. Visit Kiali</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_4_istio_envoy_objects_relationship">Lab 4 - Istio-Envoy Objects Relationship</a>
<ul class="sectlevel1">
<li><a href="#previous">1. Create a new microservice version</a></li>
<li><a href="#reviewing">2. Review Red Hat Service Mesh objects</a>
<ul class="sectlevel2">
<li><a href="#04dr">2.1. Destination Rules</a></li>
<li><a href="#04vsvc">2.2. Virtual Services</a></li>
<li><a href="#se">2.3. Service Entry</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_5_envoy_proxy">Lab 5 - Envoy Proxy</a>
<ul class="sectlevel1">
<li><a href="#_review_envoy_proxy_through_envoy_filters">1. Review Envoy Proxy through Envoy Filters</a>
<ul class="sectlevel2">
<li><a href="#ef">1.1. Envoy Filter</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_6_istio_control_plane">Lab 6 - Istio Control Plane</a>
<ul class="sectlevel1">
<li><a href="#review">1. Review consequences of adding a new project to Istio Control Plane</a>
<ul class="sectlevel2">
<li><a href="#smr">1.1. Create <em>ServiceMeshMember</em> Object</a></li>
<li><a href="#np">1.2. Review Network Policies Created</a></li>
</ul>
</li>
<li><a href="#06test">2. Test <em>Jump App</em></a>
<ul class="sectlevel2">
<li><a href="#up">2.1. Confirm <em>Jump App</em> is running again</a></li>
<li><a href="#06kiali">2.2. Visit Kiali</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_7_istio_global_services">Lab 7 - Istio Global Services</a>
<ul class="sectlevel1">
<li><a href="#secure">1. Secure Gateways</a>
<ul class="sectlevel2">
<li><a href="#cert">1.1. Generate a Custom Certificate</a></li>
<li><a href="#addcert">1.2. Create in Istio the Custom Certificate using SDS</a></li>
<li><a href="#07gw">1.3. Configure Gateway</a></li>
<li><a href="#route">1.4. Modify Route</a></li>
<li><a href="#07test">1.5. Test HTTPS connections</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="imageblock unresolved">
<div class="content">
<img src="logos.png" alt="logos">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The general idea of <em>Red Hat Service Mesh: Envoy &amp; Istio Control Plane</em> tutorial is to get a deep understanding of the following points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Service Mesh Communication Flows</p>
</li>
<li>
<p>Istio-Envoy Objects Relationship</p>
</li>
<li>
<p>Envoy Proxy</p>
</li>
<li>
<p>Istio Control Plane Objects</p>
</li>
<li>
<p>Istio Global Services</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_lab_1_setup" class="sect0"><a class="anchor" href="#_lab_1_setup"></a>Lab 1 - Setup</h1>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>1. Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During this tutorial, it will be required to work with different tools for running the exercises included. Please, install the following software:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/01-setup.adoc - include::partials/requirements.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="laboratory"><a class="anchor" href="#laboratory"></a>2. Laboratory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tutorial&#8217;s laboratory is basically based on the following technologies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Red Hat Openshift Container Platform Cluster</p>
</li>
<li>
<p>Red Hat Service Mesh based on <em>Istio</em> &amp; <em>Envoy</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, a GitHub repository is provided with a set of templates and other resources which are required to create different objects in Openshift during this tutorial.</p>
</div>
<div class="paragraph">
<p>The previous technologies and resources will allow you to implement a microservice-based application in Openshift which will be included in Service Mesh. The main objective of deploying this application in Openshift using Service Mesh is to understand how <em>Istio</em> &amp; <em>Envoy</em> are tightly related.</p>
</div>
<div class="sect2">
<h3 id="_laboratory_parameters"><a class="anchor" href="#_laboratory_parameters"></a>2.1. Laboratory Parameters</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/01-setup.adoc - include::partials/access_lab.adoc[]</p>
</div>
</div>
</div>
</div>
<h1 id="_lab_2_deploy_jump_app" class="sect0"><a class="anchor" href="#_lab_2_deploy_jump_app"></a>Lab 2 - Deploy Jump App</h1>
<div class="sect1">
<h2 id="_deploy_jump_app_microservices"><a class="anchor" href="#_deploy_jump_app_microservices"></a>1. Deploy <em>Jump App</em> Microservices</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Jump App</em> is a microservice-based application created to emulate an enterprise application complex architecture with multi environments. This app allows users to configure a set of jumps between components and generate a continuous traffic flow defining the number of retries and their span of time.</p>
</div>
<div class="paragraph">
<p>First of all, it is required to deploy Jump App application in Openshift in order to have the demo application environment ready. The following steps in this section helps you to deploy <em>Jump App</em>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please, replace <strong>&lt;user&gt;</strong>, <strong>&lt;pass&gt;</strong>, <strong>&lt;ocp_cluster_console&gt;</strong> and <strong>&lt;user_namespace&gt;</strong> with the values provided by the Instructor at the beginning of this tutorial or values obtained from openshift cluster.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="login"><a class="anchor" href="#login"></a>1.1. Login in Openshift</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/02-jumpapp.adoc - include::partials/oc_login.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="github"><a class="anchor" href="#github"></a>1.2. Clone GitHub Repository</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/02-jumpapp.adoc - include::partials/clone_github_repo.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="jumpappobjects"><a class="anchor" href="#jumpappobjects"></a>1.3. Create <em>Jump App</em> Objects in Openshift</h3>
<div class="paragraph">
<p>First of all, it is required to modify <em>params.env</em> file to include the parameters provided by the Instructor:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vi params.env</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 1. params file content</div>
<div class="content">
<div class="paragraph">
<p>USER_NAMESPACE=user1<br>
OCP_APPS_DOMAIN=apps.tutorialrhmesh.sandbox507.opentlc.com</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the params file is saved, you are able to process with <em>Jump App</em> deployment phase:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project &lt;user_namespace&gt;
oc process -f ./02-jump-app-deploy/jump-app-template.yml --param-file=./params.env --ignore-unknown-parameters | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Deployed</div>
<p><span class="image unresolved"><img src="jump_app_created.png" alt="jump app created"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="test"><a class="anchor" href="#test"></a>1.4. Confirm <em>Jump App</em> is already running in Openshift</h3>
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been created in Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/02-jumpapp.adoc - include::partials/check_jumpapp.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="testapp"><a class="anchor" href="#testapp"></a>1.5. Access to <em>Jump App</em></h3>
<div class="paragraph">
<p>Once <em>Jump App</em> is already running in Openshift, it is time to access <em>Jump App</em> public services in order to test the application:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/02-jumpapp.adoc - include::partials/check_jumpapp_service.adoc[]</p>
</div>
</div>
</div>
</div>
<h1 id="_lab_3_service_mesh_communication_flows" class="sect0"><a class="anchor" href="#_lab_3_service_mesh_communication_flows"></a>Lab 3 - Service Mesh Communication Flows</h1>
<div class="sect1">
<h2 id="create"><a class="anchor" href="#create"></a>1. Create Red Hat Service Mesh Traffic Flow objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to make an application available through Service Mesh, it is required to create a set of Service Mesh objects related to the traffic flow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gateways - Describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections (Please, visit this link <a href="https://istio.io/v1.6/docs/concepts/traffic-management/#gateways">Gateways</a> for more information about <em>gateways</em>)</p>
</li>
<li>
<p>Virtual Services - Defines a set of traffic routing rules to apply when a host is addressed (Please, visit this link <a href="https://istio.io/v1.6/docs/concepts/traffic-management/#virtual-services">Virtual Services</a> for more information about <em>virtual services</em>)</p>
</li>
<li>
<p>Destination Rules - Defines policies that apply to traffic intended for a service after routing has occurred (Please, visit this link <a href="https://istio.io/v1.6/docs/concepts/traffic-management/#destination-rules">Destination Rules</a> for more information about <em>destination rules</em>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this step, you have to be able to deploy this <em>Jump App</em> Service Mesh objects in order to introduce this application in the Service Mesh and publish it to external clients.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please, replace <strong>&lt;user_namespace&gt;</strong> with the value provided by the Instructor at the beginning of this tutorial.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="gw"><a class="anchor" href="#gw"></a>1.1. Gateways</h3>
<div class="paragraph">
<p>First of all, it is required to create a Gateway for external access. In the <em>Jump App</em> architecture, you have a couple of services which have to be exposes to external clients in order to present the Frontend and Backend services.</p>
</div>
<div class="paragraph">
<p>Please, return to git repository and create <strong>gateways</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/03-flows.adoc - include::partials/oc_process_apply.adoc[]</p>
</div>
<div class="paragraph">
<div class="title">Gateways Created</div>
<p><span class="image unresolved"><img src="jump-app-gws-ok.png" alt="jump app gws ok"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="vsvc"><a class="anchor" href="#vsvc"></a>1.2. Virtual Services</h3>
<div class="paragraph">
<p>Once gateways are created and the application is reacheabled, it is time to create the traffic rules inside your namespace in order to route this traffic to the specific endpoint.</p>
</div>
<div class="paragraph">
<p>Please, create new <strong>virtual services</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/03-flows.adoc - include::partials/oc_process_apply.adoc[]</p>
</div>
<div class="paragraph">
<div class="title">Virtual Services Created</div>
<p><span class="image unresolved"><img src="jump-app-vss-ok.png" alt="jump app vss ok"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="dr"><a class="anchor" href="#dr"></a>1.3. Destination Rules</h3>
<div class="paragraph">
<p>Once previous objects are created, it is required  to define the policies which will be applied to traffic intended for a service after routing has occurred.</p>
</div>
<div class="paragraph">
<p>Please, create new <strong>destination rules</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/03-flows.adoc - include::partials/oc_process_apply.adoc[]</p>
</div>
<div class="paragraph">
<div class="title">Destination Rules Created</div>
<p><span class="image unresolved"><img src="jump-app-drs-ok.png" alt="jump app drs ok"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="services"><a class="anchor" href="#services"></a>1.4. K8s Services</h3>
<div class="paragraph">
<p>Once you have created gateways, virtual services and destination rules, it is time to include a specific annotation in your app deployments in order to allow Service Mesh control and run the respective envoy sidecar automatically.</p>
</div>
<div class="paragraph">
<p>Please, create new <strong>k8s services</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/03-flows.adoc - include::partials/oc_process_apply.adoc[]</p>
</div>
<div class="paragraph">
<div class="title">k8s Services Created</div>
<p><span class="image unresolved"><img src="jump-app-svcs-ok.png" alt="jump app svcs ok"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="memberrol"><a class="anchor" href="#memberrol"></a>2. Adding a new project to Red Hat Service Mesh Control Plane</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The ServiceMeshMemberRoll lists the projects belonging to the control plane. Only projects listed in the ServiceMeshMemberRoll are affected by the control plane.</p>
</div>
<div class="paragraph">
<p>In order to add this new project to the Service Mesh and make possible the traffic between each microservice, it is required to modify the ServiceMeshMemberRoll <strong>default</strong> object at this moment.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Let the Instructor know that you are at this point
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this moment, you are not able to access to <em>Jump App</em> because of a set of required tasks which you have to perform next.</p>
</div>
<div class="paragraph">
<div class="title">Frontend KO</div>
<p><span class="image unresolved"><img src="jump-app-front-ko.png" alt="jump app front ko"></span></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are an advanced user and can not wait for the instructor, please visit <a href="#06-crtlplane.adoc#smr" class="xref unresolved">6.1.1 Create <em>ServiceMeshMember</em> Object</a> and follow the instructions included there and go back again.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="finalsteps"><a class="anchor" href="#finalsteps"></a>3. Final Steps</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="annotation"><a class="anchor" href="#annotation"></a>3.1. Add <em>Istio Sidecar</em> annotation in <em>Jump App</em> deployments</h3>
<div class="paragraph">
<p>Once traffic flow objects are created and your namespace is included as member in the Service Mesh Control Plane, it is time to include a specific annotation in your app deployments in order to allow Service Mesh control and run the respective envoy sidecar automatically.</p>
</div>
<div class="paragraph">
<p>Please, edit each <em>Jump App Microservice</em> deployment executing the commands added below:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment front-javascript-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Front Patched</div>
<p><span class="image unresolved"><img src="jump-app-front-depl-patch.png" alt="jump app front depl patch"></span></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment back-springboot-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Back Springboot Patched</div>
<p><span class="image unresolved"><img src="jump-app-back-spb-depl-patch.png" alt="jump app back spb depl patch"></span></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment back-python-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Back Python Patched</div>
<p><span class="image unresolved"><img src="jump-app-back-py-depl-patch.png" alt="jump app back py depl patch"></span></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment back-golang-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Back Golang Patched</div>
<p><span class="image unresolved"><img src="jump-app-back-go-depl-patch.png" alt="jump app back go depl patch"></span></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment mongo -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">MongoDB Patched</div>
<p><span class="image unresolved"><img src="jump-app-back-mg-depl-patch.png" alt="jump app back mg depl patch"></span></p>
</div>
<div class="paragraph">
<p>Before continuing with the following steps, please test Jump App <em>pods</em> status, in order to be sure that 2 replicas are running for each microservice:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/03-flows.adoc - include::partials/chec_jumpapp_mesh_pod.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="routes"><a class="anchor" href="#routes"></a>3.2. Configure Routes</h3>
<div class="paragraph">
<p>An OpenShift Container Platform <strong>route</strong> exposes a service at a host name, such as www.example.com, so that external clients can reach it by name. When you manage routes outside Service Mesh, it is required to create these objects in each namespace.</p>
</div>
<div class="paragraph">
<p>Once you have a project integrated in Service Mesh, routes should be created in istio-system, or wherever the control plane is installed, to make this external service available through the Istio Ingress Gateway. For this reason, it is required to follow the next steps:</p>
</div>
<div class="sect3">
<h4 id="_delete_all_current_routes_in_user_namespace"><a class="anchor" href="#_delete_all_current_routes_in_user_namespace"></a>3.2.1. <strong>Delete all current routes in &lt;user_namespace&gt;</strong></h4>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n &lt;user_namespace&gt; | grep -v NAME | awk '{print "oc delete route " $1}' | sh</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes Deleted</div>
<p><span class="image unresolved"><img src="jump-app-route-del.png" alt="jump app route del"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_new_routes_in_istio_system"><a class="anchor" href="#_create_a_new_routes_in_istio_system"></a>3.2.2. <strong>Create a new routes in istio-system</strong></h4>
<div class="paragraph">
<p>Once "regular" routes are deleted, it is required to create the new ones.</p>
</div>
<div class="paragraph">
<p>Please, create new <strong>routes</strong> in <strong>istio-system</strong> namespace through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc process -f 03-jump-app-flows/04-jump-app-routes.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Mesh Routes Created</div>
<p><span class="image unresolved"><img src="jump-app-routes-mesh-ok.png" alt="jump app routes mesh ok"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="03test"><a class="anchor" href="#03test"></a>3.3. Confirm <em>Jump App</em> is running again</h3>
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been created in Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Look at the number of containers in each microservice, it must contains 2 container per each pod (<strong>READY 2/2</strong>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/03-flows.adoc - include::partials/check_jumpapp_mesh.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="kiali"><a class="anchor" href="#kiali"></a>3.4. Visit Kiali</h3>
<div class="paragraph">
<p>Jump App is generating traffic flow thanks to the frontend where was defined an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit Kiali console <strong>&lt;kiali_url&gt;</strong> (<em>E.g. <a href="https://kiali-istio-system.apps.tutorialrhmesh.sandbox507.opentlc.com" class="bare">https://kiali-istio-system.apps.tutorialrhmesh.sandbox507.opentlc.com</a></em>):</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image unresolved"><img src="jump-app-kiali.png" alt="jump app kiali"></span></p>
</div>
</div>
</div>
</div>
<h1 id="_lab_4_istio_envoy_objects_relationship" class="sect0"><a class="anchor" href="#_lab_4_istio_envoy_objects_relationship"></a>Lab 4 - Istio-Envoy Objects Relationship</h1>
<div class="sect1">
<h2 id="previous"><a class="anchor" href="#previous"></a>1. Create a new microservice version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First of all, it is required to create a new microservice <em>deployment</em> and a <em>service</em> objects for being able to work with different micro versions in Service Mesh.</p>
</div>
<div class="paragraph">
<p>Please, create the previous object through the respective Openshift template executing the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/04-relationship.adoc - include::partials/oc_process_apply.adoc[]</p>
</div>
<div class="paragraph">
<div class="title">New Micro Version Created</div>
<p><span class="image unresolved"><img src="jump-app-new-micro-version-ok.png" alt="jump app new micro version ok"></span></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment back-golang-v2 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Front Patched</div>
<p><span class="image unresolved"><img src="jump-app-back-golang-v2-depl-patch.png" alt="jump app back golang v2 depl patch"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reviewing"><a class="anchor" href="#reviewing"></a>2. Review Red Hat Service Mesh objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a new Service Mesh object is created in a specific namespace, a set of configuration blocks are added to Envoy proxies in order to be able to apply these rules in the mesh traffic flow.</p>
</div>
<div class="paragraph">
<p>In this step, you will review how these objects affect Envoy proxies getting their configuration from Envoy itself. In order to be able to obtain some information from pods, it is required to obtain the pods names before starting this section:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image unresolved"><img src="jump-app-pods-2-v2.png" alt="jump app pods 2 v2"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please, replace <strong>&lt;user_namespace&gt;</strong> and <strong>&lt;back-golang-pod_id&gt;</strong> with the values provided by the Instructor at the beginning of this tutorial or values obtained from openshift cluster.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="04dr"><a class="anchor" href="#04dr"></a>2.1. Destination Rules</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/04-relationship.adoc - include::partials/rel_step.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="04vsvc"><a class="anchor" href="#04vsvc"></a>2.2. Virtual Services</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/04-relationship.adoc - include::partials/rel_step.adoc[]</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Additionally, perform a GET request using <em>curl</em> in order to test out headers modification
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl -k -v <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/testing" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/testing</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">...
&lt; redirection: istio-envoy-relationship-test
...
{"code":200,"message":"/jump - Greetings from Golang!"}%</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="testvsvc"><a class="anchor" href="#testvsvc"></a>2.2.1. Test Jump App</h4>
<div class="paragraph">
<p>Once the previous objects are applied, it is time to test our services again with a multiple number of connections. For this step, please follow the next steps:</p>
</div>
<div class="paragraph">
<p>Once the Virtual Service rules are applied, visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/redirection-test</em>, route via your web browser</p>
</div>
<div class="paragraph">
<div class="title">Jump App Back Redirection</div>
<p><span class="image unresolved"><img src="jump-app-back-golang-redirect-ok.png" alt="jump app back golang redirect ok"></span></p>
</div>
<div class="paragraph">
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser. In addition, configure <strong>[ 1000 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
</div>
<div class="literalblock">
<div class="content">
<pre>...{"code":200,"message":"/jump - Greetings from Python!"}</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Front Web UI Multi Jumps</div>
<p><span class="image unresolved"><img src="jump-app-front-jumps-ok.png" alt="jump app front jumps ok"></span></p>
</div>
<div class="paragraph">
<p><strong>KIALI</strong></p>
</div>
<div class="paragraph">
<p>Jump App is generating traffic flow thanks to the frontend where was defined an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit Kiali console <strong>&lt;kiali_url&gt;</strong> (<em>E.g. <a href="https://kiali-istio-system.apps.tutorialrhmesh.sandbox507.opentlc.com" class="bare">https://kiali-istio-system.apps.tutorialrhmesh.sandbox507.opentlc.com</a></em>):</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image unresolved"><img src="jump-app-kiali-v2.png" alt="jump app kiali v2"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="se"><a class="anchor" href="#se"></a>2.3. Service Entry</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/04-relationship.adoc - include::partials/rel_step.adoc[]</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc rsh back-golang-v1-&lt;pod_id&gt;
curl -k -v <a href="https://www.google.es" class="bare">https://www.google.es</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">...
  &lt;body&gt;
    &lt;div&gt;
      &lt;h1&gt;Application is not available&lt;/h1&gt;
      &lt;p&gt;The application is currently not serving requests at this endpoint. It may not have been started or is still starting.&lt;/p&gt;

      &lt;div class="alert alert-info"&gt;
        &lt;p class="info"&gt;
          Possible reasons you are seeing this page:
        &lt;/p&gt;
        &lt;ul&gt;
          &lt;li&gt;
            &lt;strong&gt;The host doesn't exist.&lt;/strong&gt;
            Make sure the hostname was typed correctly and that a route matching this hostname exists.
          &lt;/li&gt;
          &lt;li&gt;
            &lt;strong&gt;The host exists, but doesn't have a matching path.&lt;/strong&gt;
            Check if the URL path was typed correctly and that the route was created using the desired path.
          &lt;/li&gt;
          &lt;li&gt;
            &lt;strong&gt;Route and path matches, but all pods are down.&lt;/strong&gt;
            Make sure that the resources exposed by this route (pods, services, deployment configs, etc) have at least one pod running.
          &lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that the response is generated by Openshift and not by <em>www.google.es</em>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<h1 id="_lab_5_envoy_proxy" class="sect0"><a class="anchor" href="#_lab_5_envoy_proxy"></a>Lab 5 - Envoy Proxy</h1>
<div class="sect1">
<h2 id="_review_envoy_proxy_through_envoy_filters"><a class="anchor" href="#_review_envoy_proxy_through_envoy_filters"></a>1. Review Envoy Proxy through Envoy Filters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Envoy Proxy, a <em>filter chain</em> wraps a set of match criteria, an option TLS context, a set of filters, and various other parameters. When a request is received in an Envoy Proxy, a communication flow is generated going through a set of filter chains which might can modify this request in a number of ways.</p>
</div>
<div class="paragraph">
<p>As you reviewed in the previous section, when a new Service Mesh object is created in a specific namespace, a set of configuration blocks are added to Envoy proxies in order to be able to apply these rules in the mesh traffic flow.</p>
</div>
<div class="paragraph">
<p>In this step, you will review how <em>envoy filters</em> affect Envoy traffic applying different rules based on a set of criteria.</p>
</div>
<div class="paragraph">
<p>Please, visit this link <a href="https://istio.io/v1.6/docs/reference/config/networking/envoy-filter/">Envoy Filters</a> for more information about <em>envoy filters</em>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please, replace <strong>&lt;user_namespace&gt;</strong> with the value provided by the Instructor at the beginning of this tutorial or values obtained from openshift cluster.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="ef"><a class="anchor" href="#ef"></a>1.1. Envoy Filter</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/05-envoy.adoc - include::partials/rel_step.adoc[]</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Additionally, perform a GET request using <em>curl</em> in order to test out headers modification
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl -k -v <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a></code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">...
&lt; envoy-filter-test: rh-servicemesh-crtlplane-tutorial
...
{"code":200,"message":"/jump - Greetings from Golang!"}%</code></pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="_lab_6_istio_control_plane" class="sect0"><a class="anchor" href="#_lab_6_istio_control_plane"></a>Lab 6 - Istio Control Plane</h1>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Let the Instructor know that you are at this point
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this moment, you are not able to access to <em>Jump App</em> because of a set of required tasks which you have to perform next.</p>
</div>
<div class="sect1">
<h2 id="review"><a class="anchor" href="#review"></a>1. Review consequences of adding a new project to Istio Control Plane</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Istio, the <em>ServiceMeshMemberRoll</em> lists the projects belonging to the control plane and only projects listed in the ServiceMeshMemberRoll are affected by the control plane.</p>
</div>
<div class="paragraph">
<p>When a service mesh user who doesnâ€™t have privileges would like to add members to the <em>ServiceMeshMemberRoll</em>, Istio provides an object names <em>ServiceMeshMember</em> which adds a selected project to the <em>ServiceMeshMemberRoll</em> within the control plane project that it references.</p>
</div>
<div class="paragraph">
<p>Once a new project is added to the Service Mesh Control Plane, it is automatically provided with a set of new Kubernetes objects in order to restring and control the communications flow inside this namespace by Istio.</p>
</div>
<div class="paragraph">
<p>In this step, you have to be able to add this namespace in the Service Mesh Control Plane and understand the implications of this procedure.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please, replace <strong>&lt;user_namespace&gt;</strong> with the value provided by the Instructor at the beginning of this tutorial.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="smr"><a class="anchor" href="#smr"></a>1.1. Create <em>ServiceMeshMember</em> Object</h3>
<div class="paragraph">
<p>First of all, it is required to create a new <em>ServiceMeshMember</em> object for being able to add a new project to the Service Mesh.</p>
</div>
<div class="paragraph">
<p>Please, create the previous object through the respective Openshift template executing the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/06-crtlplane.adoc - include::partials/oc_process_apply.adoc[]</p>
</div>
<div class="paragraph">
<div class="title"><em>ServiceMeshMember</em> Created</div>
<p><span class="image unresolved"><img src="jump-app-ns-smr.png" alt="jump app ns smr"></span></p>
</div>
<div class="paragraph">
<p>Additionally, you are able to check this new object through the Openshift Console:</p>
</div>
<div class="paragraph">
<div class="title"><em>ServiceMeshMember</em> Created Console- 1</div>
<p><span class="image unresolved"><img src="jump-app-ns-smr-con1.png" alt="jump app ns smr con1"></span>
.<em>ServiceMeshMember</em> Created Console - 2
<span class="image unresolved"><img src="jump-app-ns-smr-con2.png" alt="jump app ns smr con2"></span>
.<em>ServiceMeshMember</em> Created Console - 3
<span class="image unresolved"><img src="jump-app-ns-smr-con3.png" alt="jump app ns smr con3"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="np"><a class="anchor" href="#np"></a>1.2. Review Network Policies Created</h3>
<div class="paragraph">
<p>In a cluster using a Kubernetes Container Network Interface (CNI) plug-in that supports Kubernetes network policy, network isolation is controlled entirely by NetworkPolicy objects.  In OpenShift Container Platform, OpenShift SDN supports using network policy in its default network isolation mode.</p>
</div>
<div class="paragraph">
<p>By default, all pods in a project are accessible from other pods and network endpoints. However, once a new project is added to the Service Mesh Control Plane, Istio creates a set of <em>NetworkPolicy</em> objects in that project to indicate the allowed incoming connections within the mesh.</p>
</div>
<div class="paragraph">
<p>In order to display the new network policies objects, please execute the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get networkpolicies -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title"><em>NetworkPolicies</em> Created Project</div>
<p><span class="image unresolved"><img src="jump-app-ns-smr-np.png" alt="jump app ns smr np"></span></p>
</div>
<div class="paragraph">
<p>Then, you should review the first network policy in order to understand why external traffic flow is allowed through Istio Gateway to Jump App pods which are exposed by a <em>Gateway</em> Object:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get networkpolicy istio-expose-route-basic -o yaml -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title"><em>NetworkPolicies</em> Created Project</div>
<p><span class="image unresolved"><img src="jump-app-ns-smr-np-1.png" alt="jump app ns smr np 1"></span></p>
</div>
<div class="paragraph">
<p>Finally, the second network policy allows internal Service Mesh traffic through any pod included in a project inside the Service Mesh Control Plane installed in <em>istio-system</em> namespace:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get networkpolicy istio-mesh-basic -o yaml -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title"><em>NetworkPolicies</em> Created Project</div>
<p><span class="image unresolved"><img src="jump-app-ns-smr-np-2.png" alt="jump app ns smr np 2"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="06test"><a class="anchor" href="#06test"></a>2. Test <em>Jump App</em></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="up"><a class="anchor" href="#up"></a>2.1. Confirm <em>Jump App</em> is running again</h3>
<div class="paragraph">
<p>Once your project has been added to the Service Mesh Control Plane, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Look at the number of containers in each microservice, it must contains 2 container per each pod (<strong>READY 2/2</strong>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/06-crtlplane.adoc - include::partials/check_jumpapp_mesh.adoc[]</p>
</div>
</div>
<div class="sect2">
<h3 id="06kiali"><a class="anchor" href="#06kiali"></a>2.2. Visit Kiali</h3>
<div class="paragraph">
<p>Jump App is generating traffic flow thanks to the frontend where was defined an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit Kiali console <strong>&lt;kiali_url&gt;</strong> (<em>E.g. <a href="https://kiali-istio-system.apps.tutorialrhmesh.sandbox507.opentlc.com" class="bare">https://kiali-istio-system.apps.tutorialrhmesh.sandbox507.opentlc.com</a></em>):</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image unresolved"><img src="jump-app-kiali-v2.png" alt="jump app kiali v2"></span></p>
</div>
</div>
</div>
</div>
<h1 id="_lab_7_istio_global_services" class="sect0"><a class="anchor" href="#_lab_7_istio_global_services"></a>Lab 7 - Istio Global Services</h1>
<div class="sect1">
<h2 id="secure"><a class="anchor" href="#secure"></a>1. Secure Gateways</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you might know, Gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>During this step, you will review how to expose a secure HTTPS service using a Gateway, a custom certificate and Istio Secret Discovery Service (SDS).</p>
</div>
<div class="sect2">
<h3 id="cert"><a class="anchor" href="#cert"></a>1.1. Generate a Custom Certificate</h3>
<div class="paragraph">
<p>It is not required to perform any task related to generate custom certificates. These resources are included in GitHub repository.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Follow <a href="https://istio.io/v1.6/docs/tasks/traffic-management/ingress/secure-ingress/">Secure Ingress</a> for more information about generate certificates
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="addcert"><a class="anchor" href="#addcert"></a>1.2. Create in Istio the Custom Certificate using SDS</h3>
<div class="paragraph">
<p>Once the custom certificate is created, it is time to create a new secret in Openshift to save the respective files.</p>
</div>
<div class="paragraph">
<p>Please, create this new <strong>secret</strong> executing the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -n istio-system secret tls &lt;user_namespace&gt;-credential --key=./07-istio-sds/front.jumpapp.com.key --cert=./07-istio-sds/front.jumpapp.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Secret Created</div>
<p><span class="image unresolved"><img src="jump-app-secret-ok.png" alt="jump app secret ok"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="07gw"><a class="anchor" href="#07gw"></a>1.3. Configure Gateway</h3>
<div class="paragraph">
<p>If you remember, a gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>In order to serve this new certificate when you are accessing to <em>Jump App</em> frontend service, it is required to modify the respective Gateway.</p>
</div>
<div class="paragraph">
<p>Please, modify existing frontend <strong>gateway</strong> object executing the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/02-envoy_istio_control_plane/07-services.adoc - include::partials/oc_process_apply.adoc[]</p>
</div>
<div class="paragraph">
<div class="title">Front Gateway Modified</div>
<p><span class="image unresolved"><img src="jump-app-gw-ok.png" alt="jump app gw ok"></span></p>
</div>
<div class="paragraph">
<p>In order to sure our Istio Secret Discovery Service (SDS) has been configured properly, you can review the <em>istio ingress gateway</em> pod as shown the following picture:</p>
</div>
<div class="paragraph">
<div class="title">Secret Added to SDS</div>
<p><span class="image unresolved"><img src="jump-app-sds-ok.png" alt="jump app sds ok"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="route"><a class="anchor" href="#route"></a>1.4. Modify Route</h3>
<div class="paragraph">
<p>As you might remember, an OpenShift route exposes a service at a host name, such as www.example.com, so that external clients can reach it by name. By default, the Openshift Routers handle these external accesses and theirs respective protection.</p>
</div>
<div class="paragraph">
<p>Please, modify existing frontend <strong>route</strong> object executing the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc process -f 07-istio-sds/01-jump-app-front-route.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Front Route Modified</div>
<p><span class="image unresolved"><img src="jump-app-istio-route-mod-ok.png" alt="jump app istio route mod ok"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="07test"><a class="anchor" href="#07test"></a>1.5. Test HTTPS connections</h3>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image unresolved"><img src="jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Accept <em>Jump App</em> <strong>self-signed certificate</strong> located in the GitHub repository.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Self-signed Certificates Warning</div>
<p><span class="image unresolved"><img src="jump-app-front-cert-warning.png" alt="jump app front cert warning"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Review <em>Jump App</em> <strong>self-signed certificate</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Self-signed Certificates Warning</div>
<p><span class="image unresolved"><img src="jump-app-front-cert-warning-int-1.png" alt="jump app front cert warning int 1"></span></p>
</div>
<div class="paragraph">
<div class="title">Jump App Self-signed Certificates Warning</div>
<p><span class="image unresolved"><img src="jump-app-front-cert-warning-int-2.png" alt="jump app front cert warning int 2"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser. In addition, configure <strong>[ 1 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
<div class="literalblock">
<div class="content">
<pre>...{"code":200,"message":"/jump - Greetings from Python!"}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Front Web UI Multi Jumps</div>
<p><span class="image unresolved"><img src="jump-app-front-jumps-ok.png" alt="jump app front jumps ok"></span></p>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
