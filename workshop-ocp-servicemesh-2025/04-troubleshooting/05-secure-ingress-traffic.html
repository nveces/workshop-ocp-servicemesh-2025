<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 5 - Service Mesh Secure Ingress Traffic Flow :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/04-troubleshooting/05-secure-ingress-traffic.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
            <a class="navbar-item" href="https://atarazana.github.io/kitchensink-guide/" target="_blank">Deploying JBoss EAP applications on OpenShift</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-introduction/index.html">2. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_2_complete_application_deployment">Lab 2 - Complete application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_3_adding_persistent_volumes">Lab 3 - Adding persistent volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_4_configuration_management">Lab 4 - Configuration management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_5_resources">Lab 5 - Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_6_liveness_and_readiness_probes">Lab 6 - Liveness and readiness probes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html">3. Envoy istio Control plane - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_4_istio_envoy_objects_relationship">Lab 4 - Istio-Envoy Objects Relationship</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_5_envoy_proxy">Lab 5 - Envoy Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_6_istio_control_plane">Lab 6 - Istio Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_7_istio_global_services">Lab 7 - Istio Global Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../03-traffic-management/index.html">4. Traffic management - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_rhossm_traffic_management_labs">Red Hat OpenShift Service Mesh: Traffic Management Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_1_ingress_gateways">Lab 1 - Ingress Gateways</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_2_requests_routing">Lab 2 - Requests Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_3_traffic_shifting_and_weight_balancing">Lab 3 - Traffic Shifting and Weight Balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_4_fault_injection">Lab 4 - Fault Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_5_requests_timeouts">Lab 5 - Requests Timeouts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_6_circuit_breaking">Lab 6 - Circuit Breaking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_7_mirroring_and_dark_launches">Lab 7 - Mirroring and Dark Launches</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">5. Troubleshooting - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_4_service_mesh_ingress_traffic_flow">Lab 4 - Service Mesh Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_5_service_mesh_secure_ingress_traffic_flow">Lab 5 - Service Mesh Secure Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_6_service_mesh_secure_egress_traffic_flow">Lab 6 - Service Mesh Secure Egress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_7_troubleshooting_tools">Lab 7 - Troubleshooting Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../05-security/index.html">6. Security - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_1_setup_demo_applications">Lab 1 - Setup demo applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_2_peerauthentication">Lab 2 - PeerAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_3_authorization_part_1">Lab 3 - Authorization: part 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_4_requestauthentication">Lab 4 - RequestAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_5_authorization_part_2">Lab 5 - Authorization: part 2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../06-extensibility/index.html">7. Extensibility - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_rhossm_extensibility_labs">Red Hat OpenShift Service Mesh: Extensibility Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_1_envoy_filters">Lab 1 - Envoy Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_2_waes">Lab 2 - WebAssembly Extensions</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="05-secure-ingress-traffic.html">Lab 5 - Service Mesh Secure Ingress Traffic Flow</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/04-troubleshooting/05-secure-ingress-traffic.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab 5 - Service Mesh Secure Ingress Traffic Flow</h1>
<div id="toc" class="toc">
<div id="toctitle">Secure Gateways with SDS</div>
<ul class="sectlevel1">
<li><a href="#05-sds">1. Secure Gateways with SDS</a>
<ul class="sectlevel2">
<li><a href="#05-sds-addcert">1.1. Create in Istio the Custom Certificate using SDS</a></li>
<li><a href="#05-sds-route">1.2. Modify back-golang Route in istio-system Namespace</a></li>
<li><a href="#05-sds-gw">1.3. Configure Gateway</a></li>
</ul>
</li>
<li><a href="#05-test-fail">2. Confirm <em>Jump App</em> is running</a></li>
<li><a href="#05-router">3. Openshift Router &#8594; Ingress Gateway Secure Connectivity</a>
<ul class="sectlevel2">
<li><a href="#05-trou-con">3.1. Test connectivity via command line</a></li>
<li><a href="#05-trou-fix">3.2. Fix configuration problems</a></li>
</ul>
</li>
<li><a href="#05-gateway">4. Ingress Gateway &#8594; Envoy Sidecar Secure Connectivity</a>
<ul class="sectlevel2">
<li><a href="#05-trou-gateway-forcessl">4.1. Force mTLS in your namespace</a></li>
<li><a href="#05-trou-gateway-con">4.2. Test connectivity via command line</a></li>
<li><a href="#05-trou-gateway-evoy-con">4.3. Emulate regular <em>Ingress Gateway</em> connectivity via command line</a></li>
</ul>
</li>
<li><a href="#05-test">5. Confirm <em>Jump App</em> is running again</a></li>
<li><a href="#05-kiali">6. Visit Kiali</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="05-sds"><a class="anchor" href="#05-sds"></a>1. Secure Gateways with SDS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you know, Gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>During this step, you will review how to expose a secure HTTPS service through Openshift Router using a Gateway, a custom certificate and Istio Secret Discovery Service (SDS).</p>
</div>
<div class="sect2">
<h3 id="05-sds-addcert"><a class="anchor" href="#05-sds-addcert"></a>1.1. Create in Istio the Custom Certificate using SDS</h3>
<div class="paragraph">
<p>In order to configure a new certificate in SDS, it is required to create a new <em>secret</em> in Openshift to save the respective files.</p>
</div>
<div class="paragraph">
<p>Please, create this new <strong>secret</strong> executing the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -n istio-system secret tls $USER_NAMESPACE-credential --key=./05-secure-ingress-traffic-troubleshooting/front.jumpapp.com.key --cert=./05-secure-ingress-traffic-troubleshooting/front.jumpapp.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Secret Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-secret-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-secret-ok.png" alt="jump app secret ok"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="05-sds-route"><a class="anchor" href="#05-sds-route"></a>1.2. Modify back-golang Route in istio-system Namespace</h3>
<div class="paragraph">
<p>Once the new <em>secret</em> has been created, it is time to modify the back-golang OCP route in order to configure it as a <em>passthrough</em> route. With passthrough termination, encrypted traffic is sent straight to the <em>Ingress Gateway</em> without the router providing TLS termination. Therefore no key or certificate is required.</p>
</div>
<div class="paragraph">
<p>Please, modify back-golang OCP route in <strong>istio-system</strong> namespace through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/00-jump-app-golang-route.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">back-golang Route Modified</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-routes-sds-mod.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-routes-sds-mod.png" alt="jump app routes sds mod"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="05-sds-gw"><a class="anchor" href="#05-sds-gw"></a>1.3. Configure Gateway</h3>
<div class="paragraph">
<p>If you remember, a gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>In order to serve this new certificate when you are accessing to <em>Jump App</em> back-golang service, it is required to modify the respective Gateway.</p>
</div>
<div class="paragraph">
<p>Please, modify existing frontend <strong>gateway</strong> object executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/01-jump-app-golang-gw.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">back-golang Gateway Modified</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-gw-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-gw-ok.png" alt="jump app gw ok"></a></span></p>
</div>
<div class="paragraph">
<p>In order to ensure the Istio Secret Discovery Service (SDS) has been configured properly, you can review the <em>istio ingress gateway</em> pod as shown the following picture:</p>
</div>
<div class="paragraph">
<div class="title">Secret Added to SDS</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-sds-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-sds-ok.png" alt="jump app sds ok"></a></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-test-fail"><a class="anchor" href="#05-test-fail"></a>2. Confirm <em>Jump App</em> is running</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <em>Jump App</em> SDS has been modified, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="paragraph">
<p>Please, execute the following steps in order to review your demo app current state after the customization:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-pods-2-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-pods-2-ok.png" alt="jump app pods 2 ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Back Unavailable</div>
<p><span class="image unresolved"><a class="image" href="../_images/04-troubleshooting/04-troubleshooting/jump-app-unavailable-back-route.png" target="_blank" rel="noopener"><img src="04-troubleshooting/04-troubleshooting/jump-app-unavailable-back-route.png" alt="jump app unavailable back route"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser.In addition, configure <strong>[ 1 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Front with Errors</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-unavailable-front.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-unavailable-front.png" alt="jump app unavailable front"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An error message appears when the frontend tries to call backend services
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-router"><a class="anchor" href="#05-router"></a>3. Openshift Router &#8594; Ingress Gateway Secure Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ingress-router-gw-sec.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ingress-router-gw-sec.png" alt="jump app ingress router gw sec"></a></span></p>
</div>
<div class="sect2">
<h3 id="05-trou-con"><a class="anchor" href="#05-trou-con"></a>3.1. Test connectivity via command line</h3>
<div class="paragraph">
<p>In order to verify the secure connectivity from the <em>OCP Routers</em> to the <em>Ingress Gateway</em>, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in routes namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n openshift-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">OCP Router Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-routers-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-routers-pods.png" alt="ocp routers pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the router pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project openshift-ingress
POD=$(oc get po -o jsonpath='{.items[0].metadata.name}' -n openshift-ingress)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:istio-ingressgateway.istio-system.svc.cluster.local:443 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response 200</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-gw.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-gw.png" alt="jump app trou 05 gw"></a></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that the <em>Ingress Gateway</em> is exposing back-golang service properly. For this reason, you can conclude the problem is located at the OCP route level
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-fix"><a class="anchor" href="#05-trou-fix"></a>3.2. Fix configuration problems</h3>
<div class="paragraph">
<p>After test the connectivity from the <em>OCP routers</em> to the <em>ingress gateway</em>, you should review the <em>Route</em> object configuration in order to verify its definition. Please, visit the OCP console <strong>&lt;ocp_cluster_console&gt;</strong> and review this object current state:</p>
</div>
<div class="paragraph">
<div class="title">OCP Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ocp-trou-05.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ocp-trou-05.png" alt="jump app ocp trou 05"></a></span></p>
</div>
<div class="paragraph">
<div class="title">OCP Console Bad Configuration</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ocp-trou-05-error.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ocp-trou-05-error.png" alt="jump app ocp trou 05 error"></a></span></p>
</div>
<div class="paragraph">
<p>If you take a look at the <em>target port</em> closely, you can find <em>http2</em>. In order to support passthrough routes and connect with <em>Ingress Gateway</em> secure ports, it is required define a secured port. Please, <em>edit route</em>, define <em>https</em> as target port and click on <strong>[ SAVE ]</strong>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-gateway"><a class="anchor" href="#05-gateway"></a>4. Ingress Gateway &#8594; Envoy Sidecar Secure Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ingress-envoy-gw-sec.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ingress-envoy-gw-sec.png" alt="jump app ingress envoy gw sec"></a></span></p>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-forcessl"><a class="anchor" href="#05-trou-gateway-forcessl"></a>4.1. Force mTLS in your namespace</h3>
<div class="paragraph">
<p>In Istio, <em>PeerAuthentication</em> defines how traffic will be tunneled (or not) to the sidecar. In order to force all connections are secured, it is required to create the following objects using the next command:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/02-jump-app-sec-services.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">PeerAuthentication and Destination Rule created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-padr.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-padr.png" alt="jump app trou 05 padr"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-con"><a class="anchor" href="#05-trou-gateway-con"></a>4.2. Test connectivity via command line</h3>
<div class="paragraph">
<p>In order to verify the secure connectivity from the <em>Ingress Gateway</em> to the <em>Envoy Sidecar</em>, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio ControlPlane Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" alt="ocp istio controlplane pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response <em>Connection reset by peer</em></div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv.png" alt="jump app trou 05 k8ssrv"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You are receiving <strong>curl: (56) Recv failure: Connection reset by peer</strong> because <em>PeerAuthentication STRICT</em> mode is enabled
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-evoy-con"><a class="anchor" href="#05-trou-gateway-evoy-con"></a>4.3. Emulate regular <em>Ingress Gateway</em> connectivity via command line</h3>
<div class="paragraph">
<p>At this point, it is time to understand how Service Mesh generates envoy traffic internal certificates. In this step, you should be able to generate a certificate from the Istio CA in order to stablish a mTLS secure connection from the <em>Ingress Gateway</em> to the <em>Envoy Sidecar</em>, back-golang.</p>
</div>
<div class="paragraph">
<p>Please, execute the following steps in order to perform the previous tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract Istio CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
oc extract secret/istio-ca-secret --to=. -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio CA Certs</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-ca-certs.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-ca-certs.png" alt="ocp istio ca certs"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a openssl configuration file in order to be able to generate a x509v3 certificate</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">cat &lt;&lt;EOF &gt; openssl.conf
[req]
default_bits = 2048
encrypt_key  = no # Change to encrypt the private key using des3 or similar
default_md   = sha256
prompt       = no
utf8         = yes
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[v3_req]
basicConstraints     = CA:FALSE
keyUsage             = digitalSignature, keyEncipherment
extendedKeyUsage     = clientAuth, serverAuth
subjectAltName       = @alt_names
[alt_names]
URI = spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account
EOF</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a certificate request</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl req -out istio.test.csr -newkey rsa:2048 -nodes -keyout istio.test.key -subj "/"</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">New Certificate Request</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-gen-cert-req.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-gen-cert-req.png" alt="ocp istio gen cert req"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a certificate using these CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl x509 -req -days 365 -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -in istio.test.csr -out  istio.test.crt -extensions v3_req -extfile openssl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">New Istio CA signed Certificate</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-gen-cert.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-gen-cert.png" alt="ocp istio gen cert"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio ControlPlane Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" alt="ocp istio controlplane pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy certificates to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc exec $POD -- mkdir -p /var/run/secrets/workload-spiffe-credentials/tmp/
oc exec $POD -- mkdir /var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp istio.test.crt $POD:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp istio.test.key $POD:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp ca-cert.pem $POD:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD
cd /var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Perform a HTTP request to the k8s service <em>back-golang</em> using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response <em>Certificate required</em></div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv-cert.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv-cert.png" alt="jump app trou 05 k8ssrv cert"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Once again, perform a HTTP request to the k8s service <em>back-golang</em> using previous certificates in this time</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v --cacert ca-cert.pem --cert istio.test.crt --key istio.test.key</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response 200</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv-cert-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv-cert-ok.png" alt="jump app trou 05 k8ssrv cert ok"></a></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-test"><a class="anchor" href="#05-test"></a>5. Confirm <em>Jump App</em> is running again</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been modified and fixed in Kiali and Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-pods-2-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-pods-2-ok.png" alt="jump app pods 2 ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Back</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-back-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-back-ok.png" alt="jump app back ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser. In addition, configure <strong>[ 1000 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
<div class="literalblock">
<div class="content">
<pre>...{"code":200,"message":"/jump - Greetings from Python!"}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Front Web UI Multi Jumps</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-front-jumps-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-front-jumps-ok.png" alt="jump app front jumps ok"></a></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is required to accept <strong>self-signed certificates</strong> provided by Openshift
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Openshift Self-signed Certificates Warning</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/certs_warning.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/certs_warning.png" alt="certs warning" width="50%"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-kiali"><a class="anchor" href="#05-kiali"></a>6. Visit Kiali</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this time, <em>Jump App</em> is generating traffic flow thanks to the frontend where it was given an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit the Kiali console <strong>&lt;kiali_url&gt;</strong>:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali.png" alt="jump app kiali"></a></span></p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
