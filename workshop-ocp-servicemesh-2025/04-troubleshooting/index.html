<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Welcome to Red Hat Service Mesh: Troubleshooting tutorial :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/04-troubleshooting/index.html">
    <link rel="prev" href="../03-traffic-management/index.html">
    <link rel="next" href="../05-security/index.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
            <a class="navbar-item" href="https://atarazana.github.io/kitchensink-guide/" target="_blank">Deploying JBoss EAP applications on OpenShift</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-introduction/index.html">2. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_2_complete_application_deployment">Lab 2 - Complete application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_3_adding_persistent_volumes">Lab 3 - Adding persistent volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_4_configuration_management">Lab 4 - Configuration management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_5_resources">Lab 5 - Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_6_liveness_and_readiness_probes">Lab 6 - Liveness and readiness probes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html">3. Envoy istio Control plane - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_4_istio_envoy_objects_relationship">Lab 4 - Istio-Envoy Objects Relationship</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_5_envoy_proxy">Lab 5 - Envoy Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_6_istio_control_plane">Lab 6 - Istio Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_7_istio_global_services">Lab 7 - Istio Global Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../03-traffic-management/index.html">4. Traffic management - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_rhossm_traffic_management_labs">Red Hat OpenShift Service Mesh: Traffic Management Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_1_ingress_gateways">Lab 1 - Ingress Gateways</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_2_requests_routing">Lab 2 - Requests Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_3_traffic_shifting_and_weight_balancing">Lab 3 - Traffic Shifting and Weight Balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_4_fault_injection">Lab 4 - Fault Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_5_requests_timeouts">Lab 5 - Requests Timeouts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_6_circuit_breaking">Lab 6 - Circuit Breaking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_7_mirroring_and_dark_launches">Lab 7 - Mirroring and Dark Launches</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">5. Troubleshooting - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_4_service_mesh_ingress_traffic_flow">Lab 4 - Service Mesh Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_5_service_mesh_secure_ingress_traffic_flow">Lab 5 - Service Mesh Secure Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_6_service_mesh_secure_egress_traffic_flow">Lab 6 - Service Mesh Secure Egress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_lab_7_troubleshooting_tools">Lab 7 - Troubleshooting Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../05-security/index.html">6. Security - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_1_setup_demo_applications">Lab 1 - Setup demo applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_2_peerauthentication">Lab 2 - PeerAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_3_authorization_part_1">Lab 3 - Authorization: part 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_4_requestauthentication">Lab 4 - RequestAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_5_authorization_part_2">Lab 5 - Authorization: part 2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../06-extensibility/index.html">7. Extensibility - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_rhossm_extensibility_labs">Red Hat OpenShift Service Mesh: Extensibility Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_1_envoy_filters">Lab 1 - Envoy Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../06-extensibility/index.html#_lab_2_waes">Lab 2 - WebAssembly Extensions</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="index.html">5. Troubleshooting - Labs</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/04-troubleshooting/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Welcome to Red Hat Service Mesh: Troubleshooting tutorial</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/logos.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/logos.png" alt="Envoy" width="600" height="200"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The general idea of <em>Red Hat Service Mesh: Troubleshooting</em> tutorial is to get a deep understanding of the following points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Service Mesh Communication Flows</p>
</li>
<li>
<p>Ingress Traffic Troubleshooting</p>
</li>
<li>
<p>Secure Ingress Traffic Troubleshooting</p>
</li>
<li>
<p>Egress Traffic Troubleshooting</p>
</li>
<li>
<p>Secure Egress Traffic Troubleshooting</p>
</li>
<li>
<p>Troubleshooting Tools</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_lab_1_setup" class="sect0"><a class="anchor" href="#_lab_1_setup"></a>Lab 1 - Setup</h1>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>1. Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During this tutorial, it will be required to work with different tools for running the exercises included. Please, install the following software:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top"><strong>Tool</strong></th>
<th class="tableblock halign-center valign-top"><strong>Fedora</strong></th>
<th class="tableblock halign-center valign-top"><strong>macOS</strong></th>
<th class="tableblock halign-center valign-top"><strong>windows</strong></th>
<th class="tableblock halign-center valign-top"><strong>Official Documentation</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">oc</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-mac.tar.gz">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-windows.zip">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.openshift.com/container-platform/4.6/cli_reference/openshift_cli/getting-started-cli.html">OpenShift CLI - Docs</a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">git</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://git-scm.com/download/linux">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://git-scm.com/download/mac">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://git-scm.com/download/win">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://git-scm.com">Git - Docs</a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Visual Studio Code</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://code.visualstudio.com/sha/download?build=stable&amp;os=linux-rpm-x64">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://code.visualstudio.com/sha/download?build=stable&amp;os=darwin">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://code.visualstudio.com/sha/download?build=stable&amp;os=win32-user">Download</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://code.visualstudio.com/">Visual Studio Code - Docs</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="laboratory"><a class="anchor" href="#laboratory"></a>2. Laboratory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tutorial&#8217;s laboratory is basically based on the following technologies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Red Hat Openshift Container Platform Cluster</p>
</li>
<li>
<p>Red Hat Service Mesh based on <em>Istio</em> &amp; <em>Envoy</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, a GitHub repository is provided with a set of templates and other resources which are required to create different objects in Openshift during this tutorial.</p>
</div>
<div class="paragraph">
<p>The previous technologies and resources will allow you to implement a microservice-based application in Openshift which will be included in Service Mesh. The main objective of deploying this application in Openshift using Service Mesh is to understand how <em>Istio</em> &amp; <em>Envoy</em> are tightly related.</p>
</div>
<div class="sect2">
<h3 id="_laboratory_parameters"><a class="anchor" href="#_laboratory_parameters"></a>2.1. Laboratory Parameters</h3>
<div class="paragraph">
<p>The Instructor provides users the Openshift credentials and other important parameters at the beginning of this tutorial in order to access the laboratory.</p>
</div>
<div class="paragraph">
<p>The following table includes the parameters that the Instructor should provide you at the beginning:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top"><strong>Name</strong></th>
<th class="tableblock halign-center valign-top"><strong>Reference</strong></th>
<th class="tableblock halign-center valign-top"><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Openshift Cluster API (Access CLI)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;ocp_cluster_url&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em><a href="https://api.tutorialrhmesh.sandbox507.opentlc.com" class="bare">https://api.tutorialrhmesh.sandbox507.opentlc.com</a></em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Openshift Cluster Console</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;ocp_cluster_console&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em><a href="https://console-openshift-console.apps.labs.sandbox1562.opentlc.com" class="bare">https://console-openshift-console.apps.labs.sandbox1562.opentlc.com</a></em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Username</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;user&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">user1</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Password</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;pass&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P4ssw0rd</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Namespace</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;user_namespace&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">user1-namespace</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Openshift Apps Domain</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;openshift_apps_domain&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>apps.labs.sandbox1562.opentlc.com</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Kiali Url</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;kiali_url&gt;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em><a href="https://kiali-istio-system.apps.labs.sandbox1562.opentlc.com" class="bare">https://kiali-istio-system.apps.labs.sandbox1562.opentlc.com</a></em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Then export them:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export USER=&lt;user&gt;
export PASS=&lt;pass&gt;
export USER_NAMESPACE=&lt;user_namespace&gt;
export OCP_API=&lt;ocp_cluster_url&gt;
export OCP_APPS_DOMAIN=&lt;openshift_apps_domain&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_access_laboratory_oc_client"><a class="anchor" href="#_access_laboratory_oc_client"></a>2.2. Access Laboratory - OC Client</h3>
<div class="paragraph">
<p>The OpenShift Container Platform CLI, installed before, exposes commands for managing your applications, as well as lower level tools to interact with each component of your system.</p>
</div>
<div class="paragraph">
<p>Please, review the previous settings with your Instructor and connect to the cluster executing next command from your terminal:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u $USER -p $PASS $OCP_API</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">OC CLI Login Output</div>
<p>04-troubleshooting/oc_login_output.png[]</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please, pay special attention to <em>oc CLI</em>  because you will need to use this tool several times during this tutorial.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_access_laboratory_console"><a class="anchor" href="#_access_laboratory_console"></a>2.3. Access Laboratory - Console</h3>
<div class="paragraph">
<p>In addition, access Openshift Console using your credentials via browser in order to check connectivity and accessibility to the console:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;ocp_cluster_console&gt; (<em>E.g. <a href="https://console-openshift-console.apps.labs.sandbox1562.opentlc.com" class="bare">https://console-openshift-console.apps.labs.sandbox1562.opentlc.com</a></em>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Openshift Console Oauth</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp_console_oauth.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp_console_oauth.png" alt="ocp console oauth"></a></span></p>
</div>
<div class="paragraph">
<div class="title">Openshift Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp_console.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp_console.png" alt="ocp console"></a></span></p>
</div>
</div>
</div>
</div>
<h1 id="_lab_2_deploy_jump_app" class="sect0"><a class="anchor" href="#_lab_2_deploy_jump_app"></a>Lab 2 - Deploy Jump App</h1>
<div class="sect1">
<h2 id="_deploy_jump_app_microservices"><a class="anchor" href="#_deploy_jump_app_microservices"></a>1. Deploy <em>Jump App</em> Microservices</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Jump App</em> is a microservice-based application created to emulate an enterprise application complex architecture with multi environments. This app allows users to configure a set of jumps between components and generate a continuous traffic flow defining the number of retries and their span of time.</p>
</div>
<div class="paragraph">
<p>First of all, it is required to deploy Jump App application in Openshift in order to have the demo application environment ready. The following steps in this section helps you to deploy <em>Jump App</em>.</p>
</div>
<div class="sect2">
<h3 id="login"><a class="anchor" href="#login"></a>1.1. Login in Openshift</h3>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u $USER -p $PASS $OCP_API</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">OC CLI Login Output</div>
<p>04-troubleshooting/oc_login_output.png[]</p>
</div>
</div>
<div class="sect2">
<h3 id="github"><a class="anchor" href="#github"></a>1.2. Clone GitHub Repository</h3>
<div class="paragraph">
<p><em>Jump App GitOps</em> is one of a set of repositories developed to generate a microservice based application, named Jump App. This repository includes an automated way of deploying Jump App&#8217;s microservices and all stuff around this application (Deployments, Services, Build Configs, Pipelines, etc), including optionally CI/CD or Service Mesh objects as well.</p>
</div>
<div class="paragraph">
<p>Please, follow the next steps in order to download the GitHub repository code:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone <a href="https://github.com/acidonper/rh-service-mesh-v2-troubleshooting-resources.git" class="bare">https://github.com/acidonper/rh-service-mesh-v2-troubleshooting-resources.git</a></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">git clone output</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/git_clone_output.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/git_clone_output.png" alt="git clone output"></a></span></p>
</div>
<div class="paragraph">
<p>Finally, navigate to the new folder created in your system after repository download for completing all tasks included in this tutorial:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd rh-service-mesh-v2-troubleshooting-resources</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jumpappobjects"><a class="anchor" href="#jumpappobjects"></a>1.3. Create <em>Jump App</em> Objects in Openshift</h3>
<div class="paragraph">
<p>First of all, it is required to modify <em>params.env</em> file to include the parameters provided by the Instructor:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vi params.env</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 1. params file content</div>
<div class="content">
<div class="paragraph">
<p>USER_NAMESPACE=user1-namespace<br>
OCP_APPS_DOMAIN=apps.labs.sandbox1562.opentlc.com</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the params file is saved, you are able to process with <em>Jump App</em> deployment phase:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project $USER_NAMESPACE
oc process -f ./02-jump-app-deploy/jump-app-template.yml --param-file=./params.env --ignore-unknown-parameters | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Deployed</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/lojump_app_createdgin.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump_app_created.png" alt="jump app created"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="test"><a class="anchor" href="#test"></a>1.4. Confirm that <em>Jump App</em> is already running in Openshift</h3>
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been created in Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump_app_pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump_app_pods.png" alt="jump app pods"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="testapp"><a class="anchor" href="#testapp"></a>1.5. Access to <em>Jump App</em></h3>
<div class="paragraph">
<p>Once <em>Jump App</em> is already running in Openshift, it is time to access <em>Jump App</em> public services in order to test the application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-routes.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-routes.png" alt="jump app routes"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Back</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-back-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-back-ok.png" alt="jump app back ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser, push <strong>- JUMP-</strong> button and ensure the following message is displaying in your screen:</p>
<div class="literalblock">
<div class="content">
<pre>...{"code":200,"message":"/jump - Greetings from Python!"}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Frontend Web UI</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-front-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-front-ok.png" alt="jump app front ok"></a></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is required to accept <strong>self-signed certificates</strong> provided by Openshift
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Openshift Self-signed Certificates Warning</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/certs_warning.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/certs_warning.png" alt="certs warning" width="50%"></a></span></p>
</div>
</div>
</div>
</div>
<h1 id="_lab_3_service_mesh_communication_flows" class="sect0"><a class="anchor" href="#_lab_3_service_mesh_communication_flows"></a>Lab 3 - Service Mesh Communication Flows</h1>
<div class="sect1">
<h2 id="memberrol"><a class="anchor" href="#memberrol"></a>1. Added a new project to Red Hat Service Mesh Control Plane</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The ServiceMeshMemberRoll lists the projects belonging to the control plane. Only projects listed in the ServiceMeshMemberRoll are affected by the control plane.</p>
</div>
<div class="paragraph">
<p>In order to add this new project to the Service Mesh and make the traffic between each microservice possible, it is required to create a new <em>ServiceMeshMember</em> object.</p>
</div>
<div class="paragraph">
<p>Please, create the previous object through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/04-jump-app-ns-smr.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title"><em>ServiceMeshMember</em> Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ns-smr.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ns-smr.png" alt="jump app ns smr"></a></span></p>
</div>
<div class="paragraph">
<p>Additionally, you are able to check this new object through the Openshift Console:</p>
</div>
<div class="paragraph">
<div class="title"><em>ServiceMeshMember</em> Created Console- 1</div>
<p><span class="image"><a class="image" href="../<em>images/04-troubleshooting/jump-app-ns-smr-con1.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ns-smr-con1.png" alt="jump app ns smr con1"></a></span>
._ServiceMeshMember</em> Created Console - 2
<span class="image"><a class="image" href="../<em>images/04-troubleshooting/jump-app-ns-smr-con2.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ns-smr-con2.png" alt="jump app ns smr con2"></a></span>
._ServiceMeshMember</em> Created Console - 3
<span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ns-smr-con3.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ns-smr-con3.png" alt="jump app ns smr con3"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create"><a class="anchor" href="#create"></a>2. Create Red Hat Service Mesh Traffic Flow objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to make an application available through Service Mesh, it is required to create a set of Service Mesh objects related to the traffic flow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gateways - Describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections (Please, visit this link <a href="https://istio.io/v1.16/docs/concepts/traffic-management/#gateways">Gateways</a> for more information about <em>gateways</em>)</p>
</li>
<li>
<p>Virtual Services - Defines a set of traffic routing rules to apply when a host is addressed (Please, visit this link <a href="https://istio.io/v1.16/docs/concepts/traffic-management/#virtual-services">Virtual Services</a> for more information about <em>virtual services</em>)</p>
</li>
<li>
<p>Destination Rules - Defines policies that apply to traffic intended for a service after routing has occurred (Please, visit this link <a href="https://istio.io/v1.16/docs/concepts/traffic-management/#destination-rules">Destination Rules</a> for more information about <em>destination rules</em>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this step, you have to be able to deploy these <em>Jump App</em> Service Mesh objects in order to introduce this application in the Service Mesh and publish it to external clients.</p>
</div>
<div class="sect2">
<h3 id="gw"><a class="anchor" href="#gw"></a>2.1. Gateways</h3>
<div class="paragraph">
<p>First of all, it is required to create a Gateway for external access. In the <em>Jump App</em> architecture, you have a couple of services which have to be exposed to external clients in order to present the Frontend and Backend services.</p>
</div>
<div class="paragraph">
<p>Please, return to git repository and create <strong>gateways</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/00-jump-app-gws.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Gateways Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-gws-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-gws-ok.png" alt="jump app gws ok"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="vsvc"><a class="anchor" href="#vsvc"></a>2.2. Virtual Services</h3>
<div class="paragraph">
<p>Once gateways are created and the application is reachable, it is time to create the traffic rules inside your namespace in order to route this traffic to the specific endpoint.</p>
</div>
<div class="paragraph">
<p>Please, create new <strong>virtual services</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/01-jump-app-vss.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Virtual Services Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-vss-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-vss-ok.png" alt="jump app vss ok"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="dr"><a class="anchor" href="#dr"></a>2.3. Destination Rules</h3>
<div class="paragraph">
<p>Once previous objects are created, it is required  to define the policies which will be applied to traffic intended for a service after routing has occurred.</p>
</div>
<div class="paragraph">
<p>Please, create new <strong>destination rules</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/02-jump-app-drs.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Destination Rules Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-drs-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-drs-ok.png" alt="jump app drs ok"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="services"><a class="anchor" href="#services"></a>2.4. K8s Services</h3>
<div class="paragraph">
<p>Once you have created gateways, virtual services and destination rules, it is time to include a specific annotation in your app deployments in order to allow Service Mesh control and run the respective envoy sidecar automatically.</p>
</div>
<div class="paragraph">
<p>Please, create new <strong>k8s services</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/03-jump-app-services.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">k8s Services Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-svcs-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-svcs-ok.png" alt="jump app svcs ok"></a></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="finalsteps"><a class="anchor" href="#finalsteps"></a>3. Final Steps</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="annotation"><a class="anchor" href="#annotation"></a>3.1. Add <em>Istio Sidecar</em> annotation in <em>Jump App</em> deployments</h3>
<div class="paragraph">
<p>Once traffic flow objects are created and your namespace is included as a member in the Service Mesh Control Plane, it is time to include a specific annotation in your app deployments in order to allow Service Mesh control and run the respective envoy sidecar automatically.</p>
</div>
<div class="paragraph">
<p>Please, edit each <em>Jump App Microservice</em> deployment executing the commands added below:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment front-javascript-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Front Patched</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-front-depl-patch.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-front-depl-patch.png" alt="jump app front depl patch"></a></span></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment back-springboot-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Back Springboot Patched</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-back-spb-depl-patch.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-back-spb-depl-patch.png" alt="jump app back spb depl patch"></a></span></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment back-python-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Back Python Patched</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-back-py-depl-patch.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-back-py-depl-patch.png" alt="jump app back py depl patch"></a></span></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment back-golang-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Back Golang Patched</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-back-go-depl-patch.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-back-go-depl-patch.png" alt="jump app back go depl patch"></a></span></p>
</div>
<div class="paragraph">
<p>Before continuing with the following steps, please test Jump App <em>pods</em> status, in order to be sure that 2 replicas are running for each microservice:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-pods-2-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-pods-2-ok.png" alt="jump app pods 2 ok"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="routes"><a class="anchor" href="#routes"></a>3.2. Configure Routes</h3>
<div class="paragraph">
<p>An OpenShift Container Platform <strong>route</strong> exposes a service at a host name, such as www.example.com, so that external clients can reach it by name. When you manage routes outside Service Mesh, it is required to create these objects in each namespace.</p>
</div>
<div class="paragraph">
<p>Once you have a project integrated in Service Mesh, routes should be created in istio-system, or wherever the control plane is installed, to make this external service available through the Istio Ingress Gateway. For this reason, it is required to follow the next steps:</p>
</div>
<div class="sect3">
<h4 id="_delete_all_current_routes_in_user_namespace"><a class="anchor" href="#_delete_all_current_routes_in_user_namespace"></a>3.2.1. Delete all current routes in &lt;user_namespace&gt;</h4>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n $USER_NAMESPACE | grep -v NAME | awk '{print "oc delete route " $1 " -n $USER_NAMESPACE"}' | sh</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes Deleted</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-route-del.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-route-del.png" alt="jump app route del"></a></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_new_routes_in_istio_system"><a class="anchor" href="#_create_a_new_routes_in_istio_system"></a>3.2.2. Create a new routes in istio-system</h4>
<div class="paragraph">
<p>Once "regular" routes are deleted, it is required to create the new ones.</p>
</div>
<div class="paragraph">
<p>Please, create new <strong>routes</strong> in <strong>istio-system</strong> namespace through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/05-jump-app-routes.yaml --param-file=params.env --ignore-unknown-parameters | oc create -f - -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Mesh Routes Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-routes-mesh-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-routes-mesh-ok.png" alt="jump app routes mesh ok"></a></span></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="03-test"><a class="anchor" href="#03-test"></a>4. Confirm <em>Jump App</em> is running again</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been created in Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Look at the number of containers in each microservice, it must contains 2 container per each pod (<strong>READY 2/2</strong>).
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-pods-2-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-pods-2-ok.png" alt="jump app pods 2 ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Back</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-back-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-back-ok.png" alt="jump app back ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser. In addition, configure <strong>[ 10000 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
<div class="literalblock">
<div class="content">
<pre>...{"code":200,"message":"/jump - Greetings from Python!"}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Front Web UI Multi Jumps</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-front-jumps-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-front-jumps-ok.png" alt="jump app front jumps ok"></a></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is required to accept <strong>self-signed certificates</strong> provided by Openshift
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Openshift Self-signed Certificates Warning</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/certs_warning.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/certs_warning.png" alt="certs warning" width="50%"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="03-kiali"><a class="anchor" href="#03-kiali"></a>5. Visit Kiali</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jump App is generating traffic flow thanks to the frontend where it was given an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit the Kiali console <strong>&lt;kiali_url&gt;</strong> (<em>E.g. <a href="https://kiali-istio-system.apps.labs.sandbox1562.opentlc.com" class="bare">https://kiali-istio-system.apps.labs.sandbox1562.opentlc.com</a></em>):</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali.png" alt="jump app kiali"></a></span></p>
</div>
</div>
</div>
<h1 id="_lab_4_service_mesh_ingress_traffic_flow" class="sect0"><a class="anchor" href="#_lab_4_service_mesh_ingress_traffic_flow"></a>Lab 4 - Service Mesh Ingress Traffic Flow</h1>
<div class="sect1">
<h2 id="04-ingress"><a class="anchor" href="#04-ingress"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During this section, you will customize <em>Jump App</em> and resolve any problems found during this customization process using the command line and Kiali as the main troubleshooting tools.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-troubleshooting"><a class="anchor" href="#04-troubleshooting"></a>2. Ingress Gateway Traffic Flow Troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you might know, we have 3 important objects in Istio that are essential to redirect ingress traffic from the Ingress Gateway to the application pods in Service Mesh:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gateways</p>
</li>
<li>
<p>Virtual Services</p>
</li>
<li>
<p>Destination Rules</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>During the following sections, you will work with these objects and test, step by step, each segment of ingress traffic route:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Openshift Router &#8594; Ingress Gateway</p>
</li>
<li>
<p>Ingress Gateway &#8594; Sidecar</p>
</li>
<li>
<p>Sidecar &#8594; App</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will use <em>OC client</em>, <em>curl</em> and <em>Kiali</em> as the main troubleshooting tools
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-customize"><a class="anchor" href="#04-customize"></a>3. Customize Jump App</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First of all, it is required to modify <em>Jump App</em> Service Mesh objects in order to emulate a real life day 2 operation.</p>
</div>
<div class="paragraph">
<p>Please, return to the git repository and apply some customizations through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 04-ingress-traffic-troubleshooting/00-jump-app-ingress-customization.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Customizations Applied I</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mod-gw-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mod-gw-ok.png" alt="jump app mod gw ok"></a></span></p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 04-ingress-traffic-troubleshooting/01-jump-app-back-golang-svc.yaml --param-file=params.env --ignore-unknown-parameters | oc delete -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Customizations Applied II</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mod-svc-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mod-svc-ok.png" alt="jump app mod svc ok"></a></span></p>
</div>
<div class="sect2">
<h3 id="04-cust-state"><a class="anchor" href="#04-cust-state"></a>3.1. Confirm <em>Jump App</em> state</h3>
<div class="paragraph">
<p>Once <em>Jump App</em> customizations have been applied, it is time to review your demo application services state.</p>
</div>
<div class="paragraph">
<p>Please, execute the following steps in order to review your demo app current state after the customization:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-pods-2-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-pods-2-ok.png" alt="jump app pods 2 ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Back Unavailable</div>
<p><span class="image unresolved"><a class="image" href="../_images/04-troubleshooting/04-troubleshooting/jump-app-unavailable-back.png" target="_blank" rel="noopener"><img src="04-troubleshooting/04-troubleshooting/jump-app-unavailable-back.png" alt="jump app unavailable back"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser.In addition, configure <strong>[ 1 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Front with Errors</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-unavailable-front.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-unavailable-front.png" alt="jump app unavailable front"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An error message appears when the frontend tries to call backend services
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-router"><a class="anchor" href="#04-router"></a>4. Openshift Router &#8594; Ingress Gateway Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ingress-router-gw.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ingress-router-gw.png" alt="jump app ingress router gw"></a></span></p>
</div>
<div class="sect2">
<h3 id="04-trou-con"><a class="anchor" href="#04-trou-con"></a>4.1. Test connectivity via command line</h3>
<div class="paragraph">
<p>In order to verify the connectivity from the <em>OCP Routers</em> to the <em>Ingress Gateway</em>, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in routes namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n openshift-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">OCP Router Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-routers-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-routers-pods.png" alt="ocp routers pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the router pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project openshift-ingress
POD=$(oc get po -o jsonpath='{.items[0].metadata.name}' -n openshift-ingress)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl -XGET -v --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" <a href="http://istio-ingressgateway.istio-system.svc.cluster.local:80" class="bare">http://istio-ingressgateway.istio-system.svc.cluster.local:80</a> -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response Error 404</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-04-gw.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-04-gw.png" alt="jump app trou 04 gw"></a></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that the error is 404 because of the route, or path, is not found
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="04-trou-fix"><a class="anchor" href="#04-trou-fix"></a>4.2. Fix configuration problems</h3>
<div class="paragraph">
<p>After test the connectivity from the <em>OCP routers</em> to the <em>ingress gateway</em>, you should review the <em>Gateway</em> object configuration in order to verify its definition. Please, visit the Kiali console <strong>&lt;kiali_url&gt;</strong> and review the <em>Gateway</em> object current state:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali-trou-04.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali-trou-04.png" alt="jump app kiali trou 04"></a></span></p>
</div>
<div class="paragraph">
<div class="title">Kiali Console Gateway Error</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali-trou-04-error.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali-trou-04-error.png" alt="jump app kiali trou 04 error"></a></span></p>
</div>
<div class="paragraph">
<p>If you take a look at the host paths closely, you can find a bad definition because of the pattern <strong>"-fail"</strong> included in the path. Please, modify this hostname and click on <strong>[ SAVE ]</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="04-trou-con-again"><a class="anchor" href="#04-trou-con-again"></a>4.3. Test connectivity again via command line</h3>
<div class="paragraph">
<p>Once <em>Gateway</em> object has been modified in Openshift, it is required to test your application again through the OCP router:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in routes namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n openshift-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">OCP Routers Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-routers-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-routers-pods.png" alt="ocp routers pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the router pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project openshift-ingress
POD=$(oc get po -o jsonpath='{.items[0].metadata.name}' -n openshift-ingress)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl -XGET -v --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" <a href="http://istio-ingressgateway.istio-system.svc.cluster.local:80" class="bare">http://istio-ingressgateway.istio-system.svc.cluster.local:80</a> -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response 503</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-04-gw-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-04-gw-ok.png" alt="jump app trou 04 gw ok"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this time, you obtain a 503 error because the service is unavailable but this host exists and it is reachable
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-gateway"><a class="anchor" href="#04-gateway"></a>5. Test Ingress Gateway &#8594; Sidecar Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ingress-gw-sidecar.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ingress-gw-sidecar.png" alt="jump app ingress gw sidecar"></a></span></p>
</div>
<div class="sect2">
<h3 id="04-gateway-con"><a class="anchor" href="#04-gateway-con"></a>5.1. Test connectivity via command line</h3>
<div class="paragraph">
<p>In order to verify the connectivity from the <em>Ingress gateway</em> to the <em>Envoy Sidecar</em>, via back-golang <em>k8s service</em>, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio ControlPlane Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" alt="ocp istio controlplane pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl -XGET -v --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" <a href="http://back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442" class="bare">http://back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442</a> -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response Error</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-04-svc.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-04-svc.png" alt="jump app trou 04 svc"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this time, you obtain <em>"Could not resolve host: back-golang.user1-namespace.svc.cluster.local"</em> because <em>back-golang.svc.cluster.local</em> k8s service is not found
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="04-gateway-fix"><a class="anchor" href="#04-gateway-fix"></a>5.2. Fix configuration problems</h3>
<div class="paragraph">
<p>After test the connectivity from the from the <em>Ingress Gateway</em> to the <em>Envoy Sidecar</em>, via back-golang <em>k8s service</em>, you should create the <em>back-golang</em> k8s service again in order to allow this connections.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 04-ingress-traffic-troubleshooting/01-jump-app-back-golang-svc.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">back-golang k8s Service Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-04-svc-created.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-04-svc-created.png" alt="jump app trou 04 svc created"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="04-gateway-con-again"><a class="anchor" href="#04-gateway-con-again"></a>5.3. Test connectivity again via command line</h3>
<div class="paragraph">
<p>Once the k8s service has been created again in Openshift, it is required to test your application again through the <em>Ingress Gateway</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio ControlPlane Pods</div>
<p>04-troubleshooting/ocp-istio-controlplane-pods.png[]</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>ingress gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl -XGET -v --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" <a href="http://istio-ingressgateway.istio-system.svc.cluster.local:80" class="bare">http://istio-ingressgateway.istio-system.svc.cluster.local:80</a> -v</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-unavailable-back.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-unavailable-back.png" alt="jump app unavailable back"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this time, you obtain a 200 in this command but <em>external access</em> has an error because the service is unavailable but the k8s service is OK
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="04-gateway-fix2"><a class="anchor" href="#04-gateway-fix2"></a>5.4. Fix configuration problems</h3>
<div class="paragraph">
<p>After test the connectivity from the from the <em>Ingress Gateway</em> to the <em>Envoy Sidecar</em>, via <em>k8s service</em>, you should review the <em>Virtual Service</em> and <em>Destination Rule</em> objects configuration in order to verify their definition. Please, visit the Kiali console <strong>&lt;kiali_url&gt;</strong> and review the objects general state:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali-trou-04-vs-dr.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali-trou-04-vs-dr.png" alt="jump app kiali trou 04 vs dr"></a></span></p>
</div>
<div class="paragraph">
<div class="title">Kiali Console Virtual Service Error</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali-trou-04-error-vs.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali-trou-04-error-vs.png" alt="jump app kiali trou 04 error vs"></a></span></p>
</div>
<div class="paragraph">
<p>If you take a look at the host paths closely you can find a bad definition because of the pattern <strong>"-fail"</strong> included in the path. Please, modify this hostname and click on <strong>[ SAVE ]</strong>.</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console Destination Rule Error</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali-trou-04-error-dr.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali-trou-04-error-dr.png" alt="jump app kiali trou 04 error dr"></a></span></p>
</div>
<div class="paragraph">
<p>Lastly, if you take a look at the label version you can find a bad definition. Please, replace <strong>fail</strong> with <strong>v1</strong> version and click on <strong>[ SAVE ]</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="04-gateway-con-again2"><a class="anchor" href="#04-gateway-con-again2"></a>5.5. Test connectivity again via command line</h3>
<div class="paragraph">
<p>Once these objects have been modified in Kiali, it is required to test your application again through the Ingress Gateway:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio ControlPlane Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" alt="ocp istio controlplane pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
PPOD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl -XGET -v --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" <a href="http://istio-ingressgateway.istio-system.svc.cluster.local:80" class="bare">http://istio-ingressgateway.istio-system.svc.cluster.local:80</a> -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response 200</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-04-vsdr-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-04-vsdr-ok.png" alt="jump app trou 04 vsdr ok"></a></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-sidecar"><a class="anchor" href="#04-sidecar"></a>6. Test Sidecar &#8594; App Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ingress-sidecar-app.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ingress-sidecar-app.png" alt="jump app ingress sidecar app"></a></span></p>
</div>
<div class="sect2">
<h3 id="04-sidecar-test"><a class="anchor" href="#04-sidecar-test"></a>6.1. Test connectivity via command line</h3>
<div class="paragraph">
<p>In order to verify the connectivity from the <em>Envoy Sidecar</em> to the <em>App</em> containers in the same pods, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in your namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump_app_pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump_app_pods.png" alt="jump app pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>back-golang</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
oc exec -ti &lt;back-golang_pod_id&gt; -c istio-proxy -- sh</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl -XGET -v --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" <a href="http://localhost:8442" class="bare">http://localhost:8442</a></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response 200</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-04-sidecar-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-04-sidecar-ok.png" alt="jump app trou 04 sidecar ok"></a></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-test"><a class="anchor" href="#04-test"></a>7. Confirm <em>Jump App</em> is running again</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been modified and fixed in Kiali and Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-pods-2-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-pods-2-ok.png" alt="jump app pods 2 ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Back</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-back-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-back-ok.png" alt="jump app back ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser. In addition, configure <strong>[ 1000 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
<div class="literalblock">
<div class="content">
<pre>...{"code":200,"message":"/jump - Greetings from Python!"}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Front Web UI Multi Jumps</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-front-jumps-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-front-jumps-ok.png" alt="jump app front jumps ok"></a></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is required to accept <strong>self-signed certificates</strong> provided by Openshift
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Openshift Self-signed Certificates Warning</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/certs_warning.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/certs_warning.png" alt="certs warning" width="50%"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-kiali"><a class="anchor" href="#04-kiali"></a>8. Visit Kiali</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this time, <em>Jump App</em> is generating traffic flow thanks to the frontend where it was given an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit the Kiali console <strong>&lt;kiali_url&gt;</strong>:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali.png" alt="jump app kiali"></a></span></p>
</div>
</div>
</div>
<h1 id="_lab_5_service_mesh_secure_ingress_traffic_flow" class="sect0"><a class="anchor" href="#_lab_5_service_mesh_secure_ingress_traffic_flow"></a>Lab 5 - Service Mesh Secure Ingress Traffic Flow</h1>
<div class="sect1">
<h2 id="05-sds"><a class="anchor" href="#05-sds"></a>1. Secure Gateways with SDS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you know, Gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>During this step, you will review how to expose a secure HTTPS service through Openshift Router using a Gateway, a custom certificate and Istio Secret Discovery Service (SDS).</p>
</div>
<div class="sect2">
<h3 id="05-sds-addcert"><a class="anchor" href="#05-sds-addcert"></a>1.1. Create in Istio the Custom Certificate using SDS</h3>
<div class="paragraph">
<p>In order to configure a new certificate in SDS, it is required to create a new <em>secret</em> in Openshift to save the respective files.</p>
</div>
<div class="paragraph">
<p>Please, create this new <strong>secret</strong> executing the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -n istio-system secret tls $USER_NAMESPACE-credential --key=./05-secure-ingress-traffic-troubleshooting/front.jumpapp.com.key --cert=./05-secure-ingress-traffic-troubleshooting/front.jumpapp.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Secret Created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-secret-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-secret-ok.png" alt="jump app secret ok"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="05-sds-route"><a class="anchor" href="#05-sds-route"></a>1.2. Modify back-golang Route in istio-system Namespace</h3>
<div class="paragraph">
<p>Once the new <em>secret</em> has been created, it is time to modify the back-golang OCP route in order to configure it as a <em>passthrough</em> route. With passthrough termination, encrypted traffic is sent straight to the <em>Ingress Gateway</em> without the router providing TLS termination. Therefore no key or certificate is required.</p>
</div>
<div class="paragraph">
<p>Please, modify back-golang OCP route in <strong>istio-system</strong> namespace through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/00-jump-app-golang-route.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">back-golang Route Modified</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-routes-sds-mod.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-routes-sds-mod.png" alt="jump app routes sds mod"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="05-sds-gw"><a class="anchor" href="#05-sds-gw"></a>1.3. Configure Gateway</h3>
<div class="paragraph">
<p>If you remember, a gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>In order to serve this new certificate when you are accessing to <em>Jump App</em> back-golang service, it is required to modify the respective Gateway.</p>
</div>
<div class="paragraph">
<p>Please, modify existing frontend <strong>gateway</strong> object executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/01-jump-app-golang-gw.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">back-golang Gateway Modified</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-gw-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-gw-ok.png" alt="jump app gw ok"></a></span></p>
</div>
<div class="paragraph">
<p>In order to ensure the Istio Secret Discovery Service (SDS) has been configured properly, you can review the <em>istio ingress gateway</em> pod as shown the following picture:</p>
</div>
<div class="paragraph">
<div class="title">Secret Added to SDS</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-sds-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-sds-ok.png" alt="jump app sds ok"></a></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-test-fail"><a class="anchor" href="#05-test-fail"></a>2. Confirm <em>Jump App</em> is running</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <em>Jump App</em> SDS has been modified, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="paragraph">
<p>Please, execute the following steps in order to review your demo app current state after the customization:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-pods-2-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-pods-2-ok.png" alt="jump app pods 2 ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Back Unavailable</div>
<p><span class="image unresolved"><a class="image" href="../_images/04-troubleshooting/04-troubleshooting/jump-app-unavailable-back-route.png" target="_blank" rel="noopener"><img src="04-troubleshooting/04-troubleshooting/jump-app-unavailable-back-route.png" alt="jump app unavailable back route"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser.In addition, configure <strong>[ 1 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Front with Errors</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-unavailable-front.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-unavailable-front.png" alt="jump app unavailable front"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An error message appears when the frontend tries to call backend services
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-router"><a class="anchor" href="#05-router"></a>3. Openshift Router &#8594; Ingress Gateway Secure Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ingress-router-gw-sec.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ingress-router-gw-sec.png" alt="jump app ingress router gw sec"></a></span></p>
</div>
<div class="sect2">
<h3 id="05-trou-con"><a class="anchor" href="#05-trou-con"></a>3.1. Test connectivity via command line</h3>
<div class="paragraph">
<p>In order to verify the secure connectivity from the <em>OCP Routers</em> to the <em>Ingress Gateway</em>, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in routes namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n openshift-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">OCP Router Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-routers-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-routers-pods.png" alt="ocp routers pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the router pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project openshift-ingress
POD=$(oc get po -o jsonpath='{.items[0].metadata.name}' -n openshift-ingress)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:istio-ingressgateway.istio-system.svc.cluster.local:443 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response 200</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-gw.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-gw.png" alt="jump app trou 05 gw"></a></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that the <em>Ingress Gateway</em> is exposing back-golang service properly. For this reason, you can conclude the problem is located at the OCP route level
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-fix"><a class="anchor" href="#05-trou-fix"></a>3.2. Fix configuration problems</h3>
<div class="paragraph">
<p>After test the connectivity from the <em>OCP routers</em> to the <em>ingress gateway</em>, you should review the <em>Route</em> object configuration in order to verify its definition. Please, visit the OCP console <strong>&lt;ocp_cluster_console&gt;</strong> and review this object current state:</p>
</div>
<div class="paragraph">
<div class="title">OCP Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ocp-trou-05.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ocp-trou-05.png" alt="jump app ocp trou 05"></a></span></p>
</div>
<div class="paragraph">
<div class="title">OCP Console Bad Configuration</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ocp-trou-05-error.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ocp-trou-05-error.png" alt="jump app ocp trou 05 error"></a></span></p>
</div>
<div class="paragraph">
<p>If you take a look at the <em>target port</em> closely, you can find <em>http2</em>. In order to support passthrough routes and connect with <em>Ingress Gateway</em> secure ports, it is required define a secured port. Please, <em>edit route</em>, define <em>https</em> as target port and click on <strong>[ SAVE ]</strong>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-gateway"><a class="anchor" href="#05-gateway"></a>4. Ingress Gateway &#8594; Envoy Sidecar Secure Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-ingress-envoy-gw-sec.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-ingress-envoy-gw-sec.png" alt="jump app ingress envoy gw sec"></a></span></p>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-forcessl"><a class="anchor" href="#05-trou-gateway-forcessl"></a>4.1. Force mTLS in your namespace</h3>
<div class="paragraph">
<p>In Istio, <em>PeerAuthentication</em> defines how traffic will be tunneled (or not) to the sidecar. In order to force all connections are secured, it is required to create the following objects using the next command:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/02-jump-app-sec-services.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">PeerAuthentication and Destination Rule created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-padr.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-padr.png" alt="jump app trou 05 padr"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-con"><a class="anchor" href="#05-trou-gateway-con"></a>4.2. Test connectivity via command line</h3>
<div class="paragraph">
<p>In order to verify the secure connectivity from the <em>Ingress Gateway</em> to the <em>Envoy Sidecar</em>, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio ControlPlane Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" alt="ocp istio controlplane pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response <em>Connection reset by peer</em></div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv.png" alt="jump app trou 05 k8ssrv"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You are receiving <strong>curl: (56) Recv failure: Connection reset by peer</strong> because <em>PeerAuthentication STRICT</em> mode is enabled
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-evoy-con"><a class="anchor" href="#05-trou-gateway-evoy-con"></a>4.3. Emulate regular <em>Ingress Gateway</em> connectivity via command line</h3>
<div class="paragraph">
<p>At this point, it is time to understand how Service Mesh generates envoy traffic internal certificates. In this step, you should be able to generate a certificate from the Istio CA in order to stablish a mTLS secure connection from the <em>Ingress Gateway</em> to the <em>Envoy Sidecar</em>, back-golang.</p>
</div>
<div class="paragraph">
<p>Please, execute the following steps in order to perform the previous tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract Istio CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
oc extract secret/istio-ca-secret --to=. -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio CA Certs</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-ca-certs.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-ca-certs.png" alt="ocp istio ca certs"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a openssl configuration file in order to be able to generate a x509v3 certificate</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">cat &lt;&lt;EOF &gt; openssl.conf
[req]
default_bits = 2048
encrypt_key  = no # Change to encrypt the private key using des3 or similar
default_md   = sha256
prompt       = no
utf8         = yes
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[v3_req]
basicConstraints     = CA:FALSE
keyUsage             = digitalSignature, keyEncipherment
extendedKeyUsage     = clientAuth, serverAuth
subjectAltName       = @alt_names
[alt_names]
URI = spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account
EOF</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a certificate request</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl req -out istio.test.csr -newkey rsa:2048 -nodes -keyout istio.test.key -subj "/"</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">New Certificate Request</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-gen-cert-req.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-gen-cert-req.png" alt="ocp istio gen cert req"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a certificate using these CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl x509 -req -days 365 -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -in istio.test.csr -out  istio.test.crt -extensions v3_req -extfile openssl.conf</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">New Istio CA signed Certificate</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-gen-cert.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-gen-cert.png" alt="ocp istio gen cert"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Istio ControlPlane Pods</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/ocp-istio-controlplane-pods.png" alt="ocp istio controlplane pods"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy certificates to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc exec $POD -- mkdir -p /var/run/secrets/workload-spiffe-credentials/tmp/
oc exec $POD -- mkdir /var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp istio.test.crt $POD:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp istio.test.key $POD:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp ca-cert.pem $POD:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD
cd /var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Perform a HTTP request to the k8s service <em>back-golang</em> using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response <em>Certificate required</em></div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv-cert.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv-cert.png" alt="jump app trou 05 k8ssrv cert"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Once again, perform a HTTP request to the k8s service <em>back-golang</em> using previous certificates in this time</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v --cacert ca-cert.pem --cert istio.test.crt --key istio.test.key</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">HTTP Response 200</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv-cert-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-trou-05-k8ssrv-cert-ok.png" alt="jump app trou 05 k8ssrv cert ok"></a></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-test"><a class="anchor" href="#05-test"></a>5. Confirm <em>Jump App</em> is running again</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been modified and fixed in Kiali and Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Pods Mesh</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-pods-2-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-pods-2-ok.png" alt="jump app pods 2 ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Jump App Routes</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Back</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-back-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-back-ok.png" alt="jump app back ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser. In addition, configure <strong>[ 1000 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
<div class="literalblock">
<div class="content">
<pre>...{"code":200,"message":"/jump - Greetings from Python!"}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Jump App Front Web UI Multi Jumps</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-front-jumps-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-front-jumps-ok.png" alt="jump app front jumps ok"></a></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is required to accept <strong>self-signed certificates</strong> provided by Openshift
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Openshift Self-signed Certificates Warning</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/certs_warning.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/certs_warning.png" alt="certs warning" width="50%"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-kiali"><a class="anchor" href="#05-kiali"></a>6. Visit Kiali</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this time, <em>Jump App</em> is generating traffic flow thanks to the frontend where it was given an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit the Kiali console <strong>&lt;kiali_url&gt;</strong>:</p>
</div>
<div class="paragraph">
<div class="title">Kiali Console</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali.png" alt="jump app kiali"></a></span></p>
</div>
</div>
</div>
<h1 id="_lab_6_service_mesh_secure_egress_traffic_flow" class="sect0"><a class="anchor" href="#_lab_6_service_mesh_secure_egress_traffic_flow"></a>Lab 6 - Service Mesh Secure Egress Traffic Flow</h1>
<div class="sect1">
<h2 id="06-sds"><a class="anchor" href="#06-sds"></a>1. Secure Egress Traffic with mTLS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you know, Gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>During this step, you will review how to work with a secure HTTPS service through Egress Gateway and a custom certificate.</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-egress-traffic.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-egress-traffic.png" alt="jump app egress traffic"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="06-addcert"><a class="anchor" href="#06-addcert"></a>2. Create the <em>External Service</em></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this part, you will create an <em>external service</em> in Openshift but away from the <em>Service Mesh</em> in order to create a secure service protected by mTLS.</p>
</div>
<div class="paragraph">
<p>Just a information, this service is based on Nginx server with a custom certificates generated with openssl.</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-egress-service.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-egress-service.png" alt="jump app egress service"></a></span></p>
</div>
<div class="sect2">
<h3 id="06-addcerts"><a class="anchor" href="#06-addcerts"></a>2.1. Add a Custom Certificate</h3>
<div class="paragraph">
<p>First of all, it is required to create the certificates which will be used by the Nginx server in order to authorize client access.</p>
</div>
<div class="paragraph">
<p>Please, follow the next steps in order to create these certificates in Kubernetes secrets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a root certificate and private key to sign the certificate for your services</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=example Inc./CN=example.com' -keyout example.com.key -out example.com.crt</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a certificate and a private key for your custom service <strong>my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local</strong></p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl req -out my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local.csr -newkey rsa:2048 -nodes -keyout my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local.key -subj "/CN=my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local/O=some organization"
openssl x509 -req -days 365 -CA example.com.crt -CAkey example.com.key -set_serial 0 -in my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local.csr -out my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local.crt</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate client certificate and private key:</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl req -out client.example.com.csr -newkey rsa:2048 -nodes -keyout client.example.com.key -subj "/CN=client.example.com/O=client organization"
openssl x509 -req -days 365 -CA example.com.crt -CAkey example.com.key -set_serial 1 -in client.example.com.csr -out client.example.com.crt</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create Kubernetes Secrets to hold the server’s and CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE-mesh-external
oc create -n $USER_NAMESPACE-mesh-external secret tls nginx-server-certs --key my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local.key --cert my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local.crt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Server certificates OK</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-svc-cert-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-svc-cert-ok.png" alt="jump app mesh external svc cert ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create secret to hold the CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -n $USER_NAMESPACE-mesh-external secret generic nginx-ca-certs --from-file=example.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">CA certificates OK</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-ca-cert-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-ca-cert-ok.png" alt="jump app mesh external ca cert ok"></a></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="06-createnginx"><a class="anchor" href="#06-createnginx"></a>3. Create Nginx service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the certificates have been created, you should create a configuration file which contains the security settings and then deploy the Nginx server.</p>
</div>
<div class="paragraph">
<p>Please, perform the following steps in order to meet the previous requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create <em>nginx.conf</em> file in a configmap</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create configmap nginx-configmap -n $USER_NAMESPACE-mesh-external --from-file=nginx.conf=./06-secure-egress-traffic-troubleshooting/nginx.conf</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Nginx config file OK</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-conf-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-conf-ok.png" alt="jump app mesh external nginx conf ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy the Nginx server</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 06-secure-egress-traffic-troubleshooting/00-nginx-svc-pod.yml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE-mesh-external</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Nginx deployment and service ok</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-deployment-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-deployment-ok.png" alt="jump app mesh external nginx deployment ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check if the nginx pod is ready</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n $USER_NAMESPACE-mesh-external</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Nginx pod ok</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-pods-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-pods-ok.png" alt="jump app mesh external nginx pods ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check if the nginx service is ready</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE-mesh-external
POD=$(oc get po -l run=my-nginx -o jsonpath='{.items[0].metadata.name}')
oc rsh $POD curl <a href="https://localhost:443" class="bare">https://localhost:443</a> -k -v</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Nginx service mTLS ERROR</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-svc-ok-404.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-svc-ok-404.png" alt="jump app mesh external nginx svc ok 404"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You have deployed a mTLS service and you are receiving a <em>400 Bad Request</em> error because you are not using certificates to access to this service
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="06-createtesting"><a class="anchor" href="#06-createtesting"></a>4. Create the Testing Microservice</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to test your Nginx service, it is required to create a microservice-based testing tool which allows you to stablish secure connections based on mTLS.</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-test-tool.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-test-tool.png" alt="jump app test tool"></a></span></p>
</div>
<div class="sect2">
<h3 id="06-createtestingcerts"><a class="anchor" href="#06-createtestingcerts"></a>4.1. Add a Custom Certificate</h3>
<div class="paragraph">
<p>First of all, it is required to create the client and CA certificates in order to be able to generate secure connections.</p>
</div>
<div class="paragraph">
<p>Please, follow the next steps to allocate these certificates in Kubernetes secret objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create Kubernetes Secrets to hold the client’s certificates</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
oc create -n $USER_NAMESPACE secret tls nginx-client-certs --key client.example.com.key --cert client.example.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Client certificates OK</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-access-certs.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-access-certs.png" alt="jump app mesh external nginx access certs"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create Kubernetes Secrets to hold the CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -n $USER_NAMESPACE secret generic nginx-ca-certs --from-file=example.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">CA certificates OK</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-access-ca-certs.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-access-ca-certs.png" alt="jump app mesh external nginx access ca certs"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="06-createtestingdepl"><a class="anchor" href="#06-createtestingdepl"></a>4.2. Create Testing Deployment</h3>
<div class="paragraph">
<p>Once the certificates have been saved in Openshift, it is time to deploy your testing microsevice deployment. Essentially, this microservice is a container image with <em>curl</em> installed.</p>
</div>
<div class="paragraph">
<p>Please, follow the next steps to deploy this new microservice in your main namespace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create testing <em>Service</em> and <em>Deployment</em></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 06-secure-egress-traffic-troubleshooting/01-jump-app-sleep-svc-pod.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Testing service created</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-client-pod.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-client-pod.png" alt="jump app mesh external nginx client pod"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Test service pod is runnign</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Testing service pod OK</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/lojump-app-mesh-external-nginx-client-pod-okgin.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-client-pod-ok.png" alt="jump app mesh external nginx client pod ok"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="06-createsevstest"><a class="anchor" href="#06-createsevstest"></a>4.3. Test Nginx service through testing tool</h3>
<div class="ulist">
<ul>
<li>
<p>Test nginx service via testing microservice</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
POD=$(oc get po -l app=sleep -o jsonpath='{.items[0].metadata.name}')
oc exec -it $POD -c sleep -- curl -v --cacert /etc/nginx-ca-certs/example.com.crt --cert /etc/nginx-client-certs/tls.crt --key /etc/nginx-client-certs/tls.key <a href="https://my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local" class="bare">https://my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local</a> -k</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Nginx service with mTLS</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-client-mtls-ok.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-client-mtls-ok.png" alt="jump app mesh external nginx client mtls ok"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Verify that the server requires the client’s certificate</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
POD=$(oc get po -l app=sleep -o jsonpath='{.items[0].metadata.name}')
oc exec -it $POD -c sleep -- curl -v <a href="https://my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local" class="bare">https://my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local</a> -k</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Nginx service mTLS ERROR</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-svc-ok-404.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-svc-ok-404.png" alt="jump app mesh external nginx svc ok 404"></a></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You have deployed a nginx mTLS service and you are receiving a <em>400 Bad Request</em> error because of not using certificates to access to this service
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="06-configureegressaccess"><a class="anchor" href="#06-configureegressaccess"></a>5. Configure mutual TLS origination for egress traffic</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-egress-traffic-graph.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-egress-traffic-graph.png" alt="jump app egress traffic graph"></a></span></p>
</div>
<div class="paragraph">
<p>When you have the testing tool and the Nginx service up and running, it is time to introduce the <em>Egress Gateway</em>.</p>
</div>
<div class="paragraph">
<p>As you know, an <em>Egress Gateway</em> defines exit points from the mesh. Egress gateways allow you to apply Istio features, for example, monitoring and route rules, to traffic exiting the mesh.</p>
</div>
<div class="paragraph">
<p>They are extensively used in organizations that have a strict security requirement that all traffic leaving the service mesh must flow through a set of dedicated nodes. These nodes will run on dedicated machines, separated from the rest of the nodes running applications in the cluster. These special nodes will serve for policy enforcement on the egress traffic and will be monitored more thoroughly than other nodes.</p>
</div>
<div class="paragraph">
<p>Another use case is a cluster where the application nodes don’t have public IPs, so the in-mesh services that run on them cannot access the Internet. Defining an egress gateway, directing all the egress traffic through it, and allocating public IPs to the egress gateway nodes allows the application nodes to access external services in a controlled way.</p>
</div>
<div class="paragraph">
<p>Taking this into account, it is time to create a set of <em>Istio objects</em> in your namespace in order to make able this connectivity through the <em>Egress Gateway</em>. Please, follow the next steps to implement this scenario:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a <em>Gateway</em> for nginx.example.com, port 443, a <em>destination rule</em> and a <em>virtual service</em> to direct the traffic through the egress gateway</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 06-secure-egress-traffic-troubleshooting/02-jump-app-egress-gw-dr.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Gateway, Virtual Service and Destination Rules OK</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-access-egress-objects-new.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-access-egress-objects-new.png" alt="jump app mesh external nginx access egress objects new"></a></span></p>
</div>
<div class="sect2">
<h3 id="_configure_the_egress_gateway"><a class="anchor" href="#_configure_the_egress_gateway"></a>5.1. Configure the <em>Egress Gateway</em></h3>
<div class="paragraph">
<p>Finally, it is required to configure the <em>Egress Gateway</em> to map the client certificates in order to be able to connect to <em>external service</em> with mTLS security.</p>
</div>
<div class="paragraph">
<p>On the other hand, it is required create a set of Istio objects in <em>istio-system</em> namespace in order to configure the <em>Egress Gateway</em> envoy proxy.</p>
</div>
<div class="paragraph">
<p>Please, follow the next steps to perform the previous tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the TLS certificate in a Kubernetes secret</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create secret -n istio-system generic $USER_NAMESPACE-mesh-external-egress-nginx-client-certs  --from-file=tls.key=client.example.com.key  --from-file=tls.crt=client.example.com.crt  --from-file=ca.crt=example.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Nginx client egress certificate</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-istio-system-certs.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-istio-system-certs.png" alt="jump app mesh external nginx istio system certs"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a <em>destination rule</em> and a <em>service entry</em> to direct the traffic from the egress gateway to the external service</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 06-secure-egress-traffic-troubleshooting/03-istio-system-dr-sds.yml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n istio-system</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Nginx service destination rule and service entry</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-nginx-dr-se.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-nginx-dr-se.png" alt="jump app mesh nginx dr se"></a></span></p>
</div>
</div>
<div class="sect2">
<h3 id="06-testexternalservice"><a class="anchor" href="#06-testexternalservice"></a>5.2. Test the <em>external service</em></h3>
<div class="paragraph">
<p>Once you have the <em>external service</em>, the <em>test tool microservice</em> and the <em>Egress Gateway</em> configuration deployed, it is time to test the access from the application pod to the <em>external service</em> via <em>Egress Gateway</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Test nginx service through testing pod via egress gateway</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
POD=$(oc get po -l app=sleep -o jsonpath='{.items[0].metadata.name}')
oc exec -it $POD -c sleep -- curl -v <a href="http://my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local" class="bare">http://my-nginx.$USER_NAMESPACE-mesh-external.svc.cluster.local</a> -k</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">nginx.example.com mTLS connection OK</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-mesh-external-nginx-access-egress-con-ok-mtls.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-mesh-external-nginx-access-egress-con-ok-mtls.png" alt="jump app mesh external nginx access egress con ok mtls"></a></span></p>
</div>
</div>
</div>
</div>
<h1 id="_lab_7_troubleshooting_tools" class="sect0"><a class="anchor" href="#_lab_7_troubleshooting_tools"></a>Lab 7 - Troubleshooting Tools</h1>
<div class="sect1">
<h2 id="07-jaeger"><a class="anchor" href="#07-jaeger"></a>1. See traces in Jaeger</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Distributed tracing is a technique that is used to tie the information about different units of work together—usually executed in different processes or hosts—in order to understand a whole chain of events in a distributed transaction. Distributed tracing lets developers visualize call flows in large service oriented architectures. It can be invaluable in understanding serialization, parallelism, and sources of latency.</p>
</div>
<div class="paragraph">
<p>OpenShift Service Mesh comes with Jaeger and you can use it to monitor distributed transactions, optimize performance and latency and to perform root cause analysis.</p>
</div>
<div class="paragraph">
<p>Before opening Jaeger to see the traces of the <em>Jump App</em> application, you need to create traffic, so go to the <strong>front</strong> and make several requests. After that open Jaeger, you can find the route like this:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep jaeger</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once in Jaeger, select <code>back-golang.&lt;user-namespace&gt;</code> as the Service in the left menu and then click at the bottom on "Find Traces". You will see that several traces appear on the right:</p>
</div>
<div class="paragraph">
<div class="title">Traces in jaeger</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-jaeger-traces.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-jaeger-traces.png" alt="jump app jaeger traces"></a></span></p>
</div>
<div class="paragraph">
<p>Click on any of them and you will see the following page will all the jumps your application did and how long did they take:</p>
</div>
<div class="paragraph">
<div class="title">Spans in jaeger</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-jaeger-spans.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-jaeger-spans.png" alt="jump app jaeger spans"></a></span></p>
</div>
<div class="paragraph">
<p>Those are called spans and they represent a logical unit of work in Jaeger that has an operation name, the start time of the operation, and the duration. Spans may be nested and ordered to model causal relationships. This could help you see where is your application spending more time and find bottlenecks in an easy manner.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="07-delay"><a class="anchor" href="#07-delay"></a>2. See a delay in Kiali</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you know from the last course, you can add delay to your applications in the mesh to do some testing. In this lab we are going to add a delay in the <code>back-golang</code> service to see how it shows in Jaeger and Kiali when a service is adding some latency to your workflow.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 07-troubleshooting-tools/00-jump-app-delay.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n $USER_NAMESPACE</code></pre>
</div>
</div>
<div class="paragraph">
<p>You are adding 2 seconds of delay and since there are 2 jumps, the <strong>front</strong> is going to receive the response 4 seconds late. Go to the <strong>front</strong>, set several retries (maybe 10) and the <em>Calls Interval</em> put it in 4 to send requests every 4 seconds. Now go to <em>Kiali</em> and check the delay by toggling the <em>Response Time</em> in the Display menu. You should see something similar to this:</p>
</div>
<div class="paragraph">
<div class="title">See delay in Kiali</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/jump-app-kiali-delay.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/jump-app-kiali-delay.png" alt="jump app kiali delay"></a></span></p>
</div>
<div class="paragraph">
<p>You&#8217;ll notice that requests in <code>back-golang</code> are now taking roughly 2 seconds. This capacity of Kiali to see the response time is another way of watching where your application is spending more time. But you can play with other metrics that Kiali gives you like Request Percentage, Requests per Second and even see the traffic animation and security.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="07-dump"><a class="anchor" href="#07-dump"></a>3. Check a config dump</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another tool you have for troubleshooting is the config dump of the Envoy proxies of the mesh. The config dump has all the information, in JSON format, about how are the Envoy proxies configured in the mesh. To do this, you just need to execute a request to the <code>/config_dump</code> endpoint inside any sidecar in your mesh.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
POD=$(oc get po -l app=back-golang -o jsonpath='{.items[0].metadata.name}')
oc exec -it $POD -c istio-proxy -- curl localhost:15000/config_dump &gt; dump.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will get a very long file that looks like this:</p>
</div>
<div class="paragraph">
<div class="title">Envoy config dump</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/config_dump.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/config_dump.png" alt="config dump"></a></span></p>
</div>
<div class="paragraph">
<p>Take some time checking the config dump, since this file has all the configuration parameters of the Envoy proxies inside the Service Mesh.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="07-stats"><a class="anchor" href="#07-stats"></a>4. Check the stats</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Envoy also has stats of their proxies that you can see by doing a request to the <code>/stats</code> endpoint inside the proxy.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
POD=$(oc get po -l app=back-golang -o jsonpath='{.items[0].metadata.name}')
oc exec -it $POD -c istio-proxy -- curl localhost:15000/stats &gt; stats.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this file you have different metrics that Envoy collects that you can use to see the current status of the mesh. For example, in the previous lab about Traffic Management you used these stats to see the pending requests in the Circuit Breaking section. You can also see the number of http responses, how many times a specific code came in the response, total requests sent, total bytes sent, etc.</p>
</div>
<div class="paragraph">
<p>To know more about all the statistics, you could check the <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats#statistics">Envoy docs</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="07-logging"><a class="anchor" href="#07-logging"></a>5. Envoy logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Envoy even let you change the logging level inside a sidecar by doing some http requests too. If you want to see all the logging possibilities and levels, execute the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
POD=$(oc get po -l app=back-golang -o jsonpath='{.items[0].metadata.name}')
oc exec -it $POD -c istio-proxy -- curl -X POST localhost:15000/logging</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll get something similar to this, which is the list of loggers you can edit to see more information:</p>
</div>
<div class="paragraph">
<div class="title">Active Loggers</div>
<p><span class="image"><a class="image" href="../_images/04-troubleshooting/envoy-logging.png" target="_blank" rel="noopener"><img src="../_images/04-troubleshooting/envoy-logging.png" alt="envoy logging"></a></span></p>
</div>
<div class="paragraph">
<p>Now, you will change the level of one of them:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
POD=$(oc get po -l app=back-golang -o jsonpath='{.items[0].metadata.name}')
oc exec -it $POD -c istio-proxy -- curl -X POST localhost:15000/logging\?http=debug</code></pre>
</div>
</div>
<div class="paragraph">
<p>To check it, run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project $USER_NAMESPACE
POD=$(oc get po -l app=back-golang -o jsonpath='{.items[0].metadata.name}')
oc logs -f $POD -c istio-proxy</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should start seeing http debug logs for that sidecar.</p>
</div>
<div class="paragraph">
<p>Configuration extends to all proxy sidecars, so if you do a <code>config_dump</code> in any sidecar you should get very similar results, but logging is specific for each sidecar, so test watching the logs of another sidecar in your namespace to check that you will not see the http debug logs as in the one you recently modified.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../03-traffic-management/index.html">4. Traffic management - Labs</a></span>
  <span class="next"><a href="../05-security/index.html">6. Security - Labs</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
