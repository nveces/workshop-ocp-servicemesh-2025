<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 1 - Envoy Filters :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/06-extensibility/03-envoy-filters.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kafka-tutorial/" target="_blank">Kafka</a>
            <a class="navbar-item" href="https://devsecops-workshop.github.io/" target="_blank">DevSecOps</a>
            <a class="navbar-item" href="https://acidonper.github.io/redhat-workshop-cicd-gitops/redhat-workshop-cicd-gitops/" target="_blank">CI/CD & GitOps</a>
            <a class="navbar-item" href="https://atarazana.github.io/gramola-gitops-guide/gramola-gitops-guide/" target="_blank">Gramola GitOps Guide</a>
            <a class="navbar-item" href="https://luisarizmendi.github.io/tutorial-secure-onboarding/" target="_blank">Secure Edge device onboarding with RHEL and FDO</a>
            <a class="navbar-item" href="https://xbryan1.github.io/rhte-2023-acm-docs/" target="_blank">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/index.html" target="_blank">Java Inner Loop Dev Guide</a>
            <a class="navbar-item" href="https://atarazana.github.io/kitchensink-guide/" target="_blank">Deploying JBoss EAP applications on OpenShift</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-introduction/index.html">2. Introduction - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_2_complete_application_deployment">Lab 2 - Complete application deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_3_adding_persistent_volumes">Lab 3 - Adding persistent volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_4_configuration_management">Lab 4 - Configuration management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_5_resources">Lab 5 - Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-introduction/index.html#_lab_6_liveness_and_readiness_probes">Lab 6 - Liveness and readiness probes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html">3. Envoy istio Control plane - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_4_istio_envoy_objects_relationship">Lab 4 - Istio-Envoy Objects Relationship</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_5_envoy_proxy">Lab 5 - Envoy Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_6_istio_control_plane">Lab 6 - Istio Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-envoy-istio-control-plane/index.html#_lab_7_istio_global_services">Lab 7 - Istio Global Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../03-traffic-management/index.html">4. Traffic management - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_rhossm_traffic_management_labs">Red Hat OpenShift Service Mesh: Traffic Management Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_1_ingress_gateways">Lab 1 - Ingress Gateways</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_2_requests_routing">Lab 2 - Requests Routing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_3_traffic_shifting_and_weight_balancing">Lab 3 - Traffic Shifting and Weight Balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_4_fault_injection">Lab 4 - Fault Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_5_requests_timeouts">Lab 5 - Requests Timeouts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_6_circuit_breaking">Lab 6 - Circuit Breaking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_7_mirroring_and_dark_launches">Lab 7 - Mirroring and Dark Launches</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-traffic-management/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../04-troubleshooting/index.html">5. Troubleshooting - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_1_setup">Lab 1 - Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_2_deploy_jump_app">Lab 2 - Deploy Jump App</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_3_service_mesh_communication_flows">Lab 3 - Service Mesh Communication Flows</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_4_service_mesh_ingress_traffic_flow">Lab 4 - Service Mesh Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_5_service_mesh_secure_ingress_traffic_flow">Lab 5 - Service Mesh Secure Ingress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_6_service_mesh_secure_egress_traffic_flow">Lab 6 - Service Mesh Secure Egress Traffic Flow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-troubleshooting/index.html#_lab_7_troubleshooting_tools">Lab 7 - Troubleshooting Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../05-security/index.html">6. Security - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_0_warming_up">Lab 0 - Warming up</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_1_setup_demo_applications">Lab 1 - Setup demo applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_2_peerauthentication">Lab 2 - PeerAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_3_authorization_part_1">Lab 3 - Authorization: part 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_4_requestauthentication">Lab 4 - RequestAuthentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../05-security/index.html#_lab_5_authorization_part_2">Lab 5 - Authorization: part 2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">7. Extensibility - Labs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_rhossm_extensibility_labs">Red Hat OpenShift Service Mesh: Extensibility Labs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_1_envoy_filters">Lab 1 - Envoy Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_lab_2_waes">Lab 2 - WebAssembly Extensions</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="03-envoy-filters.html">Lab 1 - Envoy Filters</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/06-extensibility/03-envoy-filters.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab 1 - Envoy Filters</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Envoy exposes a set of APIs that let users and control planes statically and dynamically configure the proxy. By configuring a Listener, users can enable the flow of traffic through the proxy, and then enhance the data flow using several Filters.</p>
</div>
<div class="paragraph">
<p>As the name suggests, a Listener allows Envoy to listen to network traffic at a configured address. Each Listener then defines a set of filters that sit in the data path, collectively forming a filter chain. By composing and arranging a set of filters, users can configure Envoy to translate protocol messages, generate statistics, perform RBAC, etc.</p>
</div>
<div class="paragraph">
<p>Envoy provides numerous built-in filters, and it also provides APIs to let you create your own.</p>
</div>
<div class="sect2">
<h3 id="_ef_object"><a class="anchor" href="#_ef_object"></a>{ef} Object</h3>
<div class="paragraph">
<p>Istio {ef} objects provide a mechanism to customize the Envoy configuration generated by Istio Pilot.</p>
</div>
<div class="paragraph">
<p>You can use an {ef} object to modify values for certain fields, add specific filters, or even add entirely new listeners, clusters, etc. This feature must be used with care, as incorrect configurations could potentially destabilize the entire mesh.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
{efs} are not officially supported in {ossm}. {efs} can be created in {ocp} by referring to the Istio documentation <a href="https://istio.io/v1.6/docs/reference/config/networking/envoy-filter/" target="_blank" rel="noopener">here</a> but any configuration issues are not officially supported: <a href="https://access.redhat.com/solutions/5672521" class="bare" target="_blank" rel="noopener">https://access.redhat.com/solutions/5672521</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unlike other Istio networking objects, {efs} are additively applied. Any number of {efs} can exist for a given workload in a specific namespace. The order of application of these {efs} is as follows: all {efs} in the control plane namespace, followed by all matching {efs} in the workload’s namespace.</p>
</div>
<div class="paragraph">
<p>Some aspects of this API is deeply tied to the internal implementation in {ossm} networking subsystem as well as Envoy’s XDS API. While the {ef} API by itself will maintain backward compatibility, any Envoy configuration provided through this mechanism should be carefully monitored across {ossm} version upgrades, to ensure that deprecated fields are removed and replaced appropriately.</p>
</div>
<div class="paragraph">
<p>When multiple {efs} are bound to the same workload in a given namespace, all patches will be processed sequentially in order of creation time. The behavior is undefined if multiple {ef} configurations conflict with each other.</p>
</div>
</div>
<div class="sect2">
<h3 id="_lab"><a class="anchor" href="#_lab"></a>Lab</h3>
<div class="paragraph">
<p>In the following lab you will deploy <a href="https://httpbin.org" target="_blank" rel="noopener">httpbin.org</a> in {ossm} and then modify its behavior by adding some {efs} to manipulate headers.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_httpbin_using_an_ig"><a class="anchor" href="#_deploy_httpbin_using_an_ig"></a>Deploy httpbin using an {ig}</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following steps will deploy all necessary objects to run <em>httpbin</em> in {ossm}.</p>
</div>
<div class="paragraph">
<p>A {gw}, {vs} and {r} for the {ig} will also be created. Take a look at the <code>httpbin/httpbin.yaml</code> and <code>httpbin/httpbin-route.yaml</code> files to understand what objects are being created.</p>
</div>
<div class="paragraph">
<p>Deploy the application in your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f httpbin/httpbin.yaml \
    -p HTTPBIN_ROUTE="${OCP_HTTPBIN_HOST}" -n ${OCP_NAMESPACE} \
    | oc apply -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will create a route in the <code>istio-system</code> namespace to expose the <em>httpbin</em> service through an Ingress Gateway:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f httpbin/httpbin-route.yaml \
    -p HTTPBIN_ROUTE_NAME="${OCP_USER}-httpbin" -p HTTPBIN_ROUTE="${OCP_HTTPBIN_HOST}" \
    -n ${OCP_NAMESPACE} \
    | oc apply -n istio-system -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait some seconds for all the pods to be ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch oc get pods -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the application is reachable and is running ok:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -s -kI "https://${OCP_HTTPBIN_HOST}"</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">httpbin service working</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_curl.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_curl.png" alt="httpbin curl"></a></span></p>
</div>
<div class="paragraph">
<div class="title">httpbin service through an {ig}</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/ingress_httpbin.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/ingress_httpbin.png" alt="ingress httpbin"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_httpbin_with_a_custom_header"><a class="anchor" href="#_test_httpbin_with_a_custom_header"></a>Test httpbin with a custom header</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>httpbin</em> app offers and endpoint that returns anything passed in requests data.</p>
</div>
<div class="paragraph">
<p>In this example, you are going to query this endpoint using an additional custom header. Now that you have the app deployed you can try this by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -k -H "My-Header: my-value" "https://${OCP_HTTPBIN_HOST}/anything"</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, <em>httpbin</em> app returns a JSON with everything that was passed in the request, including your custom header:</p>
</div>
<div class="paragraph">
<div class="title">httpbin returns a custom header</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_header_1.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_header_1.png" alt="httpbin header 1"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_an_ef_to_create_a_new_header"><a class="anchor" href="#_add_an_ef_to_create_a_new_header"></a>Add an {ef} to create a new header</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s suppose that you need to manipulate this custom header in {ossm} before the request reaches the actual <em>httpbin</em> service. This is something that cannot be performed with regular Istio objects but can be performed with an {ef}.</p>
</div>
<div class="paragraph">
<p>You have two options: develop your own Envoy Filter in C++ like in <a href="https://github.com/envoyproxy/envoy-filter-example" target="_blank" rel="noopener">this example</a>, or use the existing Envoy Lua filter to programmatically create the desired behavior by using a Lua script.</p>
</div>
<div class="paragraph">
<p>For simplicity reasons, in this lab you will use the second approach.</p>
</div>
<div class="paragraph">
<p>This {ef} will check if the custom header exists in the requests and then it will create an additional custom header with the same value of our original header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: httpbin-add-custom-header
spec:
  configPatches:
  - applyTo: HTTP_FILTER <i class="conum" data-value="1"></i><b>(1)</b>
    match:
      context: SIDECAR_INBOUND <i class="conum" data-value="2"></i><b>(2)</b>
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager <i class="conum" data-value="3"></i><b>(3)</b>
    patch:
      operation: INSERT_BEFORE <i class="conum" data-value="4"></i><b>(4)</b>
      value:
        name: lab.httpbin_add_header <i class="conum" data-value="5"></i><b>(5)</b>
        typed_config:
          '@type': type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua <i class="conum" data-value="6"></i><b>(6)</b>
          inlineCode: |
            function envoy_on_request(request_handle) <i class="conum" data-value="7"></i><b>(7)</b>
              request_handle:logDebug("Running Lua filter: lab.httpbin_add_header")

              header = request_handle:headers():get("My-Header")

              if (header)
              then
                request_handle:logDebug("Adding header My-New-Header: " .. header)
                request_handle:headers():add("My-New-Header", header)
              end
            end
  workloadSelector: <i class="conum" data-value="8"></i><b>(8)</b>
    labels:
      app: httpbin</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies where in the Envoy configuration, the patch should be applied.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Selects a class of configurations based on the traffic flow direction and workload type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Match a specific filter chain in a listener.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Operation denotes how the patch should be applied to the selected configuration. In this case it will insert this filter before the selected filter or sub filter.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The name of this filter.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The implementation type of the filter. It should be one of those provided by Envoy or any other developed and added by the user.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Lua code.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Criteria used to select the specific set of pods on which this patch configuration should be applied. If omitted, the set of patches in this configuration will be applied to all workload instances in the same namespace.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To apply an {ef} resource to all workloads (sidecars and gateways) in the system, define the resource in the control plane namespace, without a <em>workloadSelector</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous Lua code will check if the header <em>My-Header</em> already exists in the request and then will add a new header <em>My-New-Header</em> with the same value of <em>My-Header</em>.</p>
</div>
<div class="paragraph">
<p>Note that there are some logging commands in the Lua script. This log traces will appear in the "lua" logger of the Envoy proxy.</p>
</div>
<div class="paragraph">
<p>To test it, create this {ef} in your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab1/envoyfilter-add-header.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now run the same query with your custom header again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -k -H "My-Header: my-value" "https://${OCP_HTTPBIN_HOST}/anything"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It may take some seconds for the configuration to propagate through the mesh before you see it working.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You should see your custom header and the additional header that was created in the {ef}:</p>
</div>
<div class="paragraph">
<div class="title">httpbin returns a new header created in the {ef}</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_header_2.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_header_2.png" alt="httpbin header 2"></a></span></p>
</div>
<div class="paragraph">
<p>You can check wether your filter has been inserted in the filter chain by looking at the Envoy config. In order to do this you can use <em>istioctl</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export HTTPBIN_POD=$(oc get pods --no-headers -n ${OCP_NAMESPACE} | awk '{ print $1 }' | grep httpbin)

istioctl proxy-config listeners -n ${OCP_NAMESPACE} ${HTTPBIN_POD} -o json</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Envoy config including the custom Lua filter</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_envoy_config.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_envoy_config.png" alt="httpbin envoy config"></a></span></p>
</div>
<div class="paragraph">
<p>If you don&#8217;t have <em>istioctl</em> installed you can also run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export HTTPBIN_POD=$(oc get pods --no-headers -n ${OCP_NAMESPACE} | awk '{ print $1 }' | grep httpbin)

oc exec -n ${OCP_NAMESPACE} -it ${HTTPBIN_POD} -c istio-proxy -- curl -X POST localhost:15000/config_dump</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_an_ef_to_remove_the_old_header"><a class="anchor" href="#_add_an_ef_to_remove_the_old_header"></a>Add an {ef} to remove the old header</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have created a new header inside an {ef} based on the value of another one, let&#8217;s suppose that you need to remove the old header before reaching the actual <em>httpbin</em> service.</p>
</div>
<div class="paragraph">
<p>You can create a new filter to remove this header but it is important to notice now that these two filters are order dependent. The filter that remove the header will need to run always after the previous filter or the previous filter will never find the custom header because it have been already removed.</p>
</div>
<div class="paragraph">
<p>To make sure the removal filter is executed last, you will insert it at the end of chain.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: httpbin-remove-custom-header
spec:
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router <i class="conum" data-value="1"></i><b>(1)</b>
    patch:
      operation: INSERT_BEFORE
      value:
        name: lab.httpbin_remove_header
        typed_config:
          '@type': type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
          inlineCode: |
            function envoy_on_request(request_handle)
              request_handle:logDebug("Running Lua filter: lab.httpbin_remove_header")

              header = request_handle:headers():get("My-Header")

              if (header)
              then
                request_handle:logDebug("Removing header My-Header: " .. header)
                request_handle:headers():remove("My-Header") <i class="conum" data-value="2"></i><b>(2)</b>
              end
            end
  workloadSelector:
    labels:
      app: httpbin</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The filter will be inserted before the envoy.filters.http.router_ filter. <em>envoy.filters.http.router</em> filter should always be the latest filter in the chain or Envoy will stop working.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lua code to remove the custom header.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To test it, create this {ef} in your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab1/envoyfilter-remove-header.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now run the same query with your custom header again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -k -H "My-Header: my-value" "https://${OCP_HTTPBIN_HOST}/anything"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see your custom header being replaced with the additional header that was created in the first {ef}, your custom header has been removed:</p>
</div>
<div class="paragraph">
<div class="title">httpbin returns a replaced custom header created in the {ef}</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_header_3.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_header_3.png" alt="httpbin header 3"></a></span></p>
</div>
<div class="paragraph">
<p>You can check the position of your new filter in the filter chain by looking at the Envoy config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export HTTPBIN_POD=$(oc get pods --no-headers -n ${OCP_NAMESPACE} | awk '{ print $1 }' | grep httpbin)

istioctl proxy-config listeners -n ${OCP_NAMESPACE} ${HTTPBIN_POD} -o json</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Envoy config including the removal Lua filter at the end of the chain</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_envoy_config_2.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_envoy_config_2.png" alt="httpbin envoy config 2"></a></span></p>
</div>
<div class="paragraph">
<p>If you don&#8217;t have <em>istioctl</em> installed you can also run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export HTTPBIN_POD=$(oc get pods --no-headers -n ${OCP_NAMESPACE} | awk '{ print $1 }' | grep httpbin)

oc exec -n ${OCP_NAMESPACE} -it ${HTTPBIN_POD} -c istio-proxy -- curl -X POST localhost:15000/config_dump</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, it is possible to review all of this information via Kiali.</p>
</div>
<div class="paragraph">
<div class="title">Envoy config including the removal Lua filter at the end of the chain (Kiali)</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_envoy_config_kiali.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_envoy_config_kiali.png" alt="httpbin envoy config kiali"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_single_ef_to_replace_the_header"><a class="anchor" href="#_create_a_single_ef_to_replace_the_header"></a>Create a single {ef} to replace the header</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The previous examples show how to create two different {efs} to create and remove headers.</p>
</div>
<div class="paragraph">
<p>It is possible to combine the same functionality in a single {ef}. The main purpose of separating the creation and removal of the headers was to notice the importance of the order of creation and insertion of {efs}.</p>
</div>
<div class="paragraph">
<p>In this example you are going to create an {ef} that will combine both actions.</p>
</div>
<div class="paragraph">
<p>First, remove the previous filters from your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete -f lab1/envoyfilter-add-header.yaml -n ${OCP_NAMESPACE}
oc delete -f lab1/envoyfilter-remove-header.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the {ef} with the functionality combined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: httpbin-replace-custom-header
spec:
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager <i class="conum" data-value="1"></i><b>(1)</b>
    patch:
      operation: INSERT_BEFORE
      value:
        name: lab.httpbin_replace_header
        typed_config:
          '@type': type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
          inlineCode: |
            function envoy_on_request(request_handle)
              request_handle:logDebug("Running Lua filter: lab.httpbin_replace_header")

              header = request_handle:headers():get("My-Header")

              if (header)
              then
                request_handle:logDebug("Replacing header My-Header with My-New-Header: " .. header)
                request_handle:headers():add("My-New-Header", header)
                request_handle:headers():remove("My-Header")
              end
            end
  workloadSelector:
    labels:
      app: httpbin</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This will be the only custom filter so you can insert this filter in any order as long as it is inserted in the correct filter chain (inbound HTTP).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To test it, create this {ef} in your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f lab1/envoyfilter-replace-header.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now run the same query with your custom header again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -k -H "My-Header: my-value" "https://${OCP_HTTPBIN_HOST}/anything"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see your custom header being replaced with the additional header and your custom header removed, but this time with only one {ef}:</p>
</div>
<div class="paragraph">
<div class="title">httpbin returns a replaced custom header created in the {ef}</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_header_4.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_header_4.png" alt="httpbin header 4"></a></span></p>
</div>
<div class="paragraph">
<p>Additionally, it is possible to review all of this information via Kiali.</p>
</div>
<div class="paragraph">
<div class="title">Envoy config including the removal Lua filter at the end of the chain (Kiali)</div>
<p><span class="image"><a class="image" href="../_images/06-extensibility/httpbin_envoy_config_kiali_2.png" target="_blank" rel="noopener"><img src="../_images/06-extensibility/httpbin_envoy_config_kiali_2.png" alt="httpbin envoy config kiali 2"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_remove_filters"><a class="anchor" href="#_remove_filters"></a>Remove Filters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure you remove any {ef} you created before moving to the next lab:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete -f lab1/envoyfilter-add-header.yaml -n ${OCP_NAMESPACE}
oc delete -f lab1/envoyfilter-remove-header.yaml -n ${OCP_NAMESPACE}
oc delete -f lab1/envoyfilter-replace-header.yaml -n ${OCP_NAMESPACE}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_remove_httpbin"><a class="anchor" href="#_remove_httpbin"></a>Remove httpbin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before starting the next lab, remove the application in your namespace. This will not remove the {r} created in the first lab.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f httpbin/httpbin.yaml \
    -p HTTPBIN_ROUTE="${OCP_HTTPBIN_HOST}" -n ${OCP_NAMESPACE} \
    | oc delete -n ${OCP_NAMESPACE} -f -</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
