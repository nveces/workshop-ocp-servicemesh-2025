<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Openshift 4 Introduction - Labs :: WorkShop - Service Mesh on OCP 2025</title>
    <link rel="canonical" href="https://nveces.github.io/workshop-ocp-servicemesh-2025/workshop-ocp-servicemesh-2025/introduction/index.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://nveces.github.io/workshop-ocp-servicemesh-2025">WorkShop - Service Mesh on OCP 2025</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-ocp-servicemesh-2025" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../02-deploy.html">2. Deploy Service</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#package">Build Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-deploy.html#deploy">Deploy Dervice</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">WorkShop - Service Mesh on OCP 2025</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">WorkShop - Service Mesh on OCP 2025</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">WorkShop - Service Mesh on OCP 2025</a></li>
    <li><a href="index.html">Openshift 4 Introduction - Labs</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/nveces/workshop-ocp-servicemesh-2025/edit/master/documentation/modules/ROOT/pages/introduction/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Openshift 4 Introduction - Labs</h1>
<div id="toc" class="toc">
<div id="toctitle">Openshift 4 Introduction - Labs</div>
<ul class="sectlevel0">
<li><a href="#_lab_0_warming_up">Lab 0 - Warming up</a>
<ul class="sectlevel1">
<li><a href="#_access_to_openshift_web_console">1. Access to Openshift Web Console</a>
<ul class="sectlevel2">
<li><a href="#_download_the_cli">1.1. Download the CLI</a></li>
<li><a href="#_login_to_openshift_using_oc">1.2. Login to Openshift using oc</a></li>
</ul>
</li>
<li><a href="#_create_your_first_project">2. Create your first project</a></li>
</ul>
</li>
<li><a href="#_lab_1_first_application_deployment">Lab 1 - First application deployment</a>
<ul class="sectlevel1">
<li><a href="#_brief_application_description">1. Brief application description</a></li>
<li><a href="#_deploy_application">2. Deploy application</a>
<ul class="sectlevel2">
<li><a href="#_create_our_first_deployment_in_your_project">2.1. Create our first deployment in your project</a></li>
<li><a href="#_add_a_service_to_your_application">2.2. Add a service to your application</a></li>
<li><a href="#_create_a_route">2.3. Create a route</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_2_complete_application_deployment">Lab 2 - Complete application deployment</a>
<ul class="sectlevel1">
<li><a href="#_deploy_and_ephemeral_postgresql">1. Deploy and ephemeral Postgresql</a></li>
<li><a href="#_connect_application_to_database">2. Connect application to Database</a></li>
<li><a href="#_scale_the_application_pod_replicas">3. Scale the application pod replicas</a>
<ul class="sectlevel2">
<li><a href="#_extra_rolling_vs_recreate_deployment_strategy">3.1. Extra: Rolling vs Recreate deployment strategy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_3_adding_persistent_volumes">Lab 3 - Adding persistent volumes</a>
<ul class="sectlevel1">
<li><a href="#_understanding_storage">1. Understanding storage</a></li>
<li><a href="#_setting_persistent_storage_to_the_database">2. Setting persistent storage to the Database</a></li>
</ul>
</li>
<li><a href="#_lab_4_configuration_management">Lab 4 - Configuration management</a>
<ul class="sectlevel1">
<li><a href="#_short_introduction">1. Short introduction</a></li>
<li><a href="#_configmaps">2. ConfigMaps</a></li>
<li><a href="#_secrets">3. Secrets</a></li>
<li><a href="#_extra_how_quarkus_could_manage_configuration">4. Extra: how Quarkus (could) manage configuration</a></li>
</ul>
</li>
<li><a href="#_lab_5_resources">Lab 5 - Resources</a>
<ul class="sectlevel1">
<li><a href="#_requests_and_limits">1. Requests and limits</a></li>
<li><a href="#_quality_of_service">2. Quality of Service</a></li>
<li><a href="#_configure_resources">3. Configure resources</a></li>
</ul>
</li>
<li><a href="#_lab_6_liveness_and_readiness_probes">Lab 6 - Liveness and readiness probes</a>
<ul class="sectlevel1">
<li><a href="#_what_and_why">1. What and why</a></li>
<li><a href="#_configure_liveness_and_readiness">2. Configure liveness and readiness</a>
<ul class="sectlevel2">
<li><a href="#_application_endpoints">2.1. Application endpoints</a></li>
<li><a href="#_modify_current_deployment">2.2. Modify current deployment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_lab_7_network_policies">Lab 7 - Network Policies</a>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_restrict_traffic_using_networkpolicy_objects">2. Restrict traffic using NetworkPolicy objects</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="_lab_0_warming_up" class="sect0"><a class="anchor" href="#_lab_0_warming_up"></a>Lab 0 - Warming up</h1>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is not a recommended practices guide nor intended to serve as a reference. These series of labs are oriented in such a way that you will have a first contact to the main concepts and how certain changes affects to the state of an application deployment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this preparation lab, we are going to introduce the Openshift web console, get the <code>oc</code> cli binary, and finally, validate that all necessary requirements are successfully accomplished before starting the series of labs.</p>
</div>
<div class="paragraph">
<p>Along these labs, you will refer to a list of variables that have been shared with you before starting the labs. If this is not your case, please let us know.</p>
</div>
<div class="paragraph">
<p>These variables are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>$OCP_CONSOLE</strong>: url for accessing to the
Openshift web console</p>
</li>
<li>
<p><strong>$OCP_API</strong>: Openshift API endpoint. We will use this endpoint when accesing the cluster from the <code>oc</code> cli.</p>
</li>
<li>
<p><strong>$USER</strong>: your private user id used for Openshift authentication</p>
</li>
<li>
<p><strong>$PASSWORD</strong>:  your secret password used for Openshift authentication</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Feel free to export these variables in your environment.</p>
</div>
<div class="paragraph">
<p>There is also a list of files needed to run the labs. These files can be found in the following github repository:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/dsanchor/ocp-intro-dev" class="bare">https://github.com/dsanchor/ocp-intro-dev</a></p>
</div>
<div class="paragraph">
<p>Clone the repository to your desired location, that will then be referred as <strong>$LABS_HOME</strong> during the labs:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ git clone https://github.com/dsanchor/ocp-intro-dev.git $LABS_HOME</pre>
</div>
</div>
<div class="sect1">
<h2 id="_access_to_openshift_web_console"><a class="anchor" href="#_access_to_openshift_web_console"></a>1. Access to Openshift Web Console</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <code><strong>$OCP_CONSOLE</strong></code> url to acces the Openshift Web Console.</p>
</div>
<div class="paragraph">
<p>A login screen will be shown as follow:</p>
</div>
<div class="paragraph">
<div class="title">Default</div>
<p><span class="image unresolved"><img src="login.png" alt="login"></span></p>
</div>
<div class="paragraph">
<div class="title">Exmmaple 2</div>
<p><span class="image"><img src="../_images/introduction/login.png" alt="login"></span></p>
</div>
<div class="paragraph">
<div class="title">Exmmaple 3</div>
<p><span class="image"><a class="image" href="_images/introduction/login.png" target="_blank" rel="noopener"><img src="../_images/introduction/login.png" alt="login"></a></span></p>
</div>
<div class="paragraph">
<p>Enter your <code>username</code> and <code>password</code> and click <code>Log In</code>.</p>
</div>
<div class="paragraph">
<p>If you have successfully logged in, you will arrive to the main dashboard with your current projects. As seen below, the list of projects should be empty:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="empty-projects.png" alt="empty-projects"></span></p>
</div>
<div class="paragraph">
<p>We will soon create our first project, but now, it is time to get the Openshift CLI binaries for your specific OS.</p>
</div>
<div class="paragraph">
<p>&#8658; <em>Additional reads: <a href="https://docs.openshift.com/container-platform/4.6/web_console/web-console.html">Web Console</a></em></p>
</div>
<div class="sect2">
<h3 id="_download_the_cli"><a class="anchor" href="#_download_the_cli"></a>1.1. Download the CLI</h3>
<div class="paragraph">
<p>On the top-right (?) menu, click on <code>Command line tools</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="menu-clt.png" alt="command-line-tools"></span></p>
</div>
<div class="paragraph">
<p>Then, choose the binaries according to your OS:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="cli-download-options.png" alt="cli-download-options"></span></p>
</div>
<div class="paragraph">
<p>Extract the binaries and try it by executing the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc version

Client Version: openshift-clients-4.6.0-202006250705.p0-176-g5797eaeca
Server Version: 4.6.15
Kubernetes Version: v1.19.0+1833054</pre>
</div>
</div>
<div class="paragraph">
<p>The above is an example of what you should get when running the command.</p>
</div>
</div>
<div class="sect2">
<h3 id="_login_to_openshift_using_oc"><a class="anchor" href="#_login_to_openshift_using_oc"></a>1.2. Login to Openshift using oc</h3>
<div class="paragraph">
<p>Once we have the <code>oc</code> cli tool installed, we will first log in into the platform by running:</p>
</div>
<div class="paragraph">
<p><em>Notice that we are using the $VARS we mentioned at the beggining of the labs. If you have not exported them, you will need to manually replace them below.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc login -u $USER -p $PASSWORD $OCP_API

Login successful.

You don't have any projects. You can try to create a new project, by running

    oc new-project &lt;projectname&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>There is not any project yet, so let&#8217;s create it.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_your_first_project"><a class="anchor" href="#_create_your_first_project"></a>2. Create your first project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A project allows a community of users to organize and manage their content in isolation from others.</p>
</div>
<div class="paragraph">
<p>In our labs, you will deploy the demo application and related into your own project.</p>
</div>
<div class="paragraph">
<p>Also notice that sometimes we talk about   <code>namespaces</code>, which is the Kubernetes concept and others about <code>projects</code>. A <code>project</code> is a Kubernetes namespace with additional annotations.</p>
</div>
<div class="paragraph">
<p>&#8658; <em>Additional reads: <a href="https://docs.openshift.com/container-platform/4.6/applications/projects/working-with-projects.html">working with projects</a></em></p>
</div>
<div class="paragraph">
<p>We are now ready to create our first project by running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> $ oc new-project &lt;YOUR_PROJECT&gt;

Now using project "user0" on server "https://api.labs.sandbox779.opentlc.com:6443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app rails-postgresql-example

to build a new example application in Ruby. Or use kubectl to deploy a simple Kubernetes application:

    kubectl create deployment hello-node --image=k8s.gcr.io/serve_hostname</pre>
</div>
</div>
<div class="paragraph">
<p>Well done! :-)</p>
</div>
<div class="paragraph">
<p>If you now move to the <code>Openshift Console</code>, under the <code>Administrator</code> view, you will notice that you have a new <code>Project</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="projects.png" alt="projects"></span></p>
</div>
<div class="paragraph">
<p>We can now start deploying applications into our project.</p>
</div>
</div>
</div>
<h1 id="_lab_1_first_application_deployment" class="sect0"><a class="anchor" href="#_lab_1_first_application_deployment"></a>Lab 1 - First application deployment</h1>
<div class="paragraph">
<p>Once this lab is completed, we will have successfully deployed our first application and we will also have made it externally accesible.</p>
</div>
<div class="paragraph">
<p>The main goals of this lab is to understand some core concepts such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployments</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a></p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.6/rest_api/network_apis/route-route-openshift-io-v1.html">Routes</a></p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_brief_application_description"><a class="anchor" href="#_brief_application_description"></a>1. Brief application description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The application that we are going to use during these labs is called <strong>Pet clinic</strong>. It has been used in different workshops in Red Hat.</p>
</div>
<div class="paragraph">
<p>In our case, we have made some modifications to make it more appropiate to certain use cases we wanted to show during the labs.</p>
</div>
<div class="paragraph">
<p>Next diagram describes the 3 layer application architecture:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="app-arch.png" alt="app-arch"></span></p>
</div>
<div class="paragraph">
<p>It basically manage set of Pets, their Owners and Veterinarians appointments. We will play a bit when needed in the labs.</p>
</div>
<div class="paragraph">
<p>Source code is available <a href="https://github.com/dsanchor/petclinic.git">here</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As these labs are not intended to be a development nor Quarkus workshop, I will not give more details about the application itself unless they are related to Openshift integration.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_application"><a class="anchor" href="#_deploy_application"></a>2. Deploy application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many ways of performing our first deployment (web console, cli options and so on), but I want to start by creating the first deployment using the YAML descriptor.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the full YAML file first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Deployment
apiVersion: apps/v1
metadata:
  name: quarkus-petclinic
  labels:
    app: quarkus-petclinic
spec:
  replicas: 1
  selector:
    matchLabels:
      app: quarkus-petclinic
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 25%
      maxSurge: 25%
  revisionHistoryLimit: 10
  progressDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app: quarkus-petclinic
        deployment: quarkus-petclinic
    spec:
      containers:
        - name: quarkus-petclinic
          image: 'quay.io/dsanchor/quarkus-petclinic:in-mem'
          ports:
            - containerPort: 8080
              protocol: TCP
          resources: {}
          imagePullPolicy: Always</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s focus on each individual parts:</p>
</div>
<div class="paragraph">
<p>First part, there is basically the <code>kind</code> and <code>apiVersion</code> for a <code>Deployment</code> API object and then, we just add a name and a set of <code>labels</code> under <code>metadata</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="d-name.png" alt="deployment name"></span></p>
</div>
<div class="paragraph">
<p>Next, we have the <code>spec</code> part of the object. This is where we basically define the desired state of our <code>Deployment</code>.</p>
</div>
<div class="paragraph">
<p>Grouping some parts of it, we have:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="d-part1.png" alt="deployment part1"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Number of desired pods managed by this <code>Deployment</code> and its <code>ReplicaSet</code></p>
</li>
<li>
<p>Selector, that will basically tell which pods are managed by the <code>ReplicaSet</code>.</p>
</li>
<li>
<p>Deployment strategy, which set how pods are created/destroy during update process.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And finally the template definition, that describes how a pod will look like:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="d-part2.png" alt="deployment part2"></span></p>
</div>
<div class="paragraph">
<p>We will see more details about every part of the <code>pod</code> itself while going through the labs.</p>
</div>
<div class="sect2">
<h3 id="_create_our_first_deployment_in_your_project"><a class="anchor" href="#_create_our_first_deployment_in_your_project"></a>2.1. Create our first deployment in your project</h3>
<div class="paragraph">
<p>As said, we will apply the YAML descriptor into our project. To do so, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/app-deployment.yaml -n &lt;YOUR_PROJECT&gt;

deployment.apps/quarkus-petclinic created</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can move to one project to another with <code>oc project &lt;PROJECT&gt;</code> and there is no need to add the extra <code>-n &lt;PROJECT&gt;</code> to perform actions over the current <code>project</code>, although when having many <code>projects</code>, the <code>-n</code> option will give you the peace and serenity about being doing stuff where you really want to :-)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s also have a look at what has been created already in our project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get all -n &lt;YOUR_PROJECT&gt;

NAME                                     READY   STATUS    RESTARTS   AGE
pod/quarkus-petclinic-7cdcd76595-vrbd2   1/1     Running   0          2m33s

NAME                                READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/quarkus-petclinic   1/1     1            1           2m33s

NAME                                           DESIRED   CURRENT   READY   AGE
replicaset.apps/quarkus-petclinic-7cdcd76595   1         1         1       2m33s</pre>
</div>
</div>
<div class="paragraph">
<p>We have not only a <code>Deployment</code> but a <code>ReplicaSet</code> and a single <code>Pod</code>.</p>
</div>
<div class="paragraph">
<p>By creating a <code>Deployment</code>, a <code>ReplicaSet</code> has been created in order to ensure that the specified number of pods are running at a given moment in time.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s move to the console and see what we have. This time, we will use the <code>Developer</code> view. Select that perspective on the left top corner:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="just-deployment.png" alt="just deployment"></span></p>
</div>
<div class="paragraph">
<p>If you click on the blue circle (2), you will get all details about the application (3).</p>
</div>
<div class="paragraph">
<p>As you can tell, there is not any <code>Service</code> nor <code>Route</code> created for it yet. That means, this application is just locally accesible if you would know the pod ip (unprobable.. and undesired).</p>
</div>
<div class="paragraph">
<p>Click on the <code>pod</code> link (4) and get a terminal screen within that <code>pod</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="pod-terminal.png" alt="pod terminal"></span></p>
</div>
<div class="paragraph">
<p>To test the application locally, execute the following in the terminal:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ curl -v localhost:8080 | grep 200</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In case you did not get a <code>HTTP/1.1 200 OK</code> response, let us know.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_add_a_service_to_your_application"><a class="anchor" href="#_add_a_service_to_your_application"></a>2.2. Add a service to your application</h3>
<div class="paragraph">
<p>Once we tested the application, lets add a <code>Service</code> that will provide us a logical name to access to this application. It will also be used as a load balancer for the possible 'n' pods we may have later for this <code>Deployment</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/app-service.yaml -n &lt;YOUR_PROJECT&gt;

service/quarkus-petclinic created</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you could have ran the next <code>oc</code> command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc expose deployment/quarkus-petclinic --port=8080 -n &lt;YOUR_PROJECT&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Feel free to run again a <em>oc get all</em> to see that the service has been successfully created.</p>
</div>
<div class="paragraph">
<p>Also, if you move back to the console, you will notice that the service is "assigned" to the application:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="with-service.png" alt="with service"></span></p>
</div>
<div class="paragraph">
<p>Test the application again from the <code>pod</code> terminal, but this time use the <code>service</code> name instead:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ curl -v quarkus-petclinic:8080 | grep 200</pre>
</div>
</div>
<div class="paragraph">
<p>Hope you got a <code>HTTP/1.1 200 OK</code>! If that is the case, let&#8217;s make our application externally acessible by adding a <code>route</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_route"><a class="anchor" href="#_create_a_route"></a>2.3. Create a route</h3>
<div class="paragraph">
<p>Apply the following YAML in your project:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/app-route.yaml -n &lt;YOUR_PROJECT&gt;

route.route.openshift.io/quarkus-petclinic created</pre>
</div>
</div>
<div class="paragraph">
<p>As previously mentioned for <code>services</code>, you could use the <code>oc expose</code> command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc expose svc/quarkus-petclinic -n &lt;YOUR_PROJECT&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>It is then time to access to our application using a web browser. To do so, let&#8217;s first get the <code>host</code> where this application is exposed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get route -n &lt;YOUR_PROJECT&gt;

NAME                HOST/PORT                                                  PATH   SERVICES            PORT       TERMINATION   WILDCARD
quarkus-petclinic   quarkus-petclinic-user0.apps.labs.sandbox779.opentlc.com          quarkus-petclinic   8080-tcp                 None</pre>
</div>
</div>
<div class="paragraph">
<p>Copy the value under <code>HOST/PORT</code> column in your preferred web browser. And then&#8230;&#8203; there we go!</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="petclinic-web.png" alt="petclinic"></span></p>
</div>
<div class="paragraph">
<p>Congratulations! You have successfully deployed your first application.</p>
</div>
<div class="paragraph">
<p>Just a few  considerations about the application. This application requires access to a DB in order to persist any change. In this lab, we used an in-memory H2 DB within our application.. so in case you add/remove pets, this changes are only persisted to that single pod.</p>
</div>
<div class="paragraph">
<p>You would also notice that in case you kill/delete the pod, those pets previously created would have been lost.</p>
</div>
<div class="paragraph">
<p>Feel free to perform these very usefull exercises to understand that <em>pods are ephemeral</em>.</p>
</div>
<div class="paragraph">
<p>But no worries, <strong>our pets deserve the best</strong>.. so will deploy a proper DB in the next lab and link the application pods to it.</p>
</div>
</div>
</div>
</div>
<h1 id="_lab_2_complete_application_deployment" class="sect0"><a class="anchor" href="#_lab_2_complete_application_deployment"></a>Lab 2 - Complete application deployment</h1>
<div class="paragraph">
<p>In previous lab, we have just deployed a single application without considering its requirements. We just wanted to have it running and play a bit with Openshift.</p>
</div>
<div class="paragraph">
<p>In this lab, we will deploy a Postgresql Database and we will update the application deployment image to ensure we don&#8217;t use an in-memory DB so we will link the application to the Postgresql DB instead.</p>
</div>
<div class="sect1">
<h2 id="_deploy_and_ephemeral_postgresql"><a class="anchor" href="#_deploy_and_ephemeral_postgresql"></a>1. Deploy and ephemeral Postgresql</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This time, we will do the full deployment from the <code>web console</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s move to the <code>console</code> and select the <code>Developer</code> view.</p>
</div>
<div class="paragraph">
<p>As in next screenshot, first, ensure you are on the right project (it is very likely you are.. unless you have created more than one project), click on <code>Add</code> and select <code>Database</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="dev-add-db.png" alt="add db"></span></p>
</div>
<div class="paragraph">
<p>Then, select <code>Postgresql ephemeral</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="select-postgresql-eph.png" alt="postgresql ephemeral"></span></p>
</div>
<div class="paragraph">
<p>Yes.. we are going to deploy an ephemeral Postgresql&#8230;&#8203; so in case the Postgresql <code>pod</code> is recreated we will lose the data. We will add a persistent volume later in these labs.</p>
</div>
<div class="paragraph">
<p>Click on <code>Instantiate Template</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="instantiate-template.png" alt="instantiate template"></span></p>
</div>
<div class="paragraph">
<p>And set the following parameter values set in red (ensure you use those):</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="db-parameters.png" alt="db parameters"></span></p>
</div>
<div class="paragraph">
<p>As a result, you should see both the application and postgresql pods running:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="apps-pods.png" alt="application pods"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connect_application_to_database"><a class="anchor" href="#_connect_application_to_database"></a>2. Connect application to Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have now the Postgresql pod running, but the application pod is not connected to it yet.</p>
</div>
<div class="paragraph">
<p>For that, we will deploy a new application image tag that has the proper configuration to connect to the DB (the application configuration is set in this <a href="https://github.com/dsanchor/petclinic/blob/mnl-db/quarkus-petclinic/src/main/resources/application.properties">application.properties</a> file).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This approach of defining the configuration within the application (and then, inside the image) could be seen as not very Cloud Native&#8230;&#8203; even when it is somehow set with profiles. To solve this, we will extract this configuration to a <code>ConfigMap</code> later on these labs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is time for deploy a new version of our application. To do so, we will only update the image in our existing deployment:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc set image deployment/quarkus-petclinic *=quay.io/dsanchor/quarkus-petclinic:db  -n &lt;YOUR_PROJECT&gt;

deployment.apps/quarkus-petclinic image updated</pre>
</div>
</div>
<div class="paragraph">
<p>Once the image has been updated, a new pod has been created, while the old one has been terminated. If you missed that process, here it is a short replay:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="rolling-update.gif" alt="rolling update"></span></p>
</div>
<div class="paragraph">
<p>That list of <code>pods</code> could be seen under the <code>Administrator</code> view, then <code>Workloads</code> and finally <code>Pods</code>.</p>
</div>
<div class="paragraph">
<p>We can now test the application again. Feel free to add new owners, pets and so on, those new changes are now persisted in the Database. To validate this behavior, delete the existing application <code>pod</code> and validate that the data is still there when the new <code>pod</code> has been created.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scale_the_application_pod_replicas"><a class="anchor" href="#_scale_the_application_pod_replicas"></a>3. Scale the application pod replicas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, we have just a single replica of our "Pet clinic" web site&#8230;&#8203; That is not high available and fault tolerant at all.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s scale it up to 3 replicas by running the next command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc scale deployment/quarkus-petclinic --replicas=3 -n &lt;YOUR_PROJECT&gt;

deployment.apps/quarkus-petclinic scaled</pre>
</div>
</div>
<div class="paragraph">
<p>You could now continue adding data from the web application, it does not matter from which <code>pod</code> you are accesing to the Database, the same data is accessible from all the application pods.</p>
</div>
<div class="paragraph">
<p>Feel free to scale it down and up again and check that the application works as expected and does not miss any data.</p>
</div>
<div class="sect2">
<h3 id="_extra_rolling_vs_recreate_deployment_strategy"><a class="anchor" href="#_extra_rolling_vs_recreate_deployment_strategy"></a>3.1. Extra: Rolling vs Recreate deployment strategy</h3>
<div class="paragraph">
<p>Have a look at the following resources and then, answer a couple of questions that are related to this topic based on our scenario:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.6/applications/deployments/deployment-strategies.html#deployments-rolling-strategy_deployment-strategies">Rolling</a></p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.6/applications/deployments/deployment-strategies.html#deployments-recreate-strategy_deployment-strategies">Recreate</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So.. could you have a look at what strategies are used in both the application and the Database? Why are they different?</p>
</div>
</div>
</div>
</div>
<h1 id="_lab_3_adding_persistent_volumes" class="sect0"><a class="anchor" href="#_lab_3_adding_persistent_volumes"></a>Lab 3 - Adding persistent volumes</h1>
<div class="paragraph">
<p>This lab will give you an overview about adding a persistence layer to any application that may require it, for instance, a Database.</p>
</div>
<div class="paragraph">
<p>In last lab, we have deployed an ephemeral Database, that means, in case the <code>pod</code> is recreated, any data previously stored will be lost.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s fix this!!</p>
</div>
<div class="sect1">
<h2 id="_understanding_storage"><a class="anchor" href="#_understanding_storage"></a>1. Understanding storage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I would like you to spend some time to read the Openshift official documentation about storage and understand the main concepts around it: <a href="https://docs.openshift.com/container-platform/4.6/storage/understanding-persistent-storage.html">Understanding persistent storage</a>.</p>
</div>
<div class="paragraph">
<p>Or in case you just want the basics for the lab, just read the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.6/storage/understanding-persistent-storage.html#persistent-volumes_understanding-persistent-storage">PersistentVolume</a></p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.6/storage/understanding-persistent-storage.html#persistent-volumes_understanding-persistent-storage">PersistentVolumeClaim</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_persistent_storage_to_the_database"><a class="anchor" href="#_setting_persistent_storage_to_the_database"></a>2. Setting persistent storage to the Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s now add persistent storage to the Postgresql Database we have deployed so we do not miss data in case our Database <code>pod</code> crashes or is recreated.</p>
</div>
<div class="paragraph">
<p>First, we will scale down to 0. You can use the <code>web console</code> or the <code>oc</code>. Here is the command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc scale dc/petclinic-database --replicas=0 -n &lt;YOUR_PROJECT&gt;


deploymentconfig.apps.openshift.io/petclinic-database scaled</pre>
</div>
</div>
<div class="paragraph">
<p>Now, edit the <code>petclinic-database</code> <code>DeploymentConfig</code> to remove any <code>volume</code> and <code>volumeMount</code> reference to avoid conflicts when adding new storage. Before removing, keep save somewhere the path related to the volume mount. You can manually edit the <code>DeploymentConfig</code>  from the <code>web console</code> or by running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> oc edit dc/petclinic-database  -n &lt;YOUR_PROJECT&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Remove <code>emptyDir</code> volume:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="emptydir.png" alt="Empty dir"></span></p>
</div>
<div class="paragraph">
<p>Remove volume mount:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="vol-mount.png" alt="Volume mount"></span></p>
</div>
<div class="paragraph">
<p>Let&#8217;s add storage now. Move to the <code>Developer</code> view and click on the Database application and then, <code>Add storage</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="add-storage.png" alt="Add storage"></span></p>
</div>
<div class="paragraph">
<p>Chose <code>Create new claim</code> and set the values according to next picture:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="add-storage-detail.png" alt="Add storage"></span></p>
</div>
<div class="paragraph">
<p>Scale the Database <code>DeploymentConfig</code> back to one replica:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc scale dc/petclinic-database --replicas=1 -n &lt;YOUR_PROJECT&gt;


deploymentconfig.apps.openshift.io/petclinic-database scaled</pre>
</div>
</div>
<div class="paragraph">
<p>Do some extra checks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Have a look at the new <code>DeploymentConfig</code> volume and volumeMount section</p>
</li>
<li>
<p>Navigate to the <code>web console</code> and <code>storage</code> menu and verify that the <code>pvc</code> appears as bound</p>
</li>
<li>
<p>And try to get details about the <code>pv</code> (No, you won&#8217;t get those details as your are not cluster administrator)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And also, test the application again. You will notice that we will get errors.. because the tables, relationships and data does not exist any more&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>In order recreate our scheme, let&#8217;s scale down the application to 0 and then back to 1 (this is because the application will create the tables and relationships again based on its hibernate configuration):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc scale deployment/quarkus-petclinic --replicas=0 -n &lt;YOUR_PROJECT&gt;

deployment.apps/quarkus-petclinic scaled</pre>
</div>
</div>
<div class="paragraph">
<p>And once there is no <code>pods</code> for the application, scale it up again:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc scale deployment/quarkus-petclinic --replicas=1 -n &lt;YOUR_PROJECT&gt;

deployment.apps/quarkus-petclinic scaled</pre>
</div>
</div>
<div class="paragraph">
<p>And test the application&#8230;&#8203; and list the owners. You should get a list of pre-created veterinarians :-)</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="list-vets.png" alt="List vets"></span></p>
</div>
<div class="paragraph">
<p>From now on.. you will not lose your data anymore as it is backed by a <code>PersistentVolume</code>.</p>
</div>
</div>
</div>
<h1 id="_lab_4_configuration_management" class="sect0"><a class="anchor" href="#_lab_4_configuration_management"></a>Lab 4 - Configuration management</h1>
<div class="paragraph">
<p>In this lab, we will introduce the concepts of <code>ConfigMap</code> and <code>Secrets</code> and we will give some examples of how they can be used/consumed from any application.</p>
</div>
<div class="sect1">
<h2 id="_short_introduction"><a class="anchor" href="#_short_introduction"></a>1. Short introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before continue to the labs, I highly encourage you to read the following (brief) documentation about:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kubernetes.io/docs/concepts/configuration/configmap/">ConfigMaps</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secrets</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configmaps"><a class="anchor" href="#_configmaps"></a>2. ConfigMaps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a summary of what you have read in the k8s documentation, we will use a <code>ConfigMap</code> to separate the configuration from the container image. This approach will give us the possibility of running the same image in different environments and inject completely different configuration values per environment.</p>
</div>
<div class="paragraph">
<p>In the next example I will use the the <code>Terms and conditions</code> tab in our "Pet clinic" web site to externalize the content of this legal text.</p>
</div>
<div class="paragraph">
<p>Before we start, let&#8217;s update the image that is used during this lab:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc set image deployment/quarkus-petclinic *=quay.io/dsanchor/quarkus-petclinic:config  -n &lt;YOUR_PROJECT&gt;

deployment.apps/quarkus-petclinic image updated</pre>
</div>
</div>
<div class="paragraph">
<p>I would also suggest to scale the application down to 1 replicas for debugging simplicity during the lab.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc scale deployment/quarkus-petclinic --replicas=1 -n &lt;YOUR_PROJECT&gt;

deployment.apps/quarkus-petclinic scaled</pre>
</div>
</div>
<div class="paragraph">
<p>Back to the topic, the main difference with the other application versions is that, this version, will try to read from a <em>/deployments/tcs.txt</em> (as per defined in <a href="https://github.com/dsanchor/petclinic/blob/mnl-config/quarkus-petclinic/src/main/resources/application.properties">application configration</a>) to load the content of the <code>Terms and conditions</code> text.</p>
</div>
<div class="paragraph">
<p>If you click now on the "T&amp;Cs" tab, you will get a message like this one:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="tcs.png" alt="terms and conditions"></span></p>
</div>
<div class="paragraph">
<p>If you also check the <code>pod</code> logs, every time you click on "T&amp;CS" tab, there will be a WARN log message:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>WARN: no such file. Setting default T&amp;Cs message</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
you can also see the logs of your pod by running: oc get logs -f &lt;POD&gt; -n &lt;YOUR_PROJECT&gt;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s create our <code>ConfigMap</code> now:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> oc create cm terms-and-conditions --from-literal=tcs.txt="My new tcs" -n &lt;YOUR_PROJECT&gt;

 configmap/terms-and-conditions created</pre>
</div>
</div>
<div class="paragraph">
<p>You can also check the content from the <code>web console</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="configmap-tcs.png" alt="tcs configmap"></span></p>
</div>
<div class="paragraph">
<p>And now, let&#8217;s mount this <code>ConfigMap</code> as volume in our <code>pods</code> by adding some configuration in the application <code>Deployment</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc set volume deployment/quarkus-petclinic --add --name=tcs -m /deployment -t configmap --configmap-name=terms-and-conditions -n &lt;YOUR_PROJECT&gt;

deployment.apps/quarkus-petclinic volume update</pre>
</div>
</div>
<div class="paragraph">
<p>What this command has added in our <code>Deployment</code> is:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="volume-mount-deployment.png" alt="volume mount deployment"></span></p>
</div>
<div class="paragraph">
<p>If we now click on the "T&amp;CS" tab, the content should be exactly the same of the one set in the <code>ConfigMap</code> and the WARN should have dissapeared from the <code>pod</code> logs:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="new-tcs.png" alt="new tcs"></span></p>
</div>
<div class="paragraph">
<p>What would happen if you modify the content of the <code>ConfigMap</code>? Are the 'T&amp;CS' updated as well?</p>
</div>
<div class="paragraph">
<p>Feel free to try it your self. You could edit the <code>ConfigMap</code> manually from the <code>web console</code> or by running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> oc edit cm terms-and-conditions -n &lt;YOUR_PROJECT&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>Secrets</code> and <code>ConfigMaps</code> could be mounted as volumes within <code>pods</code>.</p>
</div>
<div class="paragraph">
<p>Other approach that is valid in both cases is to consume the content of either <code>Secrets</code> or <code>ConfigMaps</code> as environment variables within <code>pods</code>.</p>
</div>
<div class="paragraph">
<p>We will see this last approach next with a <code>Secret</code> example.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secrets"><a class="anchor" href="#_secrets"></a>3. Secrets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compare to <code>ConfigMaps</code>, <code>Secrets</code> are used to store and manage sensitive data.</p>
</div>
<div class="paragraph">
<p>In this lab, we will just have a look at how the Postgresql application is using and consuming a given <code>Secret</code> that stores sensitive data such as the username, password and database name.</p>
</div>
<div class="paragraph">
<p>First of all, let&#8217;s have a look at the <code>petclinic-database</code> <code>Secret</code> using either the <code>web console</code> or the <code>cli</code>. I will use the <code>cli</code>, focusing only on the interesting part of the 'Secret'</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get secret petclinic-database -o yaml -n &lt;YOUR_PROJECT&gt;

apiVersion: v1
data:
  database-name: cGV0Y2xpbmlj
  database-password: bXlzZWNyZXRwYXNzd29yZA==
  database-user: cGV0Y2xpbmlj
kind: Secret
type: Opaque
metadata:
  name: petclinic-database</pre>
</div>
</div>
<div class="paragraph">
<p>Notice the main keys within the data part: database-name, database-password and database-user.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s move to the postgresql <code>DeploymentConfig</code> and see how these keys are then referenced from the environment variables.</p>
</div>
<div class="paragraph">
<p>If we check it using the <code>web console</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="dcs-env-vars.png" alt="dc env vars"></span></p>
</div>
<div class="paragraph">
<p>In the YAML descriptor, we can also clearly see how environments variables are set from the <code>Secret</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="yaml-env-vars.png" alt="yaml env vars"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extra_how_quarkus_could_manage_configuration"><a class="anchor" href="#_extra_how_quarkus_could_manage_configuration"></a>4. Extra: how Quarkus (could) manage configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once we have finished the whole lab, I would like to introduce you a different approach that is used by Quarkus in order to load/access <code>ConfigMaps</code> and <code>Secrets</code>.</p>
</div>
<div class="paragraph">
<p>As mentioned previously, some parts of the cofiguration has been profiled so that, we have different values for local development and production.</p>
</div>
<div class="paragraph">
<p>We would like to go a step further and show you how to make this application a Cloud Native one in terms of configuration.</p>
</div>
<div class="paragraph">
<p>Let me show it once we all have finished the lab.</p>
</div>
</div>
</div>
<h1 id="_lab_5_resources" class="sect0"><a class="anchor" href="#_lab_5_resources"></a>Lab 5 - Resources</h1>
<div class="paragraph">
<p>In next lab, we will introduce how to define resources in <code>pods</code> (memory and cpu), so that, the Kubernetes scheduler will use this information to place <code>pods</code> in the right nodes and also, to decide which <code>pods</code> are more likely to be evicted first based on its QoS (Quality of Service)</p>
</div>
<div class="sect1">
<h2 id="_requests_and_limits"><a class="anchor" href="#_requests_and_limits"></a>1. Requests and limits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next paragraphs have been extracted from the official <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits">Kubernetes documentation</a>. Summary is next.</p>
</div>
<div class="paragraph">
<p>When you specify the resource request for Containers in a Pod, the scheduler uses this information to decide which node to place the Pod on. When you specify a resource limit for a Container, the kubelet enforces those limits so that the running container is not allowed to use more of that resource than the limit you set. The kubelet also reserves at least the request amount of that system resource specifically for that container to use.</p>
</div>
<div class="paragraph">
<p>If the node where a Pod is running has enough of a resource available, it&#8217;s possible (and allowed) for a container to use more resource than its request for that resource specifies. However, a container is not allowed to use more than its resource limit.</p>
</div>
<div class="paragraph">
<p>For example, if you set a memory request of 256 MiB for a container, and that container is in a Pod scheduled to a Node with 8GiB of memory and no other Pods, then the container can try to use more RAM.</p>
</div>
<div class="paragraph">
<p>If you set a memory limit of 4GiB for that Container, the kubelet (and container runtime) enforce the limit. The runtime prevents the container from using more than the configured resource limit. For example: when a process in the container tries to consume more than the allowed amount of memory, the system kernel terminates the process that attempted the allocation, with an out of memory (OOM) error.</p>
</div>
<div class="paragraph">
<p>Limits can be implemented either reactively (the system intervenes once it sees a violation) or by enforcement (the system prevents the container from ever exceeding the limit). Different runtimes can have different ways to implement the same restrictions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quality_of_service"><a class="anchor" href="#_quality_of_service"></a>2. Quality of Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes provides different levels of Quality of Service to pods depending on what values for <code>request</code> and <code>limits</code> are set for them.</p>
</div>
<div class="paragraph">
<p>For each resource, containers specify a <code>request</code>, which is the amount of that resource that the system will guarantee to the container, and a <code>limit</code> which is the maximum amount that the system will allow the container to use.</p>
</div>
<div class="paragraph">
<p>Based on what values are in each case, we have the following <code>QoS</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="cncf-qos.png" alt="QoS"></span></p>
</div>
<div class="paragraph">
<p>As the table shows (source CNCF), the QoS class of a pod does affect the order in which it is chosen for eviction by the Kubelet.</p>
</div>
<div class="paragraph">
<p>Kubelet first evicts BestEffort and Burstable pods using resources above requests. The order of eviction depends on the priority assigned to each pod and the amount of resources being consumed above request.</p>
</div>
<div class="paragraph">
<p>Guaranteed and Burstable pods not exceeding resource requests are evicted next based on which ones have the lowest priority.</p>
</div>
<div class="paragraph">
<p>Both Guaranteed and Burstable pods whose resource usage is lower than the requested amount are never evicted because of the resource usage of another pod. They might, however, be evicted if system daemons start using more resources than reserved. In this case, Guaranteed and Burstable pods with the lowest priority are evicted first.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_resources"><a class="anchor" href="#_configure_resources"></a>3. Configure resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once we have understood the value of the different <code>QoS</code> and how resources could be configured, we will set two different kinds of 'QoS' as an example.</p>
</div>
<div class="paragraph">
<p>For the Postgresql Database, we will set <code>Guaranteed</code> resources, while we leave the application as <code>Burstable</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the DB. We will use the <code>oc</code> cli in both cases. We will set 512m and 10 milicores:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc set resources dc/petclinic-database --limits=cpu=10m,memory=512Mi --requests=cpu=10m,memory=512Mi -n &lt;TOUR PROJECT&gt;

deploymentconfig.apps.openshift.io/petclinic-database resource requirements updated</pre>
</div>
</div>
<div class="paragraph">
<p>And then, we will just define cpu and memory <code>request</code> in our application, so we let the application consume as much as the node can give to <code>pods</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc set resources deployment/quarkus-petclinic --requests=cpu=10m,memory=256Mi -n &lt;TOUR PROJECT&gt;

deployment.apps/quarkus-petclinic resource requirements updated</pre>
</div>
</div>
</div>
</div>
<h1 id="_lab_6_liveness_and_readiness_probes" class="sect0"><a class="anchor" href="#_lab_6_liveness_and_readiness_probes"></a>Lab 6 - Liveness and readiness probes</h1>
<div class="paragraph">
<p>In this lab, we will introduce the concept of application health checking by configuring both liveness and readiness probes.</p>
</div>
<div class="paragraph">
<p>A startup probe has been added recently, but we will not consider it in this lab.</p>
</div>
<div class="sect1">
<h2 id="_what_and_why"><a class="anchor" href="#_what_and_why"></a>1. What and why</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To answers these two questions, what are liveness/readiness probes? why are they needed? read the next article (10 minutes) that will give through different examples and scenarios the response to both questions: <a href="https://developers.redhat.com/blog/2020/11/10/you-probably-need-liveness-and-readiness-probes/" class="bare">https://developers.redhat.com/blog/2020/11/10/you-probably-need-liveness-and-readiness-probes/</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_liveness_and_readiness"><a class="anchor" href="#_configure_liveness_and_readiness"></a>2. Configure liveness and readiness</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_application_endpoints"><a class="anchor" href="#_application_endpoints"></a>2.1. Application endpoints</h3>
<div class="paragraph">
<p>Our application, which is based on Quarkus, provides a built-in health check endpoints when including <code>quarkus-smallrye-health</code> extension (for more detailes, see how it is done in our example application <a href="https://github.com/dsanchor/petclinic/blob/mnl-config/quarkus-petclinic/pom.xml#L73">here</a>).</p>
</div>
<div class="paragraph">
<p>Before configuring any probe, let&#8217;s try both health checks (liveness/readiness) endpoints manually to see the actual responses.</p>
</div>
<div class="paragraph">
<p>Since the  application is externally exposed, we can easily test them.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Liveness endpoint:</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="content">
<pre>curl -v http://&lt;APP_HOST_PORT&gt;/health/live

..
..
{
    "status": "UP",
    "checks": [
    ]
}
...
...</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Readiness endpoint:</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="content">
<pre>curl -v http://&lt;APP_HOST_PORT&gt;/health/ready

..
..
{
    "status": "UP",
    "checks": [
        {
            "name": "Database connections health check",
            "status": "UP"
        }
    ]
}
...
...</pre>
</div>
</div>
<div class="paragraph">
<p>As you could have noticed, there is an additional check added in the readiness probe response. That check comes from the Database connection, so in case there is a problem between the application and the Database, the readiness probe would fail and the pod will not receive traffic.</p>
</div>
<div class="paragraph">
<p>In our case, this is what we want: different liveness and readiness checks.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modify_current_deployment"><a class="anchor" href="#_modify_current_deployment"></a>2.2. Modify current deployment</h3>
<div class="paragraph">
<p>We will add both liveness and readiness probe to the existing deployment. To do so, we will use the <code>web console</code> and then examine the YAML descriptor.</p>
</div>
<div class="paragraph">
<p>Using the <code>Developer</code> view, click on the <code>quarkus-petclinic</code> application, and then <code>Add Health Check</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="add-hc.png" alt="add hc"></span></p>
</div>
<div class="paragraph">
<p>Then, configure both <code>liveness</code> and <code>readiness</code> probe.</p>
</div>
<div class="paragraph">
<p>Important:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>put the right <code>path</code> in the right <code>probe</code> :-)</p>
</li>
<li>
<p>add an <code>initial delay</code> that covers p99 startup time (check the container log trace "started in X.YYYs. Listening on: <a href="http://0.0.0.0:8080"" class="bare">http://0.0.0.0:8080"</a> to get a more accurate amount of time)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Save each probe individually and click on <code>Add</code>.</p>
</div>
<div class="paragraph">
<p>This change will force a new rolling update of our <code>pods</code>. New <code>pods</code> will now have both probes set.</p>
</div>
<div class="paragraph">
<p>The changes applied to the existing <code>Deployment</code> are highlighted next:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="yaml-hc.png" alt="yaml hc"></span></p>
</div>
<div class="paragraph">
<p>There should not be any issue and both probes should have passed successfully: application is healthy.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now force the <code>readiness probe</code> to fail. To do so, we will scale the Database down to zero replicas:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc scale dc/petclinic-database --replicas=0 -n &lt;YOUR_PROJECT&gt;

deploymentconfig.apps.openshift.io/petclinic-database scaled</pre>
</div>
</div>
<div class="paragraph">
<p>Once the Database pod is gone, check both <code>logs</code> and <code>events</code> in the application pod:</p>
</div>
<div class="paragraph">
<p><strong>Logs</strong>
<span class="image unresolved"><img src="logs-hc.png" alt="logs"></span></p>
</div>
<div class="paragraph">
<p><strong>Events</strong>
<span class="image unresolved"><img src="events-hc.png" alt="events"></span></p>
</div>
<div class="paragraph">
<p>Manually test the readiness probe to see the current response:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>curl -v http://&lt;APP_HOST_PORT&gt;/health/ready

..
..
{
    "status": "DOWN",
    "checks": [
        {
            "name": "Database connections health check",
            "status": "DOWN",
            "data": {
                "default": "Unable to execute the validation check for the default DataSource: This connection has been closed."
            }
        }

    ]
}
...
...</pre>
</div>
</div>
<div class="paragraph">
<p>Check the readiness of the application <code>pods</code> and see there is <code>0/1</code> containers ready:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc get pods -n &lt;YOUR_PROJECT&gt;
NAME                                 READY   STATUS      RESTARTS   AGE
petclinic-database-1-deploy          0/1     Completed   0          7h34m
quarkus-petclinic-79d56759f5-q8vwc   0/1     Running     0          18m</pre>
</div>
</div>
<div class="paragraph">
<p>And finally.. try to access to the application again&#8230;&#8203; :-(</p>
</div>
<div class="paragraph">
<p>In order to make the application back to <code>Ready</code>, scale up the Database to 1:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc scale dc/petclinic-database --replicas=1 -n &lt;YOUR_PROJECT&gt;

petclinic-database scaled</pre>
</div>
</div>
<div class="paragraph">
<p>Wait until the Database is back and try to access to the application again.</p>
</div>
<div class="paragraph">
<p>Everything should be back to normal.</p>
</div>
</div>
</div>
</div>
<h1 id="_lab_7_network_policies" class="sect0"><a class="anchor" href="#_lab_7_network_policies"></a>Lab 7 - Network Policies</h1>
<div class="paragraph">
<p>In this last lab, we will describe how we can restrict traffic to <code>pods</code> using <code>NetworkPolicy</code> objects.</p>
</div>
<div class="paragraph">
<p>This is mainly an administrator task, but I want you to understand certain concepts that are then usefull in combination with <code>Service Mesh</code>.</p>
</div>
<div class="paragraph">
<p>We will not dive too deep but hopefully enough to understand the main purpose of <code>NetworkPolicy</code>.</p>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, all <code>pods</code> in a <code>project</code> are accessible from other  <code>pods</code> and network endpoints. To isolate one or more  <code>pods</code> in a <code>project</code>, you can create <code>NetworkPolicy</code> objects in that project to indicate the allowed incoming.</p>
</div>
<div class="paragraph">
<p>From the <code>web console</code>, navigate to <code>Networking</code> menu and then, <code>Network policies</code>. You should get and empty list:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="empty-np.png" alt="Network policies"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_restrict_traffic_using_networkpolicy_objects"><a class="anchor" href="#_restrict_traffic_using_networkpolicy_objects"></a>2. Restrict traffic using NetworkPolicy objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will use an extra <code>project</code> so we can deploy a  single <code>pod</code> to test some scenarios from outside our regular <code>project</code>. Create a new project with <code>-external</code> suffix (so we all have one xxx-external extra project):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>oc new-project &lt;UP_TO_YOU&gt;-external</pre>
</div>
</div>
<div class="paragraph">
<p>Once the project is created, create a <code>pod</code> that will be used as client for our tests (we will reuse the first application we deployed):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab1/app-deployment.yaml -n &lt;YOUR_PROJECT&gt;-external

deployment.apps/quarkus-petclinic created</pre>
</div>
</div>
<div class="paragraph">
<p>Move to that <code>pod</code> and open the <code>terminal</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="new-pod.png" alt="new pod"></span></p>
</div>
<div class="paragraph">
<p>In that terminal, we will try to access to the <code>Petclinic</code> service that it is running in a different <code>project</code>. Execute the following, do not forget to use your target <code>namespace</code> (notice that we use now the svc FQDN instead &#8658; myservice.ns.svc):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ curl -v quarkus-petclinic.&lt;YOUR REGULAR PROJECT&gt;.svc:8080 | grep 200</pre>
</div>
</div>
<div class="paragraph">
<p>So far, there is not any restriction at all, so we could reach our application from any other <code>project</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create our first <code>NetworkPolicy</code> to isolate all <code>pods</code> in the <code>project</code> from other <code>pods</code> in different projects:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab7/np-same-project.yaml -n &lt;YOUR_PROJECT&gt;

networkpolicy.networking.k8s.io/allow-only-project created</pre>
</div>
</div>
<div class="paragraph">
<p>Run the same test from the <code>pod</code> that is running in your <code>xxxx-external</code> project. The traffic is now restricted and you cannot access that <code>pod</code> from outside the regular <code>project</code>. And that also means, you cannot access it from the <code>route</code> we have been using during the labs (I will explain it later if needed, but basically, there is a router <code>pod</code> running in a different <code>project</code> that acts as an <code>IngressController</code>).</p>
</div>
<div class="paragraph">
<p>Move to the <code>web console</code> and see all details about the <code>NetworkPolicy</code> you have just created in your project:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="np-same-project.png" alt="np same project"></span></p>
</div>
<div class="paragraph">
<p>We need to allow access from the router <code>pods</code>. Run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ oc apply -f $LABS_HOME/lab7/allow-openshift-ingress.yaml -n &lt;YOUR_PROJECT&gt;

networkpolicy.networking.k8s.io/allow-from-openshift-ingress created</pre>
</div>
</div>
<div class="paragraph">
<p>Test the application again from your browser&#8230;&#8203; it should be accessible now.</p>
</div>
<div class="paragraph">
<p>Also, have a look at the content of the <code>NetworkPolicy</code> you just created. The key part of it is the <code>namespaceSelector</code> that is based on certain labels which are present on the <code>openshift-ingress</code> <code>project</code>:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="np-ingress.png" alt="np ingress"></span></p>
</div>
<div class="paragraph">
<p>Just as an additional read, a regular requirement from customers is to move from the default behavior of "there is no traffic restriction between pods" to a concept of "multinenant configuration". In the following link, you could find how to achieve this goal: <a href="https://docs.openshift.com/container-platform/4.6/networking/network_policy/multitenant-network-policy.html" class="bare">https://docs.openshift.com/container-platform/4.6/networking/network_policy/multitenant-network-policy.html</a></p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
